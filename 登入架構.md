# 登入架構（前端）

## 概觀
- 前端技術：Vue 3 + Vite + TypeScript
- 狀態管理：Pinia（集中管理 Session）
- 路由保護：Vue Router 全域守衛（meta.requiresAuth）
- Cookie 策略：HttpOnly（前端不可讀），以 `/api/auth/session` 回應為準

## API 端點
- `GET /health`：健康檢查
- `POST /api/auth/login`：登入，成功後後端以 Set-Cookie 設置 `sgame_session`
- `GET /api/auth/session`：回傳目前登入態 `{ loggedIn, user }`
- `POST /api/auth/logout`：登出，清除 Cookie

## Pinia Session Store
檔案：`copy/vue/src/stores/session.ts`
- 狀態（state）：
  - `loggedIn: boolean`
  - `user: { id?, name?, email? } | null`
  - `lastFetched: number | null`（快照時間）
  - `inFlight: Promise<void> | null`（避免併發重複請求）
  - `ttlMs: number`（快取 TTL，預設 60 秒）
- 動作（actions）：
  - `fetchSession(force?: boolean)`：拉取 Session，套用 TTL 與 inFlight 抑制
  - `login({ email, password, rememberme })`：呼叫 `/api/auth/login`，成功後強制刷新快照
  - `logout()`：呼叫 `/api/auth/logout`，之後強制刷新快照
  - `refresh()`：清除 TTL 後重拉 Session

使用範例：
```ts
import { useSessionStore } from '@/stores/session';

const session = useSessionStore();
await session.login({ email, password, rememberme: 'yes' });
// session.loggedIn / session.user 即時可用
```

## 應用啟動初始化
檔案：`copy/vue/src/App.vue`
- 在 `onMounted` 呼叫 `session.fetchSession()`，讓全站有初始快照。

## 路由保護（需要登入）
檔案：`copy/vue/src/router/index.ts`
- 對需登入頁加 `meta: { requiresAuth: true }`
- 全域守衛 `beforeEach`：
  1. 若目標路由需登入，先 `await session.fetchSession()`（TTL 內不會重打）。
  2. 若未登入，導向 `/login?redirect=<原路徑>`。

範例：
```ts
{ path: '/member', component: MemberPage, meta: { requiresAuth: true } }
```

## 元件使用建議
- 一律「讀 store，不自行打 session API」：
  - `computed(() => session.loggedIn)`、`computed(() => session.user)`
- 頁面或操作前的保險檢查（可選）：
  - `await session.fetchSession()`（TTL 未過會被節流）

`AppHeader.vue` 已示範：
- 掛載時 `session.fetchSession()`；
- 顯示名稱取 `session.user?.name || session.user?.email`；
- 「登出」按鈕呼叫 `session.logout()`。

## 測試與除錯
- 測試頁：`/test-nav`（`copy/vue/src/pages/TestNavigationPage.vue`）
  - 提供 Login / Session / Logout 按鈕；
  - 走 Pinia store 動作，Header 能即時同步切換；
  - 顯示 `document.cookie` 僅作參考（HttpOnly 看不到值為正常）。
- 若回傳 HTML（index.html），多半是請求未到 API 而打到前端，檢查代理與路由。

## 安全與相容性注意
- HttpOnly Cookie 無法由前端讀取，請以 `/api/auth/session` 回應為準。
- 跨域需求：後端需設定 `Access-Control-Allow-Credentials: true`，且 `Access-Control-Allow-Origin` 不可為萬用星號；`SameSite=None; Secure` 需搭配 HTTPS。

## 待辦與擴充
- 依需求將其他會員相關頁補上 `meta.requiresAuth: true`。
- 若後端支援推播（SSE/WebSocket），可在單一入口監聽 session 事件：
  - onMessage → `session.refresh()` 或提供 `session.setLoggedOut()` 以即時同步被迫登出。



