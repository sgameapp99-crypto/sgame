<template>
  <div class="test-navigation">
    <div class="header">
      <h1>ğŸ§ª Vue è«–å£‡é …ç›®æ¸¬è©¦å°è¦½</h1>
      <p>é»æ“Šä¸‹æ–¹æŒ‰éˆ•å¿«é€Ÿé€²å…¥å„å€‹æ¸¬è©¦é é¢</p>
      
      <!-- é¡è‰²èªªæ˜ -->
      <div class="color-legend">
        <h3>ğŸ¨ é¡è‰²èªªæ˜</h3>
        <div class="legend-items">
          <div class="legend-item primary">
            <div class="legend-color"></div>
            <span>ä¸»è¦åŠŸèƒ½ - æ ¸å¿ƒæ¸¬è©¦é é¢</span>
          </div>
          <div class="legend-item normal">
            <div class="legend-color"></div>
            <span>ä¸€èˆ¬åŠŸèƒ½ - æ¨™æº–æ¸¬è©¦é é¢</span>
          </div>
          <div class="legend-item error">
            <div class="legend-color"></div>
            <span>éŒ¯èª¤æ¸¬è©¦ - 404é é¢æ¸¬è©¦</span>
          </div>
        </div>
      </div>
    </div>

    <div class="navigation-grid">
      <!-- ä¸»è¦åŠŸèƒ½æ¸¬è©¦ -->
      <div class="section">
        <h2>ğŸ¯ ä¸»è¦åŠŸèƒ½æ¸¬è©¦ <span class="color-badge primary">æ ¸å¿ƒé é¢</span></h2>
        <div class="button-group">
          <RouterLink to="/" class="nav-button primary">
            <div class="icon">ğŸ </div>
            <div class="content">
              <h3>é¦–é </h3>
              <p>åŸå§‹è«–å£‡UIå®Œæ•´è¤‡è£½</p>
              <span class="url">/</span>
            </div>
          </RouterLink>

          <RouterLink to="/forum-test" class="nav-button primary">
            <div class="icon">ğŸ§ª</div>
            <div class="content">
              <h3>è«–å£‡æ¸¬è©¦é </h3>
              <p>å°ˆé–€çš„æ¸¬è©¦é é¢</p>
              <span class="url">/forum-test</span>
            </div>
          </RouterLink>

          <RouterLink to="/forum" class="nav-button">
            <div class="icon">ğŸ’¬</div>
            <div class="content">
              <h3>è«–å£‡é é¢</h3>
              <p>è«–å£‡ä¸»é é¢</p>
              <span class="url">/forum</span>
            </div>
          </RouterLink>
        </div>
      </div>

      <!-- ç”¨æˆ¶ç›¸é—œæ¸¬è©¦ -->
      <div class="section">
        <h2>ğŸ‘¤ ç”¨æˆ¶ç›¸é—œæ¸¬è©¦ <span class="color-badge normal">æ¨™æº–é é¢</span></h2>
        <div class="button-group">
          <RouterLink to="/login" class="nav-button">
            <div class="icon">ğŸ”</div>
            <div class="content">
              <h3>ç™»å…¥é é¢</h3>
              <p>ç”¨æˆ¶ç™»å…¥åŠŸèƒ½</p>
              <span class="url">/login</span>
            </div>
          </RouterLink>

          <RouterLink to="/register" class="nav-button">
            <div class="icon">ğŸ“</div>
            <div class="content">
              <h3>è¨»å†Šé é¢</h3>
              <p>ç”¨æˆ¶è¨»å†ŠåŠŸèƒ½</p>
              <span class="url">/register</span>
            </div>
          </RouterLink>

          <RouterLink to="/member" class="nav-button">
            <div class="icon">ğŸ‘¨â€ğŸ’¼</div>
            <div class="content">
              <h3>æœƒå“¡é é¢</h3>
              <p>æœƒå“¡è³‡è¨Šé é¢</p>
              <span class="url">/member</span>
            </div>
          </RouterLink>

          <RouterLink :to="{ path: '/member', state: { memberId: 'test123' } }" class="nav-button">
            <div class="icon">ğŸ”</div>
            <div class="content">
              <h3>æŸ¥çœ‹ä»–äººæœƒå“¡é </h3>
              <p>éš±è— IDï¼ˆhistory.stateï¼‰å°è¦½</p>
              <span class="url">/member (with state)</span>
            </div>
          </RouterLink>

          <!-- å¯è¼¸å…¥ç›®æ¨™ ID çš„éš±è—å¼å°è¦½ -->
          <div class="nav-button" style="display:flex; align-items:center; gap:12px;">
            <div class="icon">ğŸ†”</div>
            <div class="content" style="flex:1;">
              <h3>è¼¸å…¥ç›®æ¨™ IDï¼ˆéš±è— ID å°è¦½ï¼‰</h3>
              <p>åœ¨ç¶²å€ä¸é¡¯ç¤º ID çš„æƒ…æ³ä¸‹ï¼Œå‰å¾€ä»–äººæœƒå“¡é </p>
              <div style="display:flex; gap:8px; align-items:center;">
                <input v-model="member.memberId" placeholder="ä¾‹å¦‚ï¼štest123" style="flex:1; border: 2px solid #e9ecef; border-radius: 8px; padding: 8px 10px; font-size: 0.95rem;" />
                <button class="action-btn" @click="navigateToMemberHidden" :disabled="!member.memberId">
                  <span class="icon">â¡ï¸</span>
                  å‰å¾€
                </button>
              </div>
              <span class="url">/member (with state)</span>
            </div>
          </div>
        </div>
      </div>

      <!-- æ–‡ç« ç›¸é—œæ¸¬è©¦ -->
      <div class="section">
        <h2>ğŸ“„ æ–‡ç« ç›¸é—œæ¸¬è©¦ <span class="color-badge normal">å‹•æ…‹è·¯ç”±</span></h2>
        <div class="button-group">
          <RouterLink to="/post/123" class="nav-button">
            <div class="icon">ğŸ“°</div>
            <div class="content">
              <h3>æ–‡ç« è©³æƒ…</h3>
              <p>å‹•æ…‹è·¯ç”±æ¸¬è©¦ (ID: 123)</p>
              <span class="url">/post/123</span>
            </div>
          </RouterLink>

          <RouterLink to="/post/456" class="nav-button">
            <div class="icon">ğŸ“°</div>
            <div class="content">
              <h3>æ–‡ç« è©³æƒ…</h3>
              <p>å‹•æ…‹è·¯ç”±æ¸¬è©¦ (ID: 456)</p>
              <span class="url">/post/456</span>
            </div>
          </RouterLink>
        </div>
      </div>

      <!-- é æ¸¬ç›¸é—œæ¸¬è©¦ -->
      <div class="section">
        <h2>ğŸ² é æ¸¬ç›¸é—œæ¸¬è©¦ <span class="color-badge normal">åŠŸèƒ½é é¢</span></h2>
        <div class="button-group">
          <RouterLink to="/predict" class="nav-button">
            <div class="icon">ğŸ”®</div>
            <div class="content">
              <h3>é æ¸¬é é¢</h3>
              <p>è³½äº‹é æ¸¬ä¸»é </p>
              <span class="url">/predict</span>
            </div>
          </RouterLink>

          <RouterLink to="/predict/buy" class="nav-button">
            <div class="icon">ğŸ’³</div>
            <div class="content">
              <h3>é æ¸¬è³¼è²·</h3>
              <p>é æ¸¬è³¼è²·é é¢</p>
              <span class="url">/predict/buy</span>
            </div>
          </RouterLink>
        </div>
      </div>

      <!-- éŠæˆ²ç›¸é—œæ¸¬è©¦ -->
      <div class="section">
        <h2>ğŸ® éŠæˆ²ç›¸é—œæ¸¬è©¦ <span class="color-badge normal">åŠŸèƒ½é é¢</span></h2>
        <div class="button-group">
          <RouterLink to="/games" class="nav-button">
            <div class="icon">ğŸ¯</div>
            <div class="content">
              <h3>éŠæˆ²é é¢</h3>
              <p>éŠæˆ²ä¸»é é¢</p>
              <span class="url">/games</span>
            </div>
          </RouterLink>

          <RouterLink to="/games/list" class="nav-button">
            <div class="icon">ğŸ“‹</div>
            <div class="content">
              <h3>éŠæˆ²åˆ—è¡¨</h3>
              <p>éŠæˆ²åˆ—è¡¨é é¢</p>
              <span class="url">/games/list</span>
            </div>
          </RouterLink>

          <RouterLink to="/games/detail/789" class="nav-button">
            <div class="icon">ğŸ²</div>
            <div class="content">
              <h3>éŠæˆ²è©³æƒ…</h3>
              <p>å‹•æ…‹è·¯ç”±æ¸¬è©¦ (ID: 789)</p>
              <span class="url">/games/detail/789</span>
            </div>
          </RouterLink>
        </div>
      </div>

      <!-- éŒ¯èª¤è™•ç†æ¸¬è©¦ -->
      <div class="section">
        <h2>âŒ éŒ¯èª¤è™•ç†æ¸¬è©¦ <span class="color-badge error">éŒ¯èª¤æ¸¬è©¦</span></h2>
        <div class="button-group">
          <RouterLink to="/nonexistent" class="nav-button error">
            <div class="icon">ğŸš«</div>
            <div class="content">
              <h3>404é é¢</h3>
              <p>æ¸¬è©¦ä¸å­˜åœ¨çš„è·¯ç”±</p>
              <span class="url">/nonexistent</span>
            </div>
          </RouterLink>
        </div>
      </div>
    </div>

    <!-- å¿«é€Ÿæ“ä½œå€åŸŸ -->
    <div class="quick-actions">
      <h2>âš¡ å¿«é€Ÿæ“ä½œ</h2>
      <div class="action-buttons">
        <button @click="openInNewTab('/')" class="action-btn">
          <span class="icon">ğŸ†•</span>
          æ–°åˆ†é é–‹å•Ÿé¦–é 
        </button>
        <button @click="openInNewTab('/forum-test')" class="action-btn">
          <span class="icon">ğŸ§ª</span>
          æ–°åˆ†é é–‹å•Ÿæ¸¬è©¦é 
        </button>
        <button @click="refreshPage" class="action-btn">
          <span class="icon">ğŸ”„</span>
          é‡æ–°æ•´ç†é é¢
        </button>
        <button @click="goBack" class="action-btn">
          <span class="icon">â¬…ï¸</span>
          è¿”å›ä¸Šä¸€é 
        </button>
      </div>
    </div>

    <!-- ç•¶å‰ç‹€æ…‹é¡¯ç¤º -->
    <div class="status-info">
      <h3>ğŸ“Š ç•¶å‰ç‹€æ…‹</h3>
      <div class="status-grid">
        <div class="status-item">
          <span class="label">ç•¶å‰è·¯ç”±:</span>
          <span class="value">{{ $route.path }}</span>
        </div>
        <div class="status-item">
          <span class="label">è·¯ç”±åç¨±:</span>
          <span class="value">{{ $route.name }}</span>
        </div>
        <div class="status-item">
          <span class="label">æŸ¥è©¢åƒæ•¸:</span>
          <span class="value">{{ JSON.stringify($route.query) }}</span>
        </div>
        <div class="status-item">
          <span class="label">è·¯ç”±åƒæ•¸:</span>
          <span class="value">{{ JSON.stringify($route.params) }}</span>
        </div>
      </div>
    </div>

    <!-- API æ¸¬è©¦å€åŸŸ -->
    <div class="api-test">
      <h2>ğŸ§° API æ¸¬è©¦ï¼ˆHealth/Authï¼‰</h2>
      <!-- ä½¿ç”¨å°ˆæ¡ˆæ—¢æœ‰ä»£ç†èˆ‡ /api å‰ç¶´ï¼Œç„¡éœ€é¡å¤– Base è¨­å®š -->
      <div class="api-grid">
        <div class="api-card">
          <h3>GET /health</h3>
          <button class="action-btn" @click="callHealth" :disabled="loading.health">
            <span class="icon">ğŸ©º</span>
            å‘¼å« Health
          </button>
          <pre class="result" v-text="results.health"></pre>
        </div>

        <div class="api-card">
          <h3>POST /auth/register</h3>
          <div class="field">
            <label>Email</label>
            <input v-model="form.email" type="email" placeholder="user+demo@example.com" />
          </div>
          <div class="field">
            <label>Password</label>
            <input v-model="form.password" type="password" placeholder="password123" />
          </div>
          <div class="field">
            <label>Name</label>
            <input v-model="form.name" type="text" placeholder="Demo" />
          </div>
          <button class="action-btn" @click="callRegister" :disabled="loading.register">
            <span class="icon">ğŸ†•</span>
            è¨»å†Šï¼ˆä¸¦è¨­å®š Cookieï¼‰
          </button>
          <pre class="result" v-text="results.register"></pre>
        </div>

        <div class="api-card">
          <h3>POST /auth/login</h3>
          <div class="field">
            <label>Email</label>
            <input v-model="form.email" type="email" placeholder="test@example.com" />
          </div>
          <div class="field">
            <label>Password</label>
            <input v-model="form.password" type="password" placeholder="password" />
          </div>
          <button class="action-btn" @click="callLogin" :disabled="loading.login">
            <span class="icon">ğŸ”</span>
            ç™»å…¥ï¼ˆè¨­å®š Cookieï¼‰
          </button>
          <pre class="result" v-text="results.login"></pre>
        </div>

        <div class="api-card">
          <h3>GET /auth/session</h3>
          <button class="action-btn" @click="callSession" :disabled="loading.session">
            <span class="icon">ğŸ§¾</span>
            å–å¾— Session
          </button>
          <pre class="result" v-text="results.session"></pre>
        </div>

        <div class="api-card">
          <h3>POST /auth/logout</h3>
          <button class="action-btn" @click="callLogout" :disabled="loading.logout">
            <span class="icon">ğŸšª</span>
            ç™»å‡ºï¼ˆæ¸…é™¤ Cookieï¼‰
          </button>
          <pre class="result" v-text="results.logout"></pre>
        </div>
      </div>

      <!-- æœƒå“¡ API æ¸¬è©¦ï¼ˆprofile / relationships / follow / unfollowï¼‰ -->
      <h2 style="margin-top:24px;">ğŸ‘¤ æœƒå“¡ API æ¸¬è©¦</h2>
      <div class="api-grid">
        <div class="api-card">
          <h3>ç›®æ¨™æœƒå“¡</h3>
          <div class="field">
            <label>Member ID</label>
            <input v-model="member.memberId" placeholder="ä¾‹å¦‚ï¼štest123 æˆ– test2" />
          </div>
          <div class="field">
            <label>å‚™è¨»</label>
            <div>æœªç™»å…¥å¯æ¸¬ relationshipsï¼ˆæœƒå› isFollowing=falseï¼‰</div>
          </div>
        </div>

        <div class="api-card">
          <h3>GET /members/{id}/profile</h3>
          <button class="action-btn" @click="callProfile" :disabled="loading.profile">
            <span class="icon">ğŸ§‘</span>
            å–å¾— Profile
          </button>
          <pre class="result" v-text="results.profile"></pre>
        </div>

        <div class="api-card">
          <h3>GET /members/{id}/relationships</h3>
          <button class="action-btn" @click="callRelationships" :disabled="loading.relationships">
            <span class="icon">ğŸ¤</span>
            å–å¾—é—œä¿‚
          </button>
          <pre class="result" v-text="results.relationships"></pre>
        </div>

        <div class="api-card">
          <h3>POST/DELETE /members/{id}/follow</h3>
          <div style="display:flex; gap:8px;">
            <button class="action-btn" @click="callFollow" :disabled="loading.follow">
              <span class="icon">â•</span>
              è¿½è¹¤ï¼ˆéœ€ç™»å…¥ï¼‰
            </button>
            <button class="action-btn" @click="callUnfollow" :disabled="loading.unfollow">
              <span class="icon">â–</span>
              å–æ¶ˆè¿½è¹¤ï¼ˆéœ€ç™»å…¥ï¼‰
            </button>
          </div>
          <pre class="result" v-text="results.follow"></pre>
          <pre class="result" v-text="results.unfollow"></pre>
        </div>
      </div>

      <!-- å¤§é ­è²¼ä¸Šå‚³æ¸¬è©¦ -->
      <h2 style="margin-top:24px;">ğŸ“¸ å¤§é ­è²¼ä¸Šå‚³æ¸¬è©¦</h2>
      <div class="api-grid">
        <div class="api-card">
          <h3>POST /me/avatar</h3>
          <div class="field">
            <label>é¸æ“‡åœ–ç‰‡æª”æ¡ˆ</label>
            <input 
              type="file" 
              ref="avatarFileInput"
              @change="onFileSelect"
              accept="image/jpeg,image/png,image/webp"
              style="padding: 8px; border: 2px solid #e9ecef; border-radius: 8px; width: 100%;"
            />
          </div>
          <div class="field" v-if="selectedFile">
            <label>æª”æ¡ˆè³‡è¨Š</label>
            <div style="font-size: 0.85rem; color: #666;">
              æª”å: {{ selectedFile.name }}<br>
              å¤§å°: {{ formatFileSize(selectedFile.size) }}<br>
              é¡å‹: {{ selectedFile.type }}
            </div>
          </div>
          <button class="action-btn" @click="callUploadAvatar" :disabled="loading.avatar || !selectedFile">
            <span class="icon">ğŸ“¤</span>
            ä¸Šå‚³å¤§é ­è²¼ï¼ˆéœ€ç™»å…¥ï¼‰
          </button>
          <pre class="result" v-text="results.avatar"></pre>
        </div>

        <div class="api-card" v-if="avatarPreview">
          <h3>é è¦½ä¸Šå‚³çµæœ</h3>
          <div style="text-align: center;">
            <img 
              :src="avatarPreview" 
              alt="å¤§é ­è²¼é è¦½" 
              style="max-width: 150px; max-height: 150px; border-radius: 50%; border: 3px solid #667eea;"
            />
            <div style="margin-top: 10px; font-size: 0.85rem; color: #666;">
              {{ avatarUrl }}
            </div>
          </div>
        </div>
      </div>

      <div class="cookie-panel">
        <div class="cookie-header">
          <h3>ğŸª ç€è¦½å™¨ Cookie</h3>
          <button class="action-btn" @click="refreshCookies">
            <span class="icon">ğŸ”„</span>
            åˆ·æ–° Cookie é¡¯ç¤º
          </button>
        </div>
        <pre class="result" v-text="cookies"></pre>
        <p class="cookie-hint">ç™»å‡ºæˆåŠŸæ™‚ï¼Œæ‡‰çœ‹ä¸åˆ° <code>sgame_session</code> æˆ–å…¶å€¼ç‚ºç©º/éæœŸã€‚</p>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { useRouter } from 'vue-router';
import { reactive, ref, onMounted } from 'vue';
import { useSessionStore } from '../stores/session';

const router = useRouter();

// åœ¨æ–°åˆ†é é–‹å•Ÿé é¢
function openInNewTab(path: string) {
  window.open(path, '_blank');
}

// é‡æ–°æ•´ç†é é¢
function refreshPage() {
  window.location.reload();
}

// è¿”å›ä¸Šä¸€é 
function goBack() {
  router.go(-1);
}

// ===== API æ¸¬è©¦ =====
const form = reactive({
  email: 'test@example.com',
  password: 'password',
  name: 'Demo'
});

const loading = reactive({ health: false, register: false, login: false, session: false, logout: false, profile: false, relationships: false, follow: false, unfollow: false, avatar: false });
const results = reactive<{ [k: string]: string }>({ health: '', register: '', login: '', session: '', logout: '', profile: '', relationships: '', follow: '', unfollow: '', avatar: '' });
const cookies = ref('');
const member = reactive({ memberId: 'test123' });

// å¤§é ­è²¼ä¸Šå‚³ç›¸é—œ
const avatarFileInput = ref<HTMLInputElement>();
const selectedFile = ref<File | null>(null);
const avatarPreview = ref<string>('');
const avatarUrl = ref<string>('');

function refreshCookies() {
  try {
    cookies.value = document.cookie || '(ç„¡ Cookie)';
  } catch {
    cookies.value = '(ç„¡æ³•è®€å– Cookie)';
  }
}

function buildUrl(path: string) { return path; }

async function request(path: string, init?: RequestInit) {
  try {
    const url = buildUrl(path);
    const res = await fetch(url, { credentials: 'include', headers: { Accept: 'application/json, text/plain;q=0.8, */*;q=0.5', ...(init?.headers || {}) }, ...init });
    const text = await res.text();
    const ct = res.headers.get('content-type') || '';
    if (/text\/html/i.test(ct)) {
      return { ok: res.ok, status: res.status, data: { warning: 'æ”¶åˆ° HTMLï¼Œå¯èƒ½æ˜¯ SPA index.htmlï¼Œè«‹ç¢ºèª API Base/ä»£ç†è¨­å®šã€‚', snippet: text.slice(0, 300) + (text.length > 300 ? 'â€¦' : '') }, raw: text };
    }
    try {
      const json = JSON.parse(text);
      return { ok: res.ok, status: res.status, data: json, raw: text };
    } catch {
      return { ok: res.ok, status: res.status, data: text, raw: text };
    }
  } catch (e: any) {
    return { ok: false, status: 0, data: { error: String(e) }, raw: String(e) };
  }
}

function pretty(label: string, r: { ok: boolean; status: number; data: any }) {
  return `${label} â†’ status: ${r.status}, ok: ${r.ok}\n${typeof r.data === 'string' ? r.data : JSON.stringify(r.data, null, 2)}`;
}

async function callHealth() {
  loading.health = true; results.health = 'è«‹æ±‚ä¸­...';
  const r = await request('/health');
  results.health = pretty('GET /health', r);
  refreshCookies();
  loading.health = false;
}

async function callLogin() {
  loading.login = true; results.login = 'è«‹æ±‚ä¸­...';
  try {
    const session = useSessionStore();
    const res = await session.login({ email: form.email, password: form.password, rememberme: 'yes' });
    results.login = `POST /api/auth/login â†’ status: ${res.status}, ok: ${res.ok}`;
    await session.fetchSession(true);
    results.session = `Session å¿«ç…§ â†’ ${JSON.stringify({ loggedIn: session.loggedIn, user: session.user }, null, 2)}`;
  } catch (e: any) {
    results.login = `POST /api/auth/login å¤±æ•—: ${String(e)}`;
  }
  refreshCookies();
  loading.login = false;
}

async function callRegister() {
  loading.register = true; results.register = 'è«‹æ±‚ä¸­...';
  try {
    const r = await request('/api/auth/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email: form.email, password: form.password, name: form.name })
    });
    results.register = pretty('POST /auth/register', r);
    try {
      const session = useSessionStore();
      await session.fetchSession(true);
      results.session = `Session å¿«ç…§ â†’ ${JSON.stringify({ loggedIn: session.loggedIn, user: session.user }, null, 2)}`;
    } catch {}
  } catch (e: any) {
    results.register = `POST /api/auth/register å¤±æ•—: ${String(e)}`;
  }
  refreshCookies();
  loading.register = false;
}

async function callSession() {
  loading.session = true; results.session = 'è«‹æ±‚ä¸­...';
  const r = await request('/api/auth/session');
  results.session = pretty('GET /auth/session', r);
  try {
    const session = useSessionStore();
    await session.fetchSession(true);
    results.session += `\nSession å¿«ç…§ â†’ ${JSON.stringify({ loggedIn: session.loggedIn, user: session.user }, null, 2)}`;
  } catch {}
  refreshCookies();
  loading.session = false;
}

async function callLogout() {
  loading.logout = true; results.logout = 'è«‹æ±‚ä¸­...';
  try {
    const session = useSessionStore();
    await session.logout();
    results.logout = 'POST /api/auth/logout â†’ ok';
    await session.fetchSession(true);
    results.session = `Session å¿«ç…§ â†’ ${JSON.stringify({ loggedIn: session.loggedIn, user: session.user }, null, 2)}`;
  } catch (e: any) {
    results.logout = `POST /api/auth/logout å¤±æ•—: ${String(e)}`;
  }
  refreshCookies();
  loading.logout = false;
}

onMounted(() => { refreshCookies(); });

// åŒæ­¥é¡¯ç¤ºç›®å‰ç™»å…¥ç‹€æ…‹ï¼ˆç¤ºæ„ï¼‰
const session = useSessionStore();
session.fetchSession().then(() => {
  results.session = `Session å¿«ç…§ â†’ ${JSON.stringify({ loggedIn: session.loggedIn, user: session.user }, null, 2)}`;
});

// ===== æœƒå“¡ API =====
async function callProfile() {
  loading.profile = true; results.profile = 'è«‹æ±‚ä¸­...';
  const id = encodeURIComponent(member.memberId || '');
  const r = await request(`/api/members/${id}/profile`);
  results.profile = pretty('GET /members/{id}/profile', r);
  loading.profile = false;
}

async function callRelationships() {
  loading.relationships = true; results.relationships = 'è«‹æ±‚ä¸­...';
  const id = encodeURIComponent(member.memberId || '');
  const r = await request(`/api/members/${id}/relationships`);
  results.relationships = pretty('GET /members/{id}/relationships', r);
  loading.relationships = false;
}

async function callFollow() {
  loading.follow = true; results.follow = 'è«‹æ±‚ä¸­...';
  const id = encodeURIComponent(member.memberId || '');
  const r = await request(`/api/members/${id}/follow`, { method: 'POST' });
  results.follow = pretty('POST /members/{id}/follow', r);
  // æ›´æ–° session é—œä¿‚å¿«ç…§
  try { const s = useSessionStore(); await s.fetchSession(true); } catch {}
  loading.follow = false;
}

async function callUnfollow() {
  loading.unfollow = true; results.unfollow = 'è«‹æ±‚ä¸­...';
  const id = encodeURIComponent(member.memberId || '');
  const r = await request(`/api/members/${id}/follow`, { method: 'DELETE' });
  results.unfollow = pretty('DELETE /members/{id}/follow', r);
  try { const s = useSessionStore(); await s.fetchSession(true); } catch {}
  loading.unfollow = false;
}

// å¤§é ­è²¼ä¸Šå‚³ç›¸é—œå‡½æ•¸
function onFileSelect(event: Event) {
  const target = event.target as HTMLInputElement;
  const file = target.files?.[0];
  
  if (file) {
    // æª¢æŸ¥æª”æ¡ˆé¡å‹
    const allowedTypes = ['image/jpeg', 'image/png', 'image/webp'];
    if (!allowedTypes.includes(file.type)) {
      alert('è«‹é¸æ“‡ JPEGã€PNG æˆ– WebP æ ¼å¼çš„åœ–ç‰‡');
      target.value = '';
      return;
    }
    
    // æª¢æŸ¥æª”æ¡ˆå¤§å° (5MB)
    const maxSize = 5 * 1024 * 1024;
    if (file.size > maxSize) {
      alert('æª”æ¡ˆå¤§å°ä¸èƒ½è¶…é 5MB');
      target.value = '';
      return;
    }
    
    selectedFile.value = file;
    
    // å»ºç«‹é è¦½
    const reader = new FileReader();
    reader.onload = (e) => {
      avatarPreview.value = e.target?.result as string;
    };
    reader.readAsDataURL(file);
  } else {
    selectedFile.value = null;
    avatarPreview.value = '';
  }
}

function formatFileSize(bytes: number): string {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

async function callUploadAvatar() {
  if (!selectedFile.value) {
    alert('è«‹å…ˆé¸æ“‡åœ–ç‰‡æª”æ¡ˆ');
    return;
  }
  
  loading.avatar = true;
  results.avatar = 'ä¸Šå‚³ä¸­...';
  
  try {
    const formData = new FormData();
    formData.append('file', selectedFile.value);
    
    const res = await request('/api/me/avatar', {
      method: 'POST',
      body: formData,
      headers: {
        // ä¸è¨­å®š Content-Typeï¼Œè®“ç€è¦½å™¨è‡ªå‹•è¨­å®š multipart/form-data
      }
    });
    
    results.avatar = pretty('POST /me/avatar', res);
    
    // å¦‚æœä¸Šå‚³æˆåŠŸï¼Œè§£æå›æ‡‰ä¸¦æ›´æ–°é è¦½
    if (res.ok) {
      try {
        const data = JSON.parse(res.raw);
        if (data.url) {
          avatarUrl.value = data.url;
          // åŠ ä¸Šæ™‚é–“æˆ³é¿å…å¿«å–
          const timestamp = new Date(data.updatedAt || Date.now()).getTime();
          avatarPreview.value = `${data.url}?v=${timestamp}`;
          
          // è§¸ç™¼å¤§é ­è²¼æ›´æ–°äº‹ä»¶ï¼Œé€šçŸ¥å…¶ä»–é é¢é‡æ–°è¼‰å…¥
          window.dispatchEvent(new CustomEvent('avatar-updated', { 
            detail: { url: data.url, updatedAt: data.updatedAt } 
          }));
        }
      } catch (e) {
        console.warn('è§£æä¸Šå‚³å›æ‡‰å¤±æ•—:', e);
      }
    }
  } catch (e) {
    results.avatar = `éŒ¯èª¤: ${e}`;
  } finally {
    loading.avatar = false;
  }
}

// ===== å°è¦½ï¼šéš±è— ID ç‰ˆæœ¬ =====
function navigateToMemberHidden() {
  const id = (member.memberId || '').trim();
  if (!id) return;
  router.push({ path: '/member', state: { memberId: id } });
}
</script>

<style scoped>
.test-navigation {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
  background: #f8f9fa;
  min-height: 100vh;
}

.header {
  text-align: center;
  margin-bottom: 40px;
  padding: 30px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border-radius: 15px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}

.header h1 {
  font-size: 2.5rem;
  margin: 0 0 10px 0;
  font-weight: 700;
}

.header p {
  font-size: 1.2rem;
  margin: 0 0 20px 0;
  opacity: 0.9;
}

.color-legend {
  background: rgba(255,255,255,0.15);
  padding: 20px;
  border-radius: 10px;
  margin-top: 20px;
  backdrop-filter: blur(10px);
}

.color-legend h3 {
  margin: 0 0 15px 0;
  font-size: 1.1rem;
  color: white;
  text-align: center;
}

.legend-items {
  display: flex;
  justify-content: center;
  gap: 30px;
  flex-wrap: wrap;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 8px;
  color: white;
  font-size: 0.9rem;
  font-weight: 500;
}

.legend-color {
  width: 20px;
  height: 20px;
  border-radius: 4px;
  border: 2px solid rgba(255,255,255,0.3);
}

.legend-item.primary .legend-color {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.legend-item.normal .legend-color {
  background: white;
}

.legend-item.error .legend-color {
  background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
}

.navigation-grid {
  display: grid;
  gap: 30px;
  margin-bottom: 40px;
}

.section {
  background: white;
  padding: 25px;
  border-radius: 12px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.08);
}

.section h2 {
  margin: 0 0 20px 0;
  color: #333;
  font-size: 1.5rem;
  border-bottom: 3px solid #667eea;
  padding-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.color-badge {
  font-size: 0.8rem;
  padding: 4px 12px;
  border-radius: 20px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.color-badge.primary {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

.color-badge.normal {
  background: #f8f9fa;
  color: #6c757d;
  border: 1px solid #dee2e6;
}

.color-badge.error {
  background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
  color: white;
}

.button-group {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 15px;
}

.nav-button {
  display: flex;
  align-items: center;
  padding: 20px;
  background: white;
  border: 2px solid #e9ecef;
  border-radius: 10px;
  text-decoration: none;
  color: #333;
  transition: all 0.3s ease;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.nav-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.15);
  border-color: #667eea;
  text-decoration: none;
  color: #333;
}

.nav-button.primary {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border-color: #667eea;
}

.nav-button.primary:hover {
  background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
  color: white;
}

.nav-button.error {
  background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
  color: white;
  border-color: #ff6b6b;
}

.nav-button.error:hover {
  background: linear-gradient(135deg, #ff5252 0%, #e5501a 100%);
  color: white;
}

.nav-button .icon {
  font-size: 2rem;
  margin-right: 15px;
  min-width: 50px;
  text-align: center;
}

.nav-button .content h3 {
  margin: 0 0 5px 0;
  font-size: 1.2rem;
  font-weight: 600;
}

.nav-button .content p {
  margin: 0 0 8px 0;
  color: #666;
  font-size: 0.9rem;
}

.nav-button .content .url {
  font-family: 'Courier New', monospace;
  background: rgba(0,0,0,0.1);
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 0.8rem;
  color: #555;
}

.nav-button.primary .content .url,
.nav-button.error .content .url {
  background: rgba(255,255,255,0.2);
  color: rgba(255,255,255,0.9);
}

.quick-actions {
  background: white;
  padding: 25px;
  border-radius: 12px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.08);
  margin-bottom: 30px;
}

.quick-actions h2 {
  margin: 0 0 20px 0;
  color: #333;
  font-size: 1.5rem;
}

.action-buttons {
  display: flex;
  flex-wrap: wrap;
  gap: 15px;
}

.action-btn {
  display: flex;
  align-items: center;
  padding: 12px 20px;
  background: #f8f9fa;
  border: 2px solid #e9ecef;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 0.9rem;
  font-weight: 500;
}

.action-btn:hover {
  background: #667eea;
  color: white;
  border-color: #667eea;
  transform: translateY(-1px);
}

.action-btn .icon {
  margin-right: 8px;
  font-size: 1.1rem;
}

.status-info {
  background: white;
  padding: 25px;
  border-radius: 12px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.08);
}

.status-info h3 {
  margin: 0 0 20px 0;
  color: #333;
  font-size: 1.5rem;
}

.status-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 15px;
}

.status-item {
  display: flex;
  flex-direction: column;
  padding: 15px;
  background: #f8f9fa;
  border-radius: 8px;
  border-left: 4px solid #667eea;
}

.status-item .label {
  font-weight: 600;
  color: #666;
  font-size: 0.9rem;
  margin-bottom: 5px;
}

.status-item .value {
  font-family: 'Courier New', monospace;
  color: #333;
  font-size: 0.9rem;
  word-break: break-all;
}

/* API æ¸¬è©¦ */
.api-test {
  background: white;
  padding: 25px;
  border-radius: 12px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.08);
  margin-top: 30px;
}

.api-test h2 {
  margin: 0 0 20px 0;
  color: #333;
  font-size: 1.5rem;
}

.api-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap: 16px;
}

.api-base {
  display: flex;
  gap: 10px;
  align-items: center;
  margin-bottom: 14px;
}

.api-base input {
  flex: 1;
  border: 2px solid #e9ecef;
  border-radius: 8px;
  padding: 8px 10px;
  font-size: 0.95rem;
}

.api-card {
  border: 2px solid #e9ecef;
  border-radius: 10px;
  padding: 16px;
  background: #f8f9fa;
}

.api-card h3 {
  margin: 0 0 10px 0;
}

.field {
  display: flex;
  flex-direction: column;
  margin-bottom: 10px;
}

.field label {
  font-size: 0.85rem;
  color: #555;
  margin-bottom: 4px;
}

.field input {
  border: 2px solid #e9ecef;
  border-radius: 8px;
  padding: 8px 10px;
  font-size: 0.95rem;
}

.result {
  background: #fff;
  border: 1px dashed #ced4da;
  padding: 10px;
  border-radius: 8px;
  margin-top: 10px;
  max-height: 220px;
  overflow: auto;
  white-space: pre-wrap;
}

.cookie-panel {
  margin-top: 20px;
  border-top: 1px solid #e9ecef;
  padding-top: 16px;
}

.cookie-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 8px;
}

.cookie-hint {
  margin-top: 6px;
  color: #666;
  font-size: 0.85rem;
}

/* éŸ¿æ‡‰å¼è¨­è¨ˆ */
@media (max-width: 768px) {
  .test-navigation {
    padding: 15px;
  }
  
  .header h1 {
    font-size: 2rem;
  }
  
  .legend-items {
    flex-direction: column;
    gap: 15px;
  }
  
  .section h2 {
    flex-direction: column;
    align-items: flex-start;
    gap: 5px;
  }
  
  .button-group {
    grid-template-columns: 1fr;
  }
  
  .action-buttons {
    flex-direction: column;
  }
  
  .status-grid {
    grid-template-columns: 1fr;
  }
}
</style>
