# 預測數據顯示問題診斷

**問題描述**: 後端確認有預測數據，但前端會員頁面沒有顯示。

**日期**: 2025-10-22

---

## 📊 後端確認的數據

根據後端回覆：

```
✅ 資料庫中確實有前端提交的預測資料！

主要活躍用戶：
- forever306936@gmail.com (Test) - 提交了 10 筆預測

主要針對兩場測試賽事：
- 洛杉磯道奇 vs 舊金山巨人（MLB，2025-10-25）
- 洛杉磯湖人 vs 金州勇士（NBA，2025-10-24）
```

---

## 🔍 診斷步驟

### 第一步：刷新頁面並查看完整日誌

1. **硬刷新頁面**（Ctrl+F5 或 Cmd+Shift+R）
2. **打開開發者工具** → Console 標籤
3. **查看以下日誌**：

#### 應該看到的完整日誌序列：

```
🚀 loadPredictions 函數開始執行
🔑 獲取到的 userId: 27
🔑 route.params.id: undefined
🔑 session.profile?.id: 27
🔍 載入會員預測 - 請求參數: { memberId: 27, page: 1, size: 20, startDate: "2025-10-22", endDate: undefined }
🔍 當前日期範圍選擇: all
🔍 路由參數 ID: undefined
🔍 Session Profile ID: 27
✅ 預測 API 回應: { success: true, dataCount: 10, total: 10, firstPrediction: {...} }
📦 設置的 predictions 數據: [Array(10)]
📦 predictions 數量: 10
📦 第一筆預測的完整結構: { ... }
📦 第一筆預測的關鍵字段:
   - id: 123
   - gameId: "20251024TEST007"
   - gameInfo: { allianceId: 2, allianceName: "NBA", ... }
   - predictionType: "international_spread"
   - status: "pending"
```

### 第二步：確認關鍵信息

從日誌中確認以下信息：

#### ✅ 檢查項 1：userId

```
🔑 獲取到的 userId: ???
```

**預期**：應該是登入用戶的 ID（例如 27）
**如果是 undefined**：說明 session 沒有正確設置，需要檢查登入狀態

#### ✅ 檢查項 2：API 請求參數

```
🔍 載入會員預測 - 請求參數: { memberId: ???, startDate: ???, ... }
```

**預期**：
- `memberId`: 應該是數字或字串
- `startDate`: 應該是今天的日期（2025-10-22）
- `endDate`: 選擇「全部」時應該是 `undefined`

#### ✅ 檢查項 3：API 回應

```
✅ 預測 API 回應: { success: ???, dataCount: ???, total: ??? }
```

**預期**：
- `success: true`
- `dataCount: 10`（根據後端確認）
- `total: 10`

**如果 dataCount 為 0**：
- 檢查 Network 標籤中的實際 API 回應
- 確認後端返回的數據結構

#### ✅ 檢查項 4：數據結構

```
📦 第一筆預測的完整結構: { ... }
```

複製這個 JSON 並檢查字段名稱是否與模板期望的一致。

---

## 🐛 常見問題

### 問題 1：userId 為 undefined

**症狀**：
```
🔑 獲取到的 userId: undefined
❌ userId 為空，提前返回
```

**原因**：session.profile 未正確載入

**解決方案**：
1. 檢查是否已登入
2. 檢查 Console 中是否有 session 相關錯誤
3. 嘗試重新登入

### 問題 2：API 回應成功但 dataCount 為 0

**症狀**：
```
✅ 預測 API 回應: { success: true, dataCount: 0, total: 0 }
⚠️ 沒有預測數據
```

**可能原因**：

#### 原因 A：memberId 不匹配
```javascript
// 檢查登入的用戶 email
console.log('當前登入用戶:', session.user?.email);

// 確認是否是 forever306936@gmail.com (Test)
```

#### 原因 B：日期範圍不匹配
```
後端數據的賽事日期：2025-10-24, 2025-10-25
前端請求的 startDate：2025-10-22
前端請求的 endDate：undefined (全部)

理論上應該匹配！
```

**檢查 Network 標籤**：
1. 找到 `GET /api/predictions` 請求
2. 查看 **Request URL** 和 **Query String Parameters**
3. 查看 **Response** 內容

#### 原因 C：後端參數名稱不匹配

前端使用 `memberId`，但後端可能期望其他參數名（例如 `userId`）。

**臨時測試**：
在 MemberPage.vue 的 loadPredictions 函數中，暫時添加兩個參數：

```typescript
const result = await predictionsAPI.getPredictions({
  memberId: userId,
  userId: userId,  // 同時傳入 userId
  page: currentPage.value,
  size: pageSize.value,
  startDate: startDate,
  endDate: endDate,
});
```

### 問題 3：有數據但頁面沒有顯示

**症狀**：
```
📦 predictions 數量: 10
```

但頁面上顯示「無預測」。

**原因**：模板字段名稱與數據結構不匹配。

**檢查模板期望的字段**：

MemberPage.vue 模板使用以下字段：
- `prediction.gameMode` - 用於區分國際盤/運彩盤
- `prediction.date` - 賽事日期
- `prediction.homeTeam` - 主隊
- `prediction.awayTeam` - 客隊
- `prediction.title` - 預測標題
- `prediction.type` - 預測類型
- `prediction.result` - 預測結果

**但 API 返回的結構是**：
- `prediction.gameInfo.gameDate` （不是 `date`）
- `prediction.gameInfo.homeTeam`
- `prediction.gameInfo.awayTeam`
- `prediction.predictionType` （不是 `type`）
- `prediction.status` （不是 `result`）
- **沒有 `gameMode` 字段**
- **沒有 `title` 字段**

**解決方案**：需要修改模板或在 API 層面轉換數據結構。

---

## 🔧 快速測試

### 測試 1：檢查 filteredPredictions

在 Console 中執行（需要在 Vue DevTools 或通過代理訪問）：

```javascript
// 在 Vue DevTools 中找到 MemberPage 組件
// 查看 predictions 和 filteredPredictions 的值
```

### 測試 2：手動檢查 Network

1. 打開 **Network** 標籤
2. 刷新頁面
3. 找到 `GET /api/predictions` 請求
4. 查看 **Response**：

```json
{
  "success": true,
  "data": [
    {
      "id": 123,
      "userId": 27,
      "gameId": "20251024TEST007",
      "gameInfo": {
        "allianceId": 2,
        "allianceName": "NBA",
        "gameDate": "2025-10-24",
        "homeTeam": "洛杉磯湖人",
        "awayTeam": "金州勇士"
      },
      "predictionType": "international_spread",
      "status": "pending",
      ...
    }
  ],
  "pagination": {
    "page": 1,
    "size": 20,
    "total": 10
  }
}
```

### 測試 3：檢查 filteredPredictions 計算屬性

查看 Console 中是否有過濾相關的錯誤：

```
// 如果 filteredPredictions 過濾邏輯有問題
// 可能會在 Console 看到 JavaScript 錯誤
```

---

## 📋 需要提供的信息

如果以上步驟無法解決問題，請提供以下完整信息：

### 1. Console 日誌（完整）

從 `🚀 loadPredictions 函數開始執行` 開始，到所有 📦 日誌結束。

### 2. Network 請求詳情

```
Request URL: GET /api/predictions?...
Query String Parameters:
  memberId: ???
  page: ???
  size: ???
  startDate: ???
  endDate: ???

Response:
{
  "success": ???,
  "data": [...],
  ...
}
```

### 3. 當前登入用戶信息

```javascript
// 在 Console 執行
console.log('Session:', {
  loggedIn: session.loggedIn,
  userId: session.userId,
  user: session.user,
  profile: session.profile
});
```

### 4. Vue DevTools 組件狀態

- `predictions` 陣列的內容
- `filteredPredictions` 的值
- `selectedAlliance` 的值
- `selectedDateRange` 的值

---

## 💡 可能的解決方案

### 方案 A：修改模板以匹配 API 數據結構

將模板中的字段名稱改為與 API 返回的一致（推薦）。

### 方案 B：在 API 層面轉換數據

在 `predictionsAPI.getPredictions` 中添加數據轉換邏輯。

### 方案 C：創建 UserPrediction 類型

創建一個新的類型，包含模板需要的所有字段，並在載入數據後進行轉換。

---

## 🎯 下一步行動

1. **刷新頁面**並複製完整的 Console 日誌
2. **檢查 Network 標籤**中的 API 回應
3. **將以上信息提供給我**，我會精確定位問題並提供解決方案

---

**診斷完成後，我們將根據具體情況修復模板或數據結構！** 🚀

