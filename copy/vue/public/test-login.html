<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGame API 完整測試頁面</title>
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", Arial, sans-serif;
            padding: 20px;
            background: #f5f7fa;
            margin: 0;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 10px;
        }
        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .test-section h2 {
            margin: 0 0 15px 0;
            color: #34495e;
            font-size: 18px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
        }
        .category-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 8px;
        }
        .badge-auth { background: #3498db; color: white; }
        .badge-member { background: #9b59b6; color: white; }
        .badge-system { background: #2ecc71; color: white; }
        .input-group {
            margin-bottom: 12px;
        }
        .input-group label {
            display: block;
            margin-bottom: 4px;
            color: #555;
            font-size: 13px;
            font-weight: 500;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3498db;
        }
        .button-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        button {
            padding: 10px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }
        button:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .btn-primary { background: #3498db; color: white; }
        .btn-success { background: #2ecc71; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-secondary { background: #95a5a6; color: white; }
        .result-box {
            margin-top: 12px;
            padding: 12px;
            border-radius: 4px;
            font-size: 13px;
            line-height: 1.5;
            max-height: 300px;
            overflow-y: auto;
        }
        .result-box pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .result-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .result-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .result-info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .result-pending {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }
        .status-success { background: #2ecc71; }
        .status-error { background: #e74c3c; }
        .status-pending { background: #f39c12; }
        .file-upload {
            border: 2px dashed #ddd;
            padding: 20px;
            text-align: center;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .file-upload:hover {
            border-color: #3498db;
            background: #f8f9fa;
        }
        .file-upload input[type="file"] {
            display: none;
        }
        .quick-guide {
            background: #fff;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .quick-guide h3 {
            margin: 0 0 15px 0;
            color: #2c3e50;
        }
        .quick-guide ol {
            margin: 0;
            padding-left: 20px;
        }
        .quick-guide li {
            margin-bottom: 8px;
            color: #555;
        }
        .stats-bar {
            display: flex;
            gap: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .stat-item {
            flex: 1;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }
        .stat-label {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎮 SGame API 完整測試頁面</h1>
        <p class="subtitle">測試所有 21 個 API 端點 | 後端: https://10.2.0.2:8080</p>

        <!-- 快速測試指南 -->
        <div class="quick-guide">
            <h3>📋 測試流程建議</h3>
            <ol>
                <li><strong>基礎連接</strong>: 先測試「健康檢查」確認後端連接正常</li>
                <li><strong>註冊帳號</strong>: 使用「註冊測試」創建新帳號 (需要真實Email接收驗證碼)</li>
                <li><strong>登入系統</strong>: 使用「登入測試」登入剛註冊的帳號</li>
                <li><strong>驗證郵箱</strong>: 發送驗證碼並完成驗證 (檢查Email收件匣)</li>
                <li><strong>會員功能</strong>: 測試會員資料、追蹤、等級等功能</li>
                <li><strong>其他功能</strong>: 測試密碼管理、頭像上傳等進階功能</li>
            </ol>
        </div>

        <!-- 統計資訊 -->
        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-value" id="stat-total">21</div>
                <div class="stat-label">總API數</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="stat-tested">0</div>
                <div class="stat-label">已測試</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="stat-success">0</div>
                <div class="stat-label">成功</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="stat-failed">0</div>
                <div class="stat-label">失敗</div>
            </div>
        </div>

        <!-- 測試區域 -->
        <div class="test-grid">
            <!-- 1. 系統健康檢查 -->
            <div class="test-section">
                <h2>
                    <span class="status-indicator" id="status-health"></span>
                    1. 健康檢查
                    <span class="category-badge badge-system">SYSTEM</span>
                </h2>
                <div class="button-group">
                    <button class="btn-primary" onclick="testHealth()">測試健康檢查</button>
                </div>
                <div id="health-result"></div>
            </div>

            <!-- 2. Session 狀態 -->
            <div class="test-section">
                <h2>
                    <span class="status-indicator" id="status-session"></span>
                    2. Session 狀態
                    <span class="category-badge badge-auth">AUTH</span>
                </h2>
                <div class="button-group">
                    <button class="btn-primary" onclick="testSession()">檢查 Session</button>
                </div>
                <div id="session-result"></div>
            </div>

            <!-- 3. 註冊 -->
            <div class="test-section">
                <h2>
                    <span class="status-indicator" id="status-register"></span>
                    3. 註冊帳號
                    <span class="category-badge badge-auth">AUTH</span>
                </h2>
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="register-email" placeholder="your@example.com">
                </div>
                <div class="input-group">
                    <label>密碼 (8-12碼,含大小寫+數字+特殊符號)</label>
                    <input type="password" id="register-password" placeholder="Abcd1234!">
                </div>
                <div class="input-group">
                    <label>名稱</label>
                    <input type="text" id="register-name" placeholder="測試用戶">
                </div>
                <div class="button-group">
                    <button class="btn-success" onclick="testRegister()">註冊</button>
                </div>
                <div id="register-result"></div>
            </div>

            <!-- 4. 登入 -->
            <div class="test-section">
                <h2>
                    <span class="status-indicator" id="status-login"></span>
                    4. 登入
                    <span class="category-badge badge-auth">AUTH</span>
                </h2>
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="email" placeholder="your@example.com">
                </div>
                <div class="input-group">
                    <label>密碼</label>
                    <input type="password" id="password" placeholder="密碼">
                </div>
                <div class="button-group">
                    <button class="btn-primary" onclick="testLogin()">登入</button>
                </div>
                <div id="login-result"></div>
            </div>

            <!-- 5. 郵箱驗證狀態 -->
            <div class="test-section">
                <h2>
                    <span class="status-indicator" id="status-verify-status"></span>
                    5. 郵箱驗證狀態
                    <span class="category-badge badge-auth">AUTH</span>
                </h2>
                <div class="button-group">
                    <button class="btn-primary" onclick="testVerificationStatus()">查詢驗證狀態</button>
                </div>
                <div id="verify-status-result"></div>
            </div>

            <!-- 6. 發送驗證碼 -->
            <div class="test-section">
                <h2>
                    <span class="status-indicator" id="status-send-verify"></span>
                    6. 發送驗證碼
                    <span class="category-badge badge-auth">AUTH</span>
                </h2>
                <p style="font-size: 13px; color: #666; margin-top: 0;">需要先登入,驗證碼將發送到登入的Email</p>
                <div class="button-group">
                    <button class="btn-warning" onclick="testSendVerification()">發送驗證碼</button>
                </div>
                <div id="send-verify-result"></div>
            </div>

            <!-- 7. 驗證郵箱 -->
            <div class="test-section">
                <h2>
                    <span class="status-indicator" id="status-verify-email"></span>
                    7. 驗證郵箱
                    <span class="category-badge badge-auth">AUTH</span>
                </h2>
                <div class="input-group">
                    <label>驗證碼 (6位數)</label>
                    <input type="text" id="verify-code" placeholder="123456" maxlength="6">
                </div>
                <div class="button-group">
                    <button class="btn-success" onclick="testVerifyEmail()">提交驗證</button>
                </div>
                <div id="verify-email-result"></div>
            </div>

            <!-- 8. 會員資料 -->
            <div class="test-section">
                <h2>
                    <span class="status-indicator" id="status-member"></span>
                    8. 會員資料
                    <span class="category-badge badge-member">MEMBER</span>
                </h2>
                <div class="input-group">
                    <label>會員ID</label>
                    <input type="text" id="member-id" placeholder="1">
                </div>
                <div class="button-group">
                    <button class="btn-primary" onclick="testMemberProfile()">查詢會員</button>
                </div>
                <div id="member-result"></div>
            </div>

            <!-- 9. 追蹤會員 -->
            <div class="test-section">
                <h2>
                    <span class="status-indicator" id="status-follow"></span>
                    9. 追蹤會員
                    <span class="category-badge badge-member">MEMBER</span>
                </h2>
                <div class="input-group">
                    <label>要追蹤的會員ID</label>
                    <input type="text" id="follow-member-id" placeholder="2">
                </div>
                <div class="button-group">
                    <button class="btn-success" onclick="testFollowMember()">追蹤</button>
                    <button class="btn-danger" onclick="testUnfollowMember()">取消追蹤</button>
                </div>
                <div id="follow-result"></div>
            </div>

            <!-- 10. 等級系統 -->
            <div class="test-section">
                <h2>
                    <span class="status-indicator" id="status-levels"></span>
                    10. 等級列表
                    <span class="category-badge badge-system">SYSTEM</span>
                </h2>
                <div class="button-group">
                    <button class="btn-primary" onclick="testLevels()">獲取等級</button>
                </div>
                <div id="levels-result"></div>
            </div>

            <!-- 11. 等級統計 -->
            <div class="test-section">
                <h2>
                    <span class="status-indicator" id="status-level-stats"></span>
                    11. 等級統計
                    <span class="category-badge badge-system">SYSTEM</span>
                </h2>
                <div class="button-group">
                    <button class="btn-primary" onclick="testLevelStats()">獲取統計</button>
                </div>
                <div id="level-stats-result"></div>
            </div>

            <!-- 12. 密碼過期狀態 -->
            <div class="test-section">
                <h2>
                    <span class="status-indicator" id="status-pwd-expiry"></span>
                    12. 密碼過期狀態
                    <span class="category-badge badge-auth">AUTH</span>
                </h2>
                <div class="button-group">
                    <button class="btn-primary" onclick="testPasswordExpiry()">查詢狀態</button>
                </div>
                <div id="pwd-expiry-result"></div>
            </div>

            <!-- 13. 修改密碼 -->
            <div class="test-section">
                <h2>
                    <span class="status-indicator" id="status-change-pwd"></span>
                    13. 修改密碼
                    <span class="category-badge badge-auth">AUTH</span>
                </h2>
                <div class="input-group">
                    <label>目前密碼</label>
                    <input type="password" id="current-password" placeholder="目前密碼">
                </div>
                <div class="input-group">
                    <label>新密碼</label>
                    <input type="password" id="new-password" placeholder="NewPass1234!">
                </div>
                <div class="button-group">
                    <button class="btn-warning" onclick="testChangePassword()">修改密碼</button>
                </div>
                <div id="change-pwd-result"></div>
            </div>

            <!-- 14. 忘記密碼 -->
            <div class="test-section">
                <h2>
                    <span class="status-indicator" id="status-forgot-pwd"></span>
                    14. 忘記密碼
                    <span class="category-badge badge-auth">AUTH</span>
                </h2>
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="forgot-email" placeholder="your@example.com">
                </div>
                <div class="button-group">
                    <button class="btn-warning" onclick="testForgotPassword()">發送重設郵件</button>
                </div>
                <div id="forgot-pwd-result"></div>
            </div>

            <!-- 15. 驗證重設Token -->
            <div class="test-section">
                <h2>
                    <span class="status-indicator" id="status-verify-token"></span>
                    15. 驗證重設Token
                    <span class="category-badge badge-auth">AUTH</span>
                </h2>
                <div class="input-group">
                    <label>重設Token (從郵件中取得)</label>
                    <input type="text" id="reset-token" placeholder="token-from-email">
                </div>
                <div class="button-group">
                    <button class="btn-primary" onclick="testVerifyResetToken()">驗證Token</button>
                </div>
                <div id="verify-token-result"></div>
            </div>

            <!-- 16. 重設密碼 -->
            <div class="test-section">
                <h2>
                    <span class="status-indicator" id="status-reset-pwd"></span>
                    16. 重設密碼
                    <span class="category-badge badge-auth">AUTH</span>
                </h2>
                <div class="input-group">
                    <label>重設Token</label>
                    <input type="text" id="reset-pwd-token" placeholder="token-from-email">
                </div>
                <div class="input-group">
                    <label>新密碼</label>
                    <input type="password" id="reset-new-password" placeholder="NewPass1234!">
                </div>
                <div class="button-group">
                    <button class="btn-success" onclick="testResetPassword()">重設密碼</button>
                </div>
                <div id="reset-pwd-result"></div>
            </div>

            <!-- 17. 頭像上傳 -->
            <div class="test-section">
                <h2>
                    <span class="status-indicator" id="status-avatar"></span>
                    17. 頭像上傳
                    <span class="category-badge badge-member">MEMBER</span>
                </h2>
                <div class="file-upload" onclick="document.getElementById('avatar-file').click()">
                    <input type="file" id="avatar-file" accept="image/jpeg,image/png,image/webp">
                    <p style="margin: 0; color: #666;">點擊選擇圖片 (最大5MB, JPEG/PNG/WebP)</p>
                    <p id="avatar-filename" style="margin: 8px 0 0 0; color: #3498db; font-size: 13px;"></p>
                </div>
                <div class="button-group" style="margin-top: 12px;">
                    <button class="btn-success" onclick="testUploadAvatar()">上傳頭像</button>
                </div>
                <div id="avatar-result"></div>
            </div>

            <!-- 18. Google OAuth -->
            <div class="test-section">
                <h2>
                    <span class="status-indicator" id="status-google-oauth"></span>
                    18. Google OAuth
                    <span class="category-badge badge-auth">AUTH</span>
                </h2>
                <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; padding: 12px; margin-bottom: 12px;">
                    <p style="margin: 0; font-size: 13px; color: #856404;">
                        ⚠️ <strong>開發環境限制</strong>: Google OAuth 不支援私有 IP (10.x.x.x) 作為 callback URL,需要公網環境才能測試。生產環境部署時只需更新 <code>GOOGLE_CALLBACK_URL</code> 環境變數即可使用。
                    </p>
                </div>
                <div class="button-group">
                    <button class="btn-secondary" onclick="testGoogleOAuth()" disabled>Google 登入 (開發環境不可用)</button>
                </div>
                <div id="google-oauth-result"></div>
            </div>

            <!-- 19. 登出 -->
            <div class="test-section">
                <h2>
                    <span class="status-indicator" id="status-logout"></span>
                    19. 登出
                    <span class="category-badge badge-auth">AUTH</span>
                </h2>
                <div class="button-group">
                    <button class="btn-danger" onclick="testLogout()">登出</button>
                </div>
                <div id="logout-result"></div>
            </div>

            <!-- 20. 快速測試所有 -->
            <div class="test-section" style="grid-column: 1 / -1;">
                <h2>
                    20. 批次測試
                    <span class="category-badge badge-system">SYSTEM</span>
                </h2>
                <p style="font-size: 13px; color: #666; margin-top: 0;">依序測試基本功能 (健康檢查 → Session → 等級系統)</p>
                <div class="button-group">
                    <button class="btn-primary" onclick="runBasicTests()">執行基本測試</button>
                    <button class="btn-secondary" onclick="clearAllResults()">清除所有結果</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 使用 Vite proxy,讓請求走代理
        const API_BASE = '';
        
        // 統計
        let stats = {
            tested: 0,
            success: 0,
            failed: 0
        };

        // 更新統計
        function updateStats() {
            document.getElementById('stat-tested').textContent = stats.tested;
            document.getElementById('stat-success').textContent = stats.success;
            document.getElementById('stat-failed').textContent = stats.failed;
        }

        // 更新狀態指示器
        function updateStatusIndicator(id, success) {
            const indicator = document.getElementById('status-' + id);
            if (indicator) {
                indicator.className = 'status-indicator ' + (success ? 'status-success' : 'status-error');
            }
        }

        // 更新結果顯示
        function updateResult(elementId, result, isSuccess = null) {
            const element = document.getElementById(elementId);
            const statusId = elementId.replace('-result', '');
            
            let className = 'result-box ';
            if (isSuccess === true) {
                className += 'result-success';
                stats.success++;
                updateStatusIndicator(statusId, true);
            } else if (isSuccess === false) {
                className += 'result-error';
                stats.failed++;
                updateStatusIndicator(statusId, false);
            } else if (isSuccess === 'pending') {
                className += 'result-pending';
            } else {
                className += 'result-info';
            }
            
            stats.tested++;
            updateStats();
            
            element.className = className;
            element.innerHTML = `<pre>${JSON.stringify(result, null, 2)}</pre>`;
        }

        // API 請求封裝
        async function apiRequest(endpoint, options = {}) {
            const url = `${API_BASE}${endpoint}`;
            try {
                const response = await fetch(url, {
                    ...options,
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                });

                let data = {};
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    data = await response.json().catch(() => ({}));
                } else {
                    const text = await response.text();
                    data = { rawText: text || '(無內容)', contentType };
                }

                return {
                    status: response.status,
                    ok: response.ok,
                    statusText: response.statusText,
                    data: data,
                    headers: Object.fromEntries(response.headers.entries())
                };
            } catch (error) {
                return {
                    status: 0,
                    ok: false,
                    error: error.message,
                    statusText: 'Network Error'
                };
            }
        }

        // 1. 健康檢查
        async function testHealth() {
            updateResult('health-result', { status: '測試中...' }, 'pending');
            const result = await apiRequest('/health');
            updateResult('health-result', result, result.ok);
        }

        // 2. Session 狀態
        async function testSession() {
            updateResult('session-result', { status: '測試中...' }, 'pending');
            const result = await apiRequest('/api/auth/session');
            updateResult('session-result', result, result.ok);
        }

        // 3. 註冊
        async function testRegister() {
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const name = document.getElementById('register-name').value;

            if (!email || !password || !name) {
                updateResult('register-result', { error: '請填寫所有欄位' }, false);
                return;
            }

            updateResult('register-result', { status: '註冊中...' }, 'pending');

            const result = await apiRequest('/api/auth/register', {
                method: 'POST',
                body: JSON.stringify({ email, password, name })
            });

            updateResult('register-result', result, result.status === 201 || result.status === 200);
        }

        // 4. 登入
        async function testLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (!email || !password) {
                updateResult('login-result', { error: '請填寫Email和密碼' }, false);
                return;
            }

            updateResult('login-result', { status: '登入中...' }, 'pending');

            const result = await apiRequest('/api/auth/login', {
                method: 'POST',
                body: JSON.stringify({ email, password })
            });

            updateResult('login-result', result, result.ok);
        }

        // 5. 驗證狀態
        async function testVerificationStatus() {
            updateResult('verify-status-result', { status: '查詢中...' }, 'pending');
            const result = await apiRequest('/api/auth/verification-status');
            updateResult('verify-status-result', result, result.ok);
        }

        // 6. 發送驗證碼
        async function testSendVerification() {
            updateResult('send-verify-result', { status: '發送中...' }, 'pending');
            const result = await apiRequest('/api/auth/send-verification', {
                method: 'POST'
            });
            updateResult('send-verify-result', result, result.ok);
        }

        // 7. 驗證郵箱
        async function testVerifyEmail() {
            const code = document.getElementById('verify-code').value;

            if (!code || code.length !== 6) {
                updateResult('verify-email-result', { error: '請輸入6位數驗證碼' }, false);
                return;
            }

            updateResult('verify-email-result', { status: '驗證中...' }, 'pending');

            const result = await apiRequest('/api/auth/verify-email', {
                method: 'POST',
                body: JSON.stringify({ code })
            });

            updateResult('verify-email-result', result, result.ok);
        }

        // 8. 會員資料
        async function testMemberProfile() {
            const memberId = document.getElementById('member-id').value;

            if (!memberId) {
                updateResult('member-result', { error: '請輸入會員ID' }, false);
                return;
            }

            updateResult('member-result', { status: '載入中...' }, 'pending');

            const result = await apiRequest(`/api/members/${memberId}/profile`);
            updateResult('member-result', result, result.ok);
        }

        // 9. 追蹤會員
        async function testFollowMember() {
            const memberId = document.getElementById('follow-member-id').value;

            if (!memberId) {
                updateResult('follow-result', { error: '請輸入會員ID' }, false);
                return;
            }

            updateResult('follow-result', { status: '追蹤中...' }, 'pending');

            const result = await apiRequest(`/api/members/${memberId}/follow`, {
                method: 'POST'
            });

            updateResult('follow-result', result, result.status === 204 || result.ok);
        }

        // 取消追蹤
        async function testUnfollowMember() {
            const memberId = document.getElementById('follow-member-id').value;

            if (!memberId) {
                updateResult('follow-result', { error: '請輸入會員ID' }, false);
                return;
            }

            updateResult('follow-result', { status: '取消追蹤中...' }, 'pending');

            const result = await apiRequest(`/api/members/${memberId}/follow`, {
                method: 'DELETE'
            });

            updateResult('follow-result', result, result.status === 204 || result.ok);
        }

        // 10. 等級列表
        async function testLevels() {
            updateResult('levels-result', { status: '載入中...' }, 'pending');
            const result = await apiRequest('/levels');
            updateResult('levels-result', result, result.ok);
        }

        // 11. 等級統計
        async function testLevelStats() {
            updateResult('level-stats-result', { status: '載入中...' }, 'pending');
            const result = await apiRequest('/levels/stats');
            updateResult('level-stats-result', result, result.ok);
        }

        // 12. 密碼過期狀態
        async function testPasswordExpiry() {
            updateResult('pwd-expiry-result', { status: '查詢中...' }, 'pending');
            const result = await apiRequest('/api/auth/password-expiry-status');
            updateResult('pwd-expiry-result', result, result.ok);
        }

        // 13. 修改密碼
        async function testChangePassword() {
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;

            if (!currentPassword || !newPassword) {
                updateResult('change-pwd-result', { error: '請填寫所有欄位' }, false);
                return;
            }

            updateResult('change-pwd-result', { status: '修改中...' }, 'pending');

            const result = await apiRequest('/api/auth/change-password', {
                method: 'POST',
                body: JSON.stringify({ currentPassword, newPassword })
            });

            updateResult('change-pwd-result', result, result.ok);
        }

        // 14. 忘記密碼
        async function testForgotPassword() {
            const email = document.getElementById('forgot-email').value;

            if (!email) {
                updateResult('forgot-pwd-result', { error: '請輸入Email' }, false);
                return;
            }

            updateResult('forgot-pwd-result', { status: '發送中...' }, 'pending');

            const result = await apiRequest('/api/auth/forgot-password', {
                method: 'POST',
                body: JSON.stringify({ email })
            });

            updateResult('forgot-pwd-result', result, result.ok);
        }

        // 15. 驗證重設Token
        async function testVerifyResetToken() {
            const token = document.getElementById('reset-token').value;

            if (!token) {
                updateResult('verify-token-result', { error: '請輸入Token' }, false);
                return;
            }

            updateResult('verify-token-result', { status: '驗證中...' }, 'pending');

            const result = await apiRequest('/api/auth/verify-reset-token', {
                method: 'POST',
                body: JSON.stringify({ token })
            });

            updateResult('verify-token-result', result, result.ok);
        }

        // 16. 重設密碼
        async function testResetPassword() {
            const token = document.getElementById('reset-pwd-token').value;
            const newPassword = document.getElementById('reset-new-password').value;

            if (!token || !newPassword) {
                updateResult('reset-pwd-result', { error: '請填寫所有欄位' }, false);
                return;
            }

            updateResult('reset-pwd-result', { status: '重設中...' }, 'pending');

            const result = await apiRequest('/api/auth/reset-password', {
                method: 'POST',
                body: JSON.stringify({ token, newPassword })
            });

            updateResult('reset-pwd-result', result, result.ok);
        }

        // 17. 頭像上傳
        document.getElementById('avatar-file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('avatar-filename').textContent = `已選擇: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
            }
        });

        async function testUploadAvatar() {
            const fileInput = document.getElementById('avatar-file');
            const file = fileInput.files[0];

            if (!file) {
                updateResult('avatar-result', { error: '請選擇圖片檔案' }, false);
                return;
            }

            updateResult('avatar-result', { status: '上傳中...' }, 'pending');

            const formData = new FormData();
            formData.append('avatar', file);

            try {
                const response = await fetch(`${API_BASE}/api/me/avatar`, {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });

                let data = {};
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    data = await response.json();
                }

                const result = {
                    status: response.status,
                    ok: response.ok,
                    data: data
                };

                updateResult('avatar-result', result, result.ok);
            } catch (error) {
                updateResult('avatar-result', { error: error.message }, false);
            }
        }

        // 18. Google OAuth
        function testGoogleOAuth() {
            const redirectUrl = encodeURIComponent('/member');
            window.location.href = `${API_BASE}/api/auth/oauth/google/start?redirectUrl=${redirectUrl}`;
        }

        // 19. 登出
        async function testLogout() {
            updateResult('logout-result', { status: '登出中...' }, 'pending');

            const result = await apiRequest('/api/auth/logout', {
                method: 'POST'
            });

            updateResult('logout-result', result, result.status === 204 || result.ok);
        }

        // 批次測試
        async function runBasicTests() {
            await testHealth();
            await new Promise(resolve => setTimeout(resolve, 500));
            await testSession();
            await new Promise(resolve => setTimeout(resolve, 500));
            await testLevels();
        }

        // 清除所有結果
        function clearAllResults() {
            const results = document.querySelectorAll('[id$="-result"]');
            results.forEach(el => {
                el.innerHTML = '';
                el.className = '';
            });
            
            const indicators = document.querySelectorAll('.status-indicator');
            indicators.forEach(el => {
                el.className = 'status-indicator';
            });
            
            stats = { tested: 0, success: 0, failed: 0 };
            updateStats();
        }

        // 頁面載入時自動測試健康檢查
        window.onload = function() {
            setTimeout(() => {
                testHealth();
            }, 500);
        };
    </script>
</body>
</html>
