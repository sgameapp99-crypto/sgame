# 會員頁日期篩選 - 前端調整報告

**日期**: 2025年10月22日  
**狀態**: ✅ **已完成調整**

---

## 📋 調整概要

根據後端回覆文件 `會員頁日期篩選-後端回覆.md`，前端已完成以下必要調整。

---

## ✅ 已完成的調整

### 1. 參數名稱修正：`userId` → `memberId`

#### 問題
後端 API 使用 `memberId` 作為查詢參數，而非 `userId`。這是為了區分：
- `userId`：當前登入用戶（從 session/token 獲取）
- `memberId`：要查詢的目標會員 ID（可能是自己或其他會員）

#### 修改文件

##### 1.1 types/prediction.ts

**修改內容**：
```typescript
export interface PredictionsQueryParams {
  memberId?: string | number; // 後端使用 memberId 查詢目標會員的預測
  userId?: string; // 保留向後兼容（已廢棄，請使用 memberId）
  allianceId?: number;
  dateRange?: DateRange;
  gameMode?: GameMode;
  status?: PredictionStatus | 'all';
  page?: number;
  size?: number;
  startDate?: string; // 開始日期 (YYYY-MM-DD)
  endDate?: string; // 結束日期 (YYYY-MM-DD)，未設置時表示不限結束日期
}
```

**說明**：
- 新增 `memberId` 作為主要參數
- 保留 `userId` 以維持向後兼容性（標記為已廢棄）
- `memberId` 支援 `string` 或 `number` 類型

##### 1.2 MemberPage.vue

**修改位置**：第712-720行

**修改前**：
```typescript
const result = await predictionsAPI.getPredictions({
  userId: userId,
  page: currentPage.value,
  size: pageSize.value,
  startDate: startDate,
  endDate: endDate,
});
```

**修改後**：
```typescript
// 統一使用 getPredictions API，傳入日期範圍參數
// 注意：後端使用 memberId 而非 userId
const result = await predictionsAPI.getPredictions({
  memberId: userId, // 後端要求使用 memberId 參數
  page: currentPage.value,
  size: pageSize.value,
  startDate: startDate,
  endDate: endDate,  // 可能為 undefined
});
```

---

## 📊 API 調用範例

### 場景 1：查詢一週內的預測

```typescript
const result = await predictionsAPI.getPredictions({
  memberId: currentUser.id,  // 使用 memberId
  startDate: '2025-10-22',
  endDate: '2025-10-29',
  page: 1,
  size: 20
});
```

**對應的 HTTP 請求**：
```http
GET /api/predictions?memberId=123&startDate=2025-10-22&endDate=2025-10-29&page=1&size=20
```

### 場景 2：查詢一個月內的預測

```typescript
const result = await predictionsAPI.getPredictions({
  memberId: currentUser.id,
  startDate: '2025-10-22',
  endDate: '2025-11-21',
  page: 1,
  size: 20
});
```

### 場景 3：查詢全部未來預測（重要）

```typescript
const result = await predictionsAPI.getPredictions({
  memberId: currentUser.id,
  startDate: '2025-10-22',
  // 不傳 endDate，後端會返回所有未來預測
  page: 1,
  size: 20
});
```

**對應的 HTTP 請求**：
```http
GET /api/predictions?memberId=123&startDate=2025-10-22&page=1&size=20
```

### 場景 4：結合聯盟篩選

```typescript
const result = await predictionsAPI.getPredictions({
  memberId: currentUser.id,
  allianceId: 1, // MLB
  startDate: '2025-10-22',
  endDate: '2025-10-29',
  page: 1,
  size: 20
});
```

---

## 🔍 錯誤處理

根據後端提供的錯誤碼，前端已準備好處理以下錯誤：

### 1. 日期格式錯誤（HTTP 400）

**後端回應**：
```json
{
  "success": false,
  "message": "開始日期格式錯誤，請使用 YYYY-MM-DD 格式",
  "code": "INVALID_DATE_FORMAT"
}
```

**前端處理**：
```typescript
if (!response.success) {
  if (response.code === 'INVALID_DATE_FORMAT') {
    showError('日期格式錯誤，請使用正確的日期格式');
  }
}
```

### 2. 日期範圍錯誤（HTTP 400）

**後端回應**：
```json
{
  "success": false,
  "message": "開始日期不能大於結束日期",
  "code": "INVALID_DATE_RANGE"
}
```

**前端處理**：
```typescript
if (response.code === 'INVALID_DATE_RANGE') {
  showError('開始日期不能大於結束日期');
}
```

### 3. 無數據情況（HTTP 200）

**後端回應**：
```json
{
  "success": true,
  "data": [],
  "pagination": {
    "page": 1,
    "size": 20,
    "total": 0
  }
}
```

**前端處理**：
```typescript
if (result.success && result.data.length === 0) {
  // 顯示「暫無預測」的友善提示
}
```

---

## ✅ 調整確認清單

- [x] 1. 更新 `types/prediction.ts` 中的 `PredictionsQueryParams` 介面
- [x] 2. 更新 `MemberPage.vue` 中的 API 調用，使用 `memberId` 而非 `userId`
- [x] 3. 確認沒有其他地方使用舊的 `userId` 參數
- [x] 4. 通過 TypeScript 檢查（無 linter 錯誤）
- [x] 5. 保留 `userId` 欄位以維持向後兼容性

---

## 🧪 測試建議

### 前端測試項目

1. **一週內篩選**
   - 選擇「一週內」選項
   - 確認只顯示今天到未來7天的預測
   - 檢查 API 請求參數是否正確傳遞 `memberId`, `startDate`, `endDate`

2. **一個月內篩選**
   - 選擇「一個月內」選項
   - 確認只顯示今天到未來30天的預測

3. **全部篩選（最重要）**
   - 選擇「全部」選項
   - 確認顯示今天到未來所有預測（不限結束日期）
   - **確認 API 請求中只有 `startDate`，沒有 `endDate`**

4. **聯盟篩選結合日期篩選**
   - 選擇特定聯盟（如 MLB）+ 一週內
   - 確認同時應用兩個篩選條件

5. **分頁功能**
   - 確認翻頁後參數仍然正確

6. **錯誤處理**
   - 模擬後端錯誤回應，確認前端顯示友善提示

---

## 📝 後端 API 端點資訊

### 測試環境
```
URL: https://10.2.0.2:8080
端點: GET /api/predictions
```

### 測試帳號
```
Email: testpred@example.com
Password: Pred1234!@#
Member ID: 5
```

### 測試用 curl 指令

```bash
# 1. 登入獲取 cookie
curl -k -c cookies.txt -X POST https://10.2.0.2:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"testpred@example.com","password":"Pred1234!@#"}'

# 2. 測試一週內
curl -k -b cookies.txt "https://10.2.0.2:8080/api/predictions?memberId=5&startDate=2025-10-22&endDate=2025-10-29"

# 3. 測試全部（不傳 endDate）
curl -k -b cookies.txt "https://10.2.0.2:8080/api/predictions?memberId=5&startDate=2025-10-22"
```

---

## 🔄 與其他功能的兼容性

### 不受影響的功能
- 預測頁面（PredictPage.vue）- 使用不同的篩選邏輯
- 賽事頁面（GamesBattlePage.vue, GamesStandingsPage.vue）
- 即時比分頁面（LivescorePage.vue）

### 可能需要注意的地方
如果未來其他頁面也需要查詢會員的預測列表，請確保：
1. 使用 `memberId` 而非 `userId`
2. 參考 `MemberPage.vue` 中的實作方式

---

## 💡 額外建議

### 1. 日期計算優化
目前日期計算在前端進行，建議保持這個方式：
```typescript
// 今天
const today = new Date();
today.setHours(0, 0, 0, 0);
const startDate = today.toISOString().split('T')[0];

// 一週後
const weekLater = new Date(today);
weekLater.setDate(weekLater.getDate() + 7);
const endDate = weekLater.toISOString().split('T')[0];
```

### 2. 預設值
- 預設選擇「全部」：`selectedDateRange.value = 'all'`
- 預設 `startDate` 為今天
- 預設不設置 `endDate`

### 3. 使用者體驗
- 切換日期範圍時自動重新載入預測
- 顯示載入狀態（loading spinner）
- 無數據時顯示友善提示
- 錯誤時顯示具體的錯誤訊息

---

## 📚 相關文檔

- [會員頁預測API需求文件.md](./會員頁預測API需求文件.md) - 前端提供給後端的需求文件
- [會員頁日期篩選-後端回覆.md](../api/前端整合文檔1022/會員頁日期篩選-後端回覆.md) - 後端的實作回覆

---

## 📞 聯絡資訊

**前端負責人**: [您的名字]  
**後端負責人**: 後端團隊  
**文檔位置**: `/copy/vue/前端調整報告-會員頁日期篩選.md`

---

## 📌 重要提醒

### ⚠️ 關鍵變更
**參數名稱從 `userId` 改為 `memberId`，這是不兼容的變更。**

所有調用 `predictionsAPI.getPredictions()` 且需要查詢特定會員預測的地方，都必須使用 `memberId` 參數。

### ✅ 向後兼容性
為了安全起見，我們在類型定義中保留了 `userId` 欄位，但標記為已廢棄。未來所有新代碼應使用 `memberId`。

---

**調整完成日期**: 2025年10月22日  
**文檔版本**: v1.0  
**狀態**: ✅ 已完成並可進行整合測試

