# 前端與後端 API 整合確認清單

**整合日期**: 2025年10月22日  
**狀態**: ✅ **已完成基礎調整，可開始測試**

---

## ✅ 已完成的調整

### 1. API 端點名稱 ✅ 

後端實際使用的端點（前端已正確實作）：

```typescript
// ✅ 彩幣查詢 - 正確
GET /api/me/coins

// ✅ 彩幣充值 - 正確
POST /api/me/coins/purchase

// ✅ 彩幣交易記錄 - 正確
GET /api/me/coins/transactions
```

**檔案**: `src/api/coins.ts` - 無需修改

---

### 2. 回應欄位名稱 ✅

#### 2.1 建立預測回應
```typescript
// ❌ 舊的（已修正）
interface CreatePredictionResponse {
  predictionId: number;
}

// ✅ 新的（已更新）
interface CreatePredictionResponse {
  id: number; // 後端返回 id 而非 predictionId
}
```

**已修正檔案**: 
- `src/types/prediction.ts` (第70行)

---

#### 2.2 購買預測回應
```typescript
// ✅ 已正確使用
interface PurchasePredictionResponse {
  success: boolean;
  message: string;
  remainingCoins: number; // 不是 newBalance
  prediction: Partial<Prediction>;
}
```

**已修正檔案**:
- `src/types/prediction.ts` (第101行) - 已正確
- `src/pages/MemberPage.vue` (第759行) - 已修正使用 `remainingCoins`
- `src/components/PurchaseDialog.vue` (第140行) - 已正確

---

#### 2.3 預測物件中的 ID
```typescript
// ✅ 已正確
interface Prediction {
  id: number; // 不是 predictionId
  userId: number;
  gameId: string;
  // ...其他欄位
}
```

**檔案**: `src/types/prediction.ts` - 已正確

---

#### 2.4 購買者資訊
```typescript
// ✅ 已正確
interface Prediction {
  purchaseCount?: number; // 購買人數（後端提供）
  // 不是 purchasedBy: string[]
}
```

**檔案**: `src/types/prediction.ts` (第52行) - 已正確

---

## 📊 整合前後對比

| 功能 | 前端舊欄位 | 後端實際欄位 | 狀態 |
|-----|----------|------------|------|
| 建立預測回應 | `predictionId` | `id` | ✅ 已修正 |
| 購買後餘額 | `newBalance` | `remainingCoins` | ✅ 已修正 |
| 購買者資訊 | `purchasedBy[]` | `purchaseCount` | ✅ 已正確 |
| 彩幣查詢端點 | `/me/coins` | `/me/coins` | ✅ 已正確 |
| 彩幣充值端點 | `/me/coins/purchase` | `/me/coins/purchase` | ✅ 已正確 |

---

## 🧪 建議測試流程

### 階段一：基礎功能測試（1-2小時）

#### 1. 註冊與登入
```bash
# 測試註冊
curl -k -X POST https://10.2.0.2:8080/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "frontend-test@example.com",
    "password": "Test1234!",
    "name": "前端測試"
  }'

# 測試登入
curl -k -c cookies.txt -X POST https://10.2.0.2:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "frontend-test@example.com",
    "password": "Test1234!"
  }'
```

**驗證點**:
- [ ] 註冊成功返回 201
- [ ] 登入成功返回 token 或 cookie
- [ ] 自動建立彩幣帳戶（餘額 0）

---

#### 2. 彩幣功能
```bash
# 查詢彩幣帳戶
curl -k -b cookies.txt https://10.2.0.2:8080/api/me/coins

# 充值彩幣
curl -k -b cookies.txt -X POST https://10.2.0.2:8080/api/me/coins/purchase \
  -H "Content-Type: application/json" \
  -d '{"amount": 1000, "note": "測試充值"}'

# 查看交易記錄
curl -k -b cookies.txt https://10.2.0.2:8080/api/me/coins/transactions
```

**驗證點**:
- [ ] 彩幣帳戶資訊正確（accountId, balance, earned, spent）
- [ ] 充值成功後餘額正確增加
- [ ] transaction.balance 為充值後餘額
- [ ] 交易記錄正確顯示

---

#### 3. 預測設定
```bash
# 查詢預測設定
curl -k -b cookies.txt https://10.2.0.2:8080/api/me/prediction-settings

# 更新預測設定
curl -k -b cookies.txt -X PATCH https://10.2.0.2:8080/api/me/prediction-settings \
  -H "Content-Type: application/json" \
  -d '{"defaultPrice": 150, "allowPurchase": true}'
```

**驗證點**:
- [ ] 預設設定正確（defaultPrice: 100, allowPurchase: true, autoPublish: true）
- [ ] 更新設定成功
- [ ] 設定值正確保存

---

### 階段二：預測功能測試（2-3小時）

#### 4. 查詢賽事
```bash
# 查詢未來賽事（可建立預測）
curl -k "https://10.2.0.2:8080/api/games?status=scheduled&page=1&size=20"

# 查詢特定聯盟
curl -k "https://10.2.0.2:8080/api/games?allianceId=1&status=scheduled"
```

**驗證點**:
- [ ] 賽事列表正確返回
- [ ] 賽事資料包含 id (不是 gameId)
- [ ] 賽事包含 allianceId, sportType, homeTeam, awayTeam
- [ ] scheduled 狀態的賽事可用於建立預測

**測試資料**: 後端已載入 18 場測試賽事，包括：
- 9 場 scheduled（未來賽事）
- 2 場 live（進行中）
- 7 場 finished（已結束）

---

#### 5. 建立預測
```bash
# 選擇一場 scheduled 賽事建立預測
curl -k -b cookies.txt -X POST https://10.2.0.2:8080/api/predictions \
  -H "Content-Type: application/json" \
  -d '{
    "gameId": "20251025TEST001",
    "predictionType": "international_spread",
    "selection": "home",
    "odds": "1.85",
    "price": 100,
    "isMainPick": false,
    "note": "主場優勢明顯"
  }'
```

**驗證點**:
- [ ] 建立成功返回 200
- [ ] 回應包含 `id` 欄位（數字型態）
- [ ] 回應包含 `message: "預測已建立"`
- [ ] 回應中使用 `id` 而非 `predictionId` ✅

**錯誤場景測試**:
```bash
# 測試重複建立
# 預期: code: "PREDICTION_EXISTS"

# 測試賽事已開始
# 預期: code: "GAME_STARTED"

# 測試賽事不存在
# 預期: code: "GAME_NOT_FOUND"
```

---

#### 6. 查詢預測列表
```bash
# 查詢所有預測
curl -k "https://10.2.0.2:8080/api/predictions?page=1&size=20"

# 查詢自己的預測
curl -k -b cookies.txt "https://10.2.0.2:8080/api/predictions?userId=YOUR_USER_ID"

# 查詢特定狀態
curl -k "https://10.2.0.2:8080/api/predictions?status=pending"
```

**驗證點**:
- [ ] 預測列表正確返回
- [ ] 預測物件使用 `id` 而非 `predictionId` ✅
- [ ] 包含 `isPurchased` 和 `isOwn` 欄位
- [ ] 包含 `purchaseCount` (數字) 而非 `purchasedBy` (陣列) ✅

**內容隱藏邏輯**:
- [ ] 未購買時：`selection = null`, `note = null`, `selectionLabel = "***"`
- [ ] 已購買時：顯示完整 selection, note, selectionLabel
- [ ] 本人預測：總是顯示完整內容

---

### 階段三：購買功能測試（2-3小時）

#### 7. 購買預測
```bash
# 用另一個帳號登入
curl -k -c cookies2.txt -X POST https://10.2.0.2:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "buyer@example.com",
    "password": "Test1234!"
  }'

# 充值彩幣
curl -k -b cookies2.txt -X POST https://10.2.0.2:8080/api/me/coins/purchase \
  -H "Content-Type: application/json" \
  -d '{"amount": 500}'

# 購買預測
curl -k -b cookies2.txt -X POST https://10.2.0.2:8080/api/predictions/PREDICTION_ID/purchase
```

**驗證點**:
- [ ] 購買成功返回 200
- [ ] 回應包含 `remainingCoins` 欄位 ✅
- [ ] remainingCoins = 購買前餘額 - 預測價格
- [ ] 回應包含解鎖的預測內容
- [ ] 買家彩幣正確扣除
- [ ] 賣家彩幣正確增加

**錯誤場景測試**:
```bash
# 測試重複購買
# 預期: code: "ALREADY_PURCHASED"

# 測試自購
# 預期: code: "SELF_PURCHASE"

# 測試餘額不足
# 預期: code: "INSUFFICIENT_BALANCE"

# 測試賽事已結束
# 預期: code: "GAME_FINISHED"
```

---

#### 8. 驗證彩幣流轉
```bash
# 賣家查詢餘額
curl -k -b cookies.txt https://10.2.0.2:8080/api/me/coins

# 買家查詢餘額
curl -k -b cookies2.txt https://10.2.0.2:8080/api/me/coins

# 查看交易記錄
curl -k -b cookies.txt https://10.2.0.2:8080/api/me/coins/transactions
curl -k -b cookies2.txt https://10.2.0.2:8080/api/me/coins/transactions
```

**驗證點**:
- [ ] 賣家餘額 = 原餘額 + 預測價格
- [ ] 買家餘額 = 原餘額 - 預測價格
- [ ] 交易記錄正確記錄收入/支出
- [ ] 交易記錄包含 relatedPredictionId

---

## 🔐 錯誤碼對照表

前端需要處理的錯誤碼：

### 認證相關
```typescript
UNAUTHORIZED          // 401 - 未登入
FORBIDDEN             // 403 - 無權限
```

### 賽事相關
```typescript
GAME_NOT_FOUND       // 404 - 賽事不存在
GAME_STARTED         // 400 - 賽事已開始
GAME_FINISHED        // 400 - 賽事已結束
```

### 預測相關
```typescript
PREDICTION_NOT_FOUND     // 404 - 預測不存在
PREDICTION_EXISTS        // 409 - 預測已存在（重複建立）
PREDICTION_HAS_PURCHASES // 400 - 預測已有購買記錄（無法刪除）
INVALID_PREDICTION_TYPE  // 400 - 無效的預測類型
INVALID_SELECTION        // 400 - 無效的選擇
```

### 購買相關
```typescript
INSUFFICIENT_BALANCE  // 400 - 彩幣餘額不足
ALREADY_PURCHASED     // 409 - 已購買過此預測
SELF_PURCHASE         // 400 - 無法購買自己的預測
```

### 驗證相關
```typescript
VALIDATION_ERROR     // 400 - 資料驗證失敗
MISSING_FIELDS       // 400 - 缺少必要欄位
INVALID_PARAMETER    // 400 - 無效的參數
```

**錯誤回應格式**:
```json
{
  "success": false,
  "message": "錯誤訊息",
  "code": "ERROR_CODE"
}
```

---

## 📝 前端程式碼範例

### 建立預測
```typescript
// ✅ 正確的寫法
const response = await predictionsAPI.createPrediction({
  gameId: "20251025TEST001",
  predictionType: "international_spread",
  selection: "home",
  odds: "1.85",
  price: 100,
  isMainPick: false,
  note: "主場優勢明顯"
});

// 使用 id 而不是 predictionId
const predictionId = response.id; // ✅
```

### 購買預測
```typescript
// ✅ 正確的寫法
const response = await predictionsAPI.purchasePrediction(predictionId);

if (response.success) {
  // 使用 remainingCoins 而不是 newBalance
  const newBalance = response.remainingCoins; // ✅
  
  // 更新本地餘額
  coinBalance.value = newBalance;
  
  // 更新預測內容
  prediction.value = {
    ...prediction.value,
    ...response.prediction,
    isPurchased: true
  };
}
```

### 查詢彩幣
```typescript
// ✅ 正確的寫法
const coinInfo = await coinsAPI.getCoinInfo(); // /api/me/coins

console.log(coinInfo.accountId); // 8位數帳戶ID
console.log(coinInfo.balance);   // 當前餘額
console.log(coinInfo.earned);    // 總收入
console.log(coinInfo.spent);     // 總支出
```

### 充值彩幣
```typescript
// ✅ 正確的寫法
const result = await coinsAPI.purchaseCoins({ // /api/me/coins/purchase
  amount: 1000,
  note: "充值彩幣"
});

if (result.success) {
  // transaction.balance 是充值後的餘額
  const newBalance = result.transaction.balance; // ✅
  coinBalance.value = newBalance;
}
```

### 錯誤處理
```typescript
try {
  const result = await predictionsAPI.purchasePrediction(id);
} catch (error: any) {
  const code = error?.response?.data?.code;
  const message = error?.response?.data?.message;
  
  switch (code) {
    case 'INSUFFICIENT_BALANCE':
      alert('彩幣餘額不足，請先充值');
      break;
    case 'ALREADY_PURCHASED':
      alert('您已購買過此預測');
      break;
    case 'SELF_PURCHASE':
      alert('無法購買自己的預測');
      break;
    case 'GAME_FINISHED':
      alert('賽事已結束');
      break;
    default:
      alert(message || '操作失敗');
  }
}
```

---

## ✅ 整合完成檢查清單

### 代碼調整
- [x] 修正 CreatePredictionResponse.id
- [x] 修正購買預測使用 remainingCoins
- [x] 確認 Prediction.purchaseCount
- [x] 確認彩幣 API 端點
- [x] 無 linter 錯誤

### 測試準備
- [ ] 建立測試帳號（賣家）
- [ ] 建立測試帳號（買家）
- [ ] 準備測試賽事 ID（使用後端提供的測試資料）
- [ ] 準備 Postman/Insomnia collection

### 功能測試
- [ ] 註冊與登入
- [ ] 彩幣查詢與充值
- [ ] 預測設定
- [ ] 查詢賽事
- [ ] 建立預測
- [ ] 查詢預測（驗證內容隱藏）
- [ ] 購買預測
- [ ] 驗證彩幣流轉
- [ ] 錯誤場景測試

### 整合測試
- [ ] 完整預測流程（建立→購買→結算）
- [ ] 併發購買測試
- [ ] 邊界條件測試
- [ ] 效能測試

---

## 📞 後續支援

### 遇到問題時
1. 檢查請求格式是否正確
2. 檢查錯誤碼和錯誤訊息
3. 查看後端測試報告確認預期行為
4. 查看後端 API 文檔確認欄位名稱

### 參考文檔
- `api/前端整合文檔1022/後端確認回覆.md` - 完整API說明
- `api/前端整合文檔1022/最終測試報告.md` - 後端測試結果
- `api/前端整合文檔1022/測試資料使用說明.md` - 測試賽事資料
- `api/前端整合文檔1022/README-前端請先看這裡.md` - 快速入門

---

**整合狀態**: ✅ 準備就緒  
**最後更新**: 2025年10月22日  
**整合負責人**: AI Assistant

🎉 前端代碼已調整完成，可以開始整合測試了！

