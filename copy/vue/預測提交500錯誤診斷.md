# 預測提交 500 錯誤診斷指南

**問題**: POST /api/predictions 返回 500 Internal Server Error

---

## ✅ 已修正的前端問題

### 1. **重複提交問題** ✅ 已修正
**原因**: 舊邏輯在選擇時立即提交，新邏輯在點擊按鈕時提交，導致重複提交

**修正**: 
- 移除了 `PredictPage.vue` 的 `handlePredictionSelect` 中的立即提交邏輯
- 現在只有點擊「提交預測」按鈕時才會提交

### 2. **移除可選欄位的空值** ✅ 已修正
**修正**: 移除了 `note: ''` 空字串（因為 note 是選填欄位）

### 3. **添加詳細錯誤日誌** ✅ 已完成
現在控制台會顯示：
- 請求數據
- 錯誤狀態碼
- 錯誤代碼
- 錯誤訊息

---

## 🔍 如何診斷 500 錯誤

### 步驟 1: 檢查瀏覽器控制台

打開瀏覽器開發者工具（F12），查看 Console 標籤：

```javascript
// 應該會看到類似這樣的日誌：

提交預測請求: {
  gameId: "20251024TEST007",
  predictionType: "international_spread",
  selection: "home",
  odds: "1.90",
  price: 100,
  isMainPick: false
}

提交預測失敗 (20251024TEST007): AxiosError {...}

錯誤詳情: {
  status: 500,
  code: "...",
  message: "...",
  data: {...}
}
```

### 步驟 2: 檢查 Network 標籤

1. 切換到 Network 標籤
2. 找到失敗的 `/api/predictions` 請求
3. 點擊該請求
4. 查看以下標籤頁：
   - **Headers**: 檢查請求頭
   - **Payload**: 檢查請求內容
   - **Response**: 查看後端返回的錯誤訊息

---

## 🎯 可能的後端問題

### 問題 1: 賽事 ID 不存在

**症狀**: 
```json
{
  "code": "GAME_NOT_FOUND",
  "message": "賽事不存在"
}
```

**解決方案**:
1. 檢查賽事 ID 是否正確
2. 確認後端資料庫中有該賽事
3. 檢查賽事 ID 格式（應該是字串）

**測試命令**:
```bash
# 檢查賽事是否存在
curl -k "https://10.2.0.2:8080/api/games?gameId=20251024TEST007"
```

---

### 問題 2: 未登入或登入過期

**症狀**:
```json
{
  "code": "UNAUTHORIZED",
  "message": "未登入"
}
```

**解決方案**:
1. 確認已登入
2. 檢查 Cookie 或 Token 是否有效
3. 重新登入

**測試命令**:
```bash
# 檢查登入狀態
curl -k -b cookies.txt https://10.2.0.2:8080/api/me/coins
```

---

### 問題 3: 資料驗證失敗

**症狀**:
```json
{
  "code": "VALIDATION_ERROR",
  "message": "資料驗證失敗: ..."
}
```

**可能原因**:
- `gameId` 格式不正確
- `predictionType` 不是有效值
- `selection` 不是有效值
- `odds` 格式不正確
- `price` 超出範圍（應該是 0-10000）

**有效的 predictionType**:
- `international_spread`
- `international_total`
- `taiwan_spread`
- `taiwan_moneyline`
- `taiwan_total`

**有效的 selection**:
- `home`
- `away`
- `over`
- `under`

---

### 問題 4: 資料庫錯誤

**症狀**:
```json
{
  "code": "DATABASE_ERROR",
  "message": "資料庫錯誤"
}
```

**解決方案**:
1. 檢查後端伺服器日誌
2. 確認資料庫連線正常
3. 檢查資料庫表結構是否正確

**檢查後端日誌**:
```bash
# 查看 Node.js 後端日誌
pm2 logs sgame-api

# 或直接查看日誌檔案
tail -f /path/to/logs/error.log
```

---

### 問題 5: 後端未啟動或配置錯誤

**症狀**: 
- 直接返回 500 錯誤
- 沒有具體的錯誤代碼或訊息

**解決方案**:
1. 確認後端服務正在運行
2. 檢查後端配置檔案
3. 檢查資料庫連線

**檢查後端狀態**:
```bash
# 檢查服務狀態
pm2 status

# 檢查端口是否開啟
netstat -tulpn | grep 8080

# 測試健康檢查端點
curl -k https://10.2.0.2:8080/health
```

---

## 🧪 測試建議

### 1. 使用 cURL 直接測試 API

```bash
# 先登入獲取 Cookie
curl -k -c cookies.txt -X POST https://10.2.0.2:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"Test1234!"}'

# 測試建立預測
curl -k -b cookies.txt -X POST https://10.2.0.2:8080/api/predictions \
  -H "Content-Type: application/json" \
  -d '{
    "gameId": "20251024TEST007",
    "predictionType": "international_spread",
    "selection": "home",
    "odds": "1.90",
    "price": 100,
    "isMainPick": false
  }'
```

### 2. 檢查請求格式

確認前端發送的請求格式與後端期望的完全一致：

**後端期望的格式** (根據文檔):
```json
{
  "gameId": "2025101510001",
  "predictionType": "international_spread",
  "selection": "home",
  "odds": "1.85",
  "price": 100,
  "isMainPick": false,
  "note": "主場優勢明顯"  // 選填
}
```

**前端發送的格式**:
```json
{
  "gameId": "20251024TEST007",
  "predictionType": "international_spread",
  "selection": "home",
  "odds": "1.90",
  "price": 100,
  "isMainPick": false
}
```

---

## 📋 檢查清單

### 前端檢查
- [ ] 確認沒有重複提交（已修正）
- [ ] 確認請求格式正確
- [ ] 確認 gameId 來自真實賽事
- [ ] 確認已登入
- [ ] 檢查瀏覽器控制台的詳細錯誤

### 後端檢查
- [ ] 後端服務正在運行
- [ ] 資料庫連線正常
- [ ] 賽事資料存在
- [ ] 用戶已登入且 session 有效
- [ ] 沒有重複預測（同一賽事+同一類型）
- [ ] 賽事狀態是 `scheduled`（未開始）

---

## 🔧 快速修復步驟

### 如果是測試環境

1. **重新載入測試賽事**:
```bash
cd /home/gogofire1774
./load-test-games.sh
```

2. **重新登入**:
```bash
# 清除舊的 Cookie
rm cookies.txt

# 重新登入
curl -k -c cookies.txt -X POST https://10.2.0.2:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"Test1234!"}'
```

3. **檢查賽事列表**:
```bash
curl -k "https://10.2.0.2:8080/api/games?status=scheduled"
```

4. **使用正確的賽事 ID 重試**

---

## 📞 需要進一步幫助？

1. **提供以下資訊**:
   - 瀏覽器控制台完整錯誤日誌
   - Network 標籤中的請求和回應內容
   - 後端伺服器日誌
   - 使用的賽事 ID

2. **檢查後端文檔**:
   - `api/前端整合文檔1022/後端確認回覆.md`
   - `api/前端整合文檔1022/最終測試報告.md`

3. **查看測試資料**:
   - `api/前端整合文檔1022/測試資料使用說明.md`

---

**最後更新**: 2025年10月22日  
**相關檔案**: 
- `/home/gogofire1774/sgame/copy/vue/src/components/PredictGamesTable.vue`
- `/home/gogofire1774/sgame/copy/vue/src/pages/PredictPage.vue`

