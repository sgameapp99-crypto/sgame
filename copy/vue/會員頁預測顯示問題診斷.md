# 會員頁預測顯示問題診斷指南

**問題描述**: 預測已成功提交（409 錯誤表示重複提交，證明預測已存在），但在會員頁面看不到自己的預測。

**日期**: 2025-10-22

---

## 🔍 診斷步驟

### 第一步：檢查控制台日誌

1. 打開瀏覽器開發者工具（F12）
2. 切換到 **Console** 標籤
3. 刷新會員頁面
4. 查看以下調試信息：

#### 應該看到的日誌：

```
🔍 載入會員預測 - 請求參數: { memberId: 27, page: 1, size: 20, startDate: "2025-10-22", endDate: undefined }
🔍 當前日期範圍選擇: all
🔍 路由參數 ID: undefined
🔍 Session Profile ID: 27
✅ 預測 API 回應: { success: true, dataCount: 5, total: 5, firstPrediction: {...} }
```

或者如果沒有數據：

```
🔍 載入會員預測 - 請求參數: { ... }
✅ 預測 API 回應: { success: true, dataCount: 0, total: 0 }
⚠️ 沒有預測數據，可能原因：
   - 該會員確實沒有預測
   - 日期範圍內沒有預測
   - memberId 參數不正確
```

### 第二步：檢查請求參數

從控制台日誌中確認：

#### ✅ 檢查項 1: memberId 是否正確

```
預期: memberId: 27 (您的會員ID)
如果看到: memberId: undefined 或 memberId: "undefined"
→ 問題: session.profile?.id 沒有正確設置
```

#### ✅ 檢查項 2: startDate 是否為今天

```
預期: startDate: "2025-10-22" (今天的日期)
如果看到: startDate: undefined
→ 問題: 日期計算有誤
```

#### ✅ 檢查項 3: endDate 在「全部」模式下應該是 undefined

```
預期: endDate: undefined (顯示所有未來預測)
如果看到: endDate: "2025-10-29"
→ 問題: 日期範圍選擇器設置錯誤
```

### 第三步：檢查 API 回應

#### ✅ 檢查項 4: API 請求是否成功

在 **Network** 標籤中查找：

```
請求: GET /api/predictions?memberId=27&startDate=2025-10-22&page=1&size=20
狀態: 200 OK
```

點擊該請求，查看 **Response** 標籤：

```json
{
  "success": true,
  "data": [
    {
      "id": 123,
      "userId": 27,
      "gameId": "20251024TEST007",
      "predictionType": "international_spread",
      "status": "pending",
      ...
    }
  ],
  "pagination": {
    "page": 1,
    "size": 20,
    "total": 1
  }
}
```

---

## 🐛 常見問題與解決方案

### 問題 1: API 返回 400 錯誤

**錯誤訊息**: `"memberId is required"` 或 `"Invalid memberId"`

**原因**: 
- 前端傳入的 memberId 為 undefined 或格式不正確
- session.profile?.id 沒有正確設置

**解決方案**:
```typescript
// 檢查 session store 中的 profile
console.log('Session Profile:', session.profile);

// 如果 profile 為 null，需要重新登入
if (!session.profile) {
  await session.fetchSession(true);
}
```

### 問題 2: API 返回 200 但 data 為空數組

**可能原因 1**: 預測的賽事日期在今天之前

```
說明: 當前篩選邏輯只顯示 gameDate >= 今天的預測
解決: 選擇不同的日期範圍或檢查預測的 gameDate
```

**可能原因 2**: 預測存在但屬於不同會員

```
說明: 確認提交預測時使用的帳號與查看預測的帳號一致
檢查: 
1. 提交預測時的登入帳號
2. 查看會員頁面時的登入帳號
3. API 返回的 userId 是否與當前會員 ID 一致
```

**可能原因 3**: 後端參數名稱不匹配

```
說明: 前端使用 memberId，但後端可能期望 userId
解決: 確認後端 API 文檔中的參數名稱
```

### 問題 3: 前端顯示「載入預測失敗」

**檢查步驟**:

1. **查看控制台錯誤信息**
   ```
   ❌ 載入預測錯誤: { message: "...", status: 500, ... }
   ```

2. **檢查 Network 標籤中的請求詳情**
   - Request URL 是否正確
   - Request Headers 是否包含正確的認證信息
   - Response 中的錯誤訊息

3. **檢查後端日誌**
   - 後端是否收到請求
   - 後端處理過程中是否有錯誤

### 問題 4: 預測數據存在但頁面沒有顯示

**可能原因**: 前端渲染邏輯有問題

**檢查步驟**:

1. **確認 predictions 陣列有數據**
   ```javascript
   // 在 Vue DevTools 中查看
   predictions: Array(5) [...]
   ```

2. **確認 filteredPredictions 計算屬性正確**
   ```javascript
   // 檢查聯盟篩選是否過濾掉了所有預測
   console.log('Selected Alliance:', selectedAlliance.value);
   console.log('Filtered Predictions:', filteredPredictions.value);
   ```

3. **檢查模板中的條件渲染**
   ```vue
   <!-- 確認沒有 v-if 隱藏了預測列表 -->
   <div v-if="activeTab === 'predict'">
     <!-- 預測內容 -->
   </div>
   ```

---

## 🧪 測試步驟

### 測試 1: 驗證 API 直接調用

使用 curl 直接測試 API：

```bash
# 1. 登入獲取 cookie
curl -k -c cookies.txt -X POST https://34.80.46.175:5175/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"your-email@example.com","password":"your-password"}'

# 2. 查詢預測（使用您的 memberId）
curl -k -b cookies.txt "https://34.80.46.175:5175/api/predictions?memberId=27&startDate=2025-10-22"
```

**預期結果**: 應該返回預測列表

### 測試 2: 驗證不同日期範圍

1. 選擇「一週內」→ 應該顯示今天到未來7天的預測
2. 選擇「一個月內」→ 應該顯示今天到未來30天的預測
3. 選擇「全部」→ 應該顯示今天到未來所有的預測

### 測試 3: 驗證聯盟篩選

1. 選擇不同的聯盟（MLB, NBA, 等）
2. 確認只顯示該聯盟的預測
3. 取消聯盟選擇 → 應該顯示所有聯盟的預測

---

## 📋 數據檢查清單

請在控制台執行以下檢查，並記錄結果：

### 檢查 1: 會員資訊
```javascript
// 在瀏覽器控制台執行
console.log('會員 ID:', window.__VUE_APP__?.config?.globalProperties?.$session?.profile?.id);
```
- [ ] 會員 ID 正確顯示（例如：27）
- [ ] 會員 ID 不是 undefined

### 檢查 2: 預測數據
```javascript
// 查看 Vue DevTools 中的組件狀態
// MemberPage 組件 → predictions
```
- [ ] predictions 陣列存在
- [ ] predictions 陣列長度 > 0
- [ ] 預測對象包含必要字段（gameId, predictionType, status 等）

### 檢查 3: 日期篩選
```javascript
// 在瀏覽器控制台執行
console.log('選擇的日期範圍:', document.querySelector('.tag-chosen')?.textContent);
```
- [ ] 顯示「全部」（預設）
- [ ] 可以切換到「一週內」「一個月內」

### 檢查 4: API 請求
查看 Network 標籤：
- [ ] 有發送 GET /api/predictions 請求
- [ ] 請求包含正確的 query parameters
- [ ] 請求返回 200 狀態碼
- [ ] 回應包含 data 和 pagination

---

## 🔧 快速修復

如果確認是前端問題，嘗試以下快速修復：

### 修復 1: 強制重新載入預測

在瀏覽器控制台執行：

```javascript
// 獲取 Vue 應用實例
const app = document.querySelector('#app').__vueParentComponent;

// 手動觸發載入預測
// (需要根據實際的組件引用調整)
```

### 修復 2: 清除緩存並重新登入

1. 清除瀏覽器緩存（Ctrl+Shift+Delete）
2. 登出
3. 重新登入
4. 訪問會員頁面

### 修復 3: 檢查後端參數名稱

如果後端使用 `userId` 而非 `memberId`，暫時修改前端代碼：

```typescript
// 在 MemberPage.vue 的 loadPredictions 函數中
const result = await predictionsAPI.getPredictions({
  userId: userId,  // 改回 userId
  // memberId: userId, // 註解掉 memberId
  page: currentPage.value,
  size: pageSize.value,
  startDate: startDate,
  endDate: endDate,
});
```

---

## 📞 需要幫助？

如果以上步驟都無法解決問題，請提供以下信息：

### 必需信息：

1. **控制台完整日誌**（包括所有 🔍 ✅ ❌ 開頭的日誌）

2. **Network 標籤中的 API 請求詳情**
   - Request URL
   - Request Method
   - Status Code
   - Request Headers
   - Query String Parameters
   - Response

3. **Vue DevTools 中的組件狀態**
   - `predictions` 陣列的內容
   - `filteredPredictions` 的值
   - `selectedAlliance` 的值
   - `selectedDateRange` 的值

4. **預測提交時的信息**
   - 提交成功後的回應
   - 預測的 gameId
   - 預測的 predictionType

### 可選信息：

- 瀏覽器類型和版本
- 是否有瀏覽器擴展程式（廣告攔截器等）
- 是否使用 VPN 或代理

---

## 💡 預防措施

為了避免將來出現類似問題：

### 1. 統一參數命名

確保前後端對參數名稱達成一致：
- 前端文檔中使用 `memberId`
- 後端 API 也使用 `memberId`
- 或兩者都使用 `userId`

### 2. 完善錯誤提示

在前端顯示更友善的錯誤訊息：
```typescript
if (predictions.value.length === 0) {
  // 顯示友善提示而不是空白頁面
  predictionsError.value = '目前沒有預測數據，您可以前往預測頁面進行預測！';
}
```

### 3. 添加重試機制

API 請求失敗時提供重試選項：
```vue
<button v-if="predictionsError" @click="loadPredictions">
  重新載入
</button>
```

---

**診斷完成後，請將控制台日誌和 Network 信息截圖提供給技術團隊以便進一步分析。**

