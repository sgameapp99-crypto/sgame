# 論壇系統設計討論 - 後端回覆

## 📅 討論時間
**2025年10月23日**

---

## 🎯 設計決策與建議

根據現有系統架構和最佳實踐，針對前端提出的5個關鍵設計問題，我們提供以下建議：

---

### 1️⃣ 文章內容儲存格式

**建議：c) 富文本 JSON（如 Quill、TipTap 格式）** ✅

#### 理由

| 優點 | 說明 |
|------|------|
| 🎨 **格式豐富** | 支援粗體、斜體、標題、列表、圖片、連結等 |
| 🔒 **XSS 防護** | JSON 格式更容易做內容淨化 |
| 📱 **多端支援** | 前端可以輕鬆渲染到不同平台 |
| 🔄 **可擴展** | 未來可以加入自定義區塊（如程式碼、引用等） |
| 💾 **PostgreSQL 原生支援** | JSONB 欄位效能好，可查詢 |

#### 推薦方案

**使用 TipTap（推薦）或 Quill**

```typescript
// 資料庫儲存格式
content: {
  type: "doc",
  content: [
    {
      type: "paragraph",
      content: [
        { type: "text", text: "這是一段" },
        { type: "text", marks: [{ type: "bold" }], text: "粗體" },
        { type: "text", text: "文字" }
      ]
    },
    {
      type: "image",
      attrs: {
        src: "https://example.com/image.jpg",
        alt: "描述"
      }
    }
  ]
}
```

#### Schema 設計

```prisma
model Post {
  content       Json         // 使用 JSONB 儲存富文本
  contentText   String?      // 純文字版本（用於搜尋）
  contentHtml   String?      // HTML 快取（選填，提升讀取效能）
}
```

---

### 2️⃣ 圖片/附件處理

**建議：b) 獨立附件表，關聯到文章** ✅

#### 理由

| 優點 | 說明 |
|------|------|
| 📊 **更好的管理** | 可以追蹤每個檔案的大小、類型、上傳時間 |
| 🔄 **可重複使用** | 同一個圖片可以被多篇文章引用 |
| 🗑️ **清理機制** | 容易找出未使用的檔案並清理 |
| 📈 **統計分析** | 可以統計儲存空間使用量 |
| 🔒 **權限控制** | 可以對附件單獨設定存取權限 |

#### Schema 設計

```prisma
model Attachment {
  id            Int      @id @default(autoincrement())
  postId        Int?     // 可為 null，允許暫存
  userId        Int      // 上傳者
  filename      String   // 原始檔名
  mimeType      String   // 檔案類型
  size          Int      // 檔案大小（bytes）
  url           String   // 儲存路徑或 URL
  thumbnailUrl  String?  // 縮圖（圖片用）
  width         Int?     // 圖片寬度
  height        Int?     // 圖片高度
  uploadedAt    DateTime @default(now())
  
  post          Post?    @relation(fields: [postId], references: [id], onDelete: Cascade)
  user          User     @relation(fields: [userId], references: [id])
  
  @@index([postId])
  @@index([userId])
  @@map("attachments")
}

model Post {
  // ... 其他欄位
  attachments   Attachment[]
}
```

#### 使用流程

1. **上傳時**：用戶上傳圖片 → 儲存到 `attachments` 表 → 返回 URL
2. **編輯時**：文章內容引用 `attachment.url`
3. **發布時**：關聯 `attachments.postId` 到文章
4. **刪除時**：Cascade 刪除會自動清理附件

---

### 3️⃣ 用戶關聯方式

**建議：a) 直接關聯現有用戶表** ✅

#### 理由

| 優點 | 說明 |
|------|------|
| 🎯 **統一用戶系統** | 避免資料重複和不一致 |
| 🔐 **單一登入** | 使用現有的認證系統 |
| 📊 **完整用戶畫像** | 可以跨功能分析用戶行為 |
| 💾 **節省儲存** | 不需要重複儲存用戶資訊 |
| 🔄 **即時同步** | 用戶資料更新立即反映在論壇 |

#### Schema 設計

```prisma
// 現有的 User model（已存在）
model User {
  id                Int      @id @default(autoincrement())
  email             String   @unique
  name              String
  role              String   @default("user")
  avatarUrl         String?
  
  // 論壇相關關聯（新增）
  posts             Post[]
  comments          Comment[]
  postLikes         PostLike[]
  commentLikes      CommentLike[]
  
  @@map("users")
}

model Post {
  authorId      Int
  author        User     @relation(fields: [authorId], references: [id])
  
  @@index([authorId])
}
```

#### 額外的用戶資料（選填）

如果需要論壇專屬的用戶設定：

```prisma
model ForumUserProfile {
  userId        Int      @id
  signature     String?  // 簽名檔
  title         String?  // 頭銜
  postCount     Int      @default(0)
  reputation    Int      @default(0)
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("forum_user_profiles")
}
```

---

### 4️⃣ 看板/分類管理

**建議：b) 動態管理（管理員可新增/編輯/刪除看板）** ✅

#### 理由

| 優點 | 說明 |
|------|------|
| 🔄 **靈活性高** | 可以根據社群發展調整分類 |
| 📊 **易於擴展** | 新增熱門話題看板不需要改程式碼 |
| 🎯 **精準管理** | 可以設定每個看板的權限和規則 |
| 📈 **數據驅動** | 根據使用情況調整看板結構 |
| 🔒 **權限控制** | 可以設定特定看板的存取限制 |

#### Schema 設計

```prisma
model Board {
  id            Int      @id @default(autoincrement())
  name          String   // 看板名稱
  slug          String   @unique // URL 友善的識別碼
  description   String?  // 看板描述
  icon          String?  // 圖示 URL
  color         String?  // 主題色
  order         Int      @default(0) // 排序
  isActive      Boolean  @default(true)
  
  // 權限設定
  isPublic      Boolean  @default(true) // 是否公開
  allowPost     String   @default("all") // 誰可以發文：all, member, admin
  allowComment  String   @default("all") // 誰可以回覆
  
  // 統計
  postCount     Int      @default(0)
  
  // 關聯
  parentId      Int?     // 父看板（支援子看板）
  parent        Board?   @relation("BoardHierarchy", fields: [parentId], references: [id])
  children      Board[]  @relation("BoardHierarchy")
  posts         Post[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([slug])
  @@index([isActive, order])
  @@map("boards")
}

model Post {
  boardId       Int
  board         Board    @relation(fields: [boardId], references: [id])
  
  @@index([boardId])
}
```

#### 管理 API

```typescript
// POST /api/admin/boards - 建立看板
// PATCH /api/admin/boards/:id - 編輯看板
// DELETE /api/admin/boards/:id - 刪除看板（軟刪除）
// PATCH /api/admin/boards/:id/order - 調整順序
```

---

### 5️⃣ 軟刪除 vs 硬刪除

**建議：a) 軟刪除（保留資料，標記為已刪除）** ✅

#### 理由

| 優點 | 說明 |
|------|------|
| 🔒 **資料安全** | 防止誤刪，可以恢復 |
| 📊 **審計追蹤** | 保留完整的操作記錄 |
| ⚖️ **法規遵循** | 符合資料保留政策 |
| 🔍 **內容審查** | 可以審查違規內容 |
| 📈 **數據分析** | 保留歷史資料用於分析 |

#### Schema 設計

```prisma
model Post {
  id            Int      @id @default(autoincrement())
  title         String
  content       Json
  
  // 軟刪除欄位
  isDeleted     Boolean  @default(false)
  deletedAt     DateTime?
  deletedBy     Int?     // 誰刪除的
  deleteReason  String?  // 刪除原因
  
  // 關聯
  deletedByUser User?    @relation("DeletedPosts", fields: [deletedBy], references: [id])
  
  @@index([isDeleted])
  @@map("posts")
}

model Comment {
  id            Int      @id @default(autoincrement())
  content       String
  
  // 軟刪除欄位
  isDeleted     Boolean  @default(false)
  deletedAt     DateTime?
  deletedBy     Int?
  deleteReason  String?
  
  @@index([isDeleted])
  @@map("comments")
}
```

#### 查詢處理

```typescript
// 一般查詢（不顯示已刪除）
const posts = await prisma.post.findMany({
  where: { isDeleted: false }
});

// 管理員查詢（包含已刪除）
const allPosts = await prisma.post.findMany();

// 恢復文章
await prisma.post.update({
  where: { id: postId },
  data: {
    isDeleted: false,
    deletedAt: null,
    deletedBy: null
  }
});
```

---

## 📋 完整資料庫 Schema 設計

基於以上決策，這是完整的論壇系統資料庫設計：

```prisma
// ============================================
// 論壇系統 Models
// ============================================

// 看板/分類
model Board {
  id            Int      @id @default(autoincrement())
  name          String
  slug          String   @unique
  description   String?
  icon          String?
  color         String?
  order         Int      @default(0)
  isActive      Boolean  @default(true)
  isPublic      Boolean  @default(true)
  allowPost     String   @default("all") // all, member, admin
  allowComment  String   @default("all")
  postCount     Int      @default(0)
  
  parentId      Int?
  parent        Board?   @relation("BoardHierarchy", fields: [parentId], references: [id])
  children      Board[]  @relation("BoardHierarchy")
  posts         Post[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([slug])
  @@index([isActive, order])
  @@map("boards")
}

// 文章
model Post {
  id            Int      @id @default(autoincrement())
  boardId       Int
  authorId      Int
  title         String
  content       Json     // 富文本 JSON
  contentText   String?  // 純文字（用於搜尋）
  contentHtml   String?  // HTML 快取
  
  // 狀態
  status        String   @default("published") // draft, published, locked, hidden
  isSticky      Boolean  @default(false) // 置頂
  isLocked      Boolean  @default(false) // 鎖定（不可回覆）
  
  // 統計
  viewCount     Int      @default(0)
  commentCount  Int      @default(0)
  likeCount     Int      @default(0)
  
  // 軟刪除
  isDeleted     Boolean  @default(false)
  deletedAt     DateTime?
  deletedBy     Int?
  deleteReason  String?
  
  // 時間戳
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  lastCommentAt DateTime @default(now())
  
  // 關聯
  board         Board    @relation(fields: [boardId], references: [id])
  author        User     @relation(fields: [authorId], references: [id])
  deletedByUser User?    @relation("DeletedPosts", fields: [deletedBy], references: [id])
  comments      Comment[]
  attachments   Attachment[]
  likes         PostLike[]
  tags          PostTag[]
  
  @@index([boardId, isDeleted, lastCommentAt])
  @@index([authorId])
  @@index([isDeleted, status])
  @@map("posts")
}

// 回覆
model Comment {
  id            Int      @id @default(autoincrement())
  postId        Int
  authorId      Int
  content       String   @db.Text
  
  // 回覆樓層
  parentId      Int?     // 回覆某則留言
  floor         Int      // 樓層號碼（第幾樓）
  
  // 統計
  likeCount     Int      @default(0)
  
  // 軟刪除
  isDeleted     Boolean  @default(false)
  deletedAt     DateTime?
  deletedBy     Int?
  deleteReason  String?
  
  // 時間戳
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // 關聯
  post          Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  author        User     @relation(fields: [authorId], references: [id])
  parent        Comment? @relation("CommentReplies", fields: [parentId], references: [id])
  replies       Comment[] @relation("CommentReplies")
  likes         CommentLike[]
  
  @@index([postId, isDeleted, floor])
  @@index([authorId])
  @@map("comments")
}

// 附件
model Attachment {
  id            Int      @id @default(autoincrement())
  postId        Int?
  userId        Int
  filename      String
  mimeType      String
  size          Int
  url           String
  thumbnailUrl  String?
  width         Int?
  height        Int?
  uploadedAt    DateTime @default(now())
  
  post          Post?    @relation(fields: [postId], references: [id], onDelete: Cascade)
  user          User     @relation(fields: [userId], references: [id])
  
  @@index([postId])
  @@index([userId])
  @@map("attachments")
}

// 文章按讚
model PostLike {
  id            Int      @id @default(autoincrement())
  postId        Int
  userId        Int
  createdAt     DateTime @default(now())
  
  post          Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user          User     @relation(fields: [userId], references: [id])
  
  @@unique([postId, userId])
  @@map("post_likes")
}

// 留言按讚
model CommentLike {
  id            Int      @id @default(autoincrement())
  commentId     Int
  userId        Int
  createdAt     DateTime @default(now())
  
  comment       Comment  @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user          User     @relation(fields: [userId], references: [id])
  
  @@unique([commentId, userId])
  @@map("comment_likes")
}

// 標籤
model Tag {
  id            Int      @id @default(autoincrement())
  name          String   @unique
  slug          String   @unique
  postCount     Int      @default(0)
  createdAt     DateTime @default(now())
  
  posts         PostTag[]
  
  @@map("tags")
}

// 文章標籤關聯
model PostTag {
  postId        Int
  tagId         Int
  
  post          Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  tag           Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)
  
  @@id([postId, tagId])
  @@map("post_tags")
}

// 論壇用戶資料（選填）
model ForumUserProfile {
  userId        Int      @id
  signature     String?  @db.Text
  title         String?
  postCount     Int      @default(0)
  commentCount  Int      @default(0)
  reputation    Int      @default(0)
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("forum_user_profiles")
}

// 更新現有 User model
model User {
  // ... 現有欄位 ...
  
  // 論壇關聯（新增）
  posts             Post[]
  deletedPosts      Post[]   @relation("DeletedPosts")
  comments          Comment[]
  attachments       Attachment[]
  postLikes         PostLike[]
  commentLikes      CommentLike[]
  forumProfile      ForumUserProfile?
}
```

---

## 🚀 API 端點規劃

### 公開 API

```typescript
// 看板
GET    /api/forum/boards              // 看板列表
GET    /api/forum/boards/:slug        // 看板詳情

// 文章
GET    /api/forum/posts               // 文章列表（可篩選看板）
GET    /api/forum/posts/:id           // 文章詳情
POST   /api/forum/posts               // 發表文章
PATCH  /api/forum/posts/:id           // 編輯文章
DELETE /api/forum/posts/:id           // 刪除文章

// 回覆
GET    /api/forum/posts/:id/comments  // 文章回覆列表
POST   /api/forum/posts/:id/comments  // 新增回覆
PATCH  /api/forum/comments/:id        // 編輯回覆
DELETE /api/forum/comments/:id        // 刪除回覆

// 按讚
POST   /api/forum/posts/:id/like      // 按讚文章
DELETE /api/forum/posts/:id/like      // 取消讚
POST   /api/forum/comments/:id/like   // 按讚回覆
DELETE /api/forum/comments/:id/like   // 取消讚

// 附件
POST   /api/forum/attachments          // 上傳附件
GET    /api/forum/attachments/:id      // 取得附件

// 標籤
GET    /api/forum/tags                 // 標籤列表
GET    /api/forum/tags/:slug           // 標籤文章列表
```

### 管理 API

```typescript
// 看板管理
POST   /api/admin/forum/boards         // 建立看板
PATCH  /api/admin/forum/boards/:id     // 編輯看板
DELETE /api/admin/forum/boards/:id     // 刪除看板
PATCH  /api/admin/forum/boards/order   // 調整順序

// 文章管理
GET    /api/admin/forum/posts          // 所有文章（含已刪除）
PATCH  /api/admin/forum/posts/:id/lock // 鎖定文章
PATCH  /api/admin/forum/posts/:id/sticky // 置頂文章
POST   /api/admin/forum/posts/:id/restore // 恢復文章

// 統計
GET    /api/admin/forum/stats          // 論壇統計
```

---

## 📊 索引優化建議

```sql
-- 文章查詢優化
CREATE INDEX idx_posts_board_active 
ON posts(board_id, is_deleted, last_comment_at DESC);

-- 熱門文章
CREATE INDEX idx_posts_popular 
ON posts(is_deleted, view_count DESC, like_count DESC);

-- 用戶文章
CREATE INDEX idx_posts_author 
ON posts(author_id, is_deleted, created_at DESC);

-- 全文搜尋（PostgreSQL）
CREATE INDEX idx_posts_fulltext 
ON posts USING gin(to_tsvector('chinese', content_text));
```

---

## 🔒 權限控制建議

```typescript
// 文章權限檢查
function canEditPost(user: User, post: Post): boolean {
  return user.id === post.authorId || user.role === 'admin';
}

function canDeletePost(user: User, post: Post): boolean {
  return user.id === post.authorId || user.role === 'admin';
}

function canPostInBoard(user: User, board: Board): boolean {
  if (board.allowPost === 'all') return true;
  if (board.allowPost === 'member') return user.id !== null;
  if (board.allowPost === 'admin') return user.role === 'admin';
  return false;
}
```

---

## ✅ 總結

### 設計決策

1. ✅ **富文本 JSON** - 靈活且安全
2. ✅ **獨立附件表** - 易於管理和追蹤
3. ✅ **關聯現有用戶** - 統一用戶系統
4. ✅ **動態看板管理** - 靈活可擴展
5. ✅ **軟刪除** - 資料安全可恢復

### 關鍵特性

- 📝 支援富文本編輯
- 📎 完整的附件管理
- 💬 多層回覆支援
- 👍 按讚/互動功能
- 🏷️ 標籤系統
- 📊 統計追蹤
- 🔒 權限控制
- 🗑️ 軟刪除機制

### 下一步

1. 確認前端是否同意以上設計
2. 開始實作資料庫 Schema
3. 實作核心 API（看板、文章、回覆）
4. 實作附件上傳
5. 實作按讚和互動功能
6. 實作管理後台

---

**完成時間**: 2025年10月23日  
**狀態**: ✅ 設計建議完成，等待前端確認  
**預計工作量**: 
- Schema 實作: 2-3 小時
- API 實作: 5-7 天
- 測試: 2-3 天

---

## 📞 聯絡資訊

如有任何問題或需要調整，請隨時討論！

