# 預測系統管理員 API 文檔

## 📋 目錄

1. [概述](#概述)
2. [認證方式](#認證方式)
3. [賽事管理 API](#賽事管理-api)
4. [預測結果判定 API](#預測結果判定-api)
5. [系統統計 API](#系統統計-api)
6. [獎勵計算規則](#獎勵計算規則)
7. [錯誤處理](#錯誤處理)
8. [使用範例](#使用範例)

---

## 概述

### 基礎資訊

- **基礎 URL**: `https://10.2.0.2:8080/api`
- **權限要求**: 所有管理員 API 都需要管理員權限
- **認證方式**: Bearer Token (JWT)
- **Content-Type**: `application/json`

### 主要功能

1. **賽事管理**: 建立、更新、刪除賽事，更新賽事結果
2. **預測結果判定**: 自動判定預測正確與否並發放獎勵
3. **系統統計**: 查看系統各項統計資訊

---

## 認證方式

### 1. 管理員登入

**端點**: `POST /api/auth/login`

**請求體**:
```json
{
  "email": "admin@sgame.com",
  "password": "Admin1234!@#"
}
```

**回應**:
```json
{
  "success": true,
  "message": "登入成功",
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user": {
    "id": 11,
    "email": "admin@sgame.com",
    "name": "管理員",
    "role": "admin"
  }
}
```

### 2. 使用Token

所有管理員 API 請求都需要在 Header 中帶上 Token:

```
Authorization: Bearer <token>
```

---

## 賽事管理 API

### 1. 建立賽事

**端點**: `POST /api/admin/games`

**請求體**:
```json
{
  "id": "20251115MLB001",
  "allianceId": 1,
  "gameDate": "2025-11-15",
  "gameTime": "19:00",
  "homeTeamName": "洛杉磯道奇",
  "awayTeamName": "舊金山巨人",
  "status": "scheduled",
  "gameMode": "international",
  "internationalOdds": {
    "spread": {
      "home": {"line": "-1.5", "odds": "1.90"},
      "away": {"line": "+1.5", "odds": "1.90"}
    },
    "total": {
      "over": {"line": "8.5", "odds": "1.90"},
      "under": {"line": "8.5", "odds": "1.90"}
    }
  }
}
```

**回應**:
```json
{
  "success": true,
  "message": "賽事已建立",
  "gameId": "20251115MLB001"
}
```

### 2. 更新賽事

**端點**: `PATCH /api/admin/games/:id`

**請求體**: (所有欄位皆為可選)
```json
{
  "gameTime": "20:00",
  "status": "live",
  "internationalOdds": {
    "spread": {
      "home": {"line": "-2.5", "odds": "1.95"}
    }
  }
}
```

**回應**:
```json
{
  "success": true,
  "message": "賽事已更新"
}
```

### 3. 更新賽事結果（自動判定）

**端點**: `PATCH /api/admin/games/:id/result`

**說明**: 
- 更新賽事最終比分
- 預設會自動判定所有相關預測結果並發放獎勵
- 可透過 `autoCalculate: false` 關閉自動判定

**請求體**:
```json
{
  "finalScoreHome": 5,
  "finalScoreAway": 3,
  "autoCalculate": true
}
```

**回應**:
```json
{
  "success": true,
  "message": "賽事結果已更新，預測已自動判定",
  "data": {
    "id": "20251115MLB001",
    "finalScoreHome": 5,
    "finalScoreAway": 3,
    "status": "finished",
    ...
  }
}
```

**參數說明**:
- `finalScoreHome` (必填, number): 主隊最終得分
- `finalScoreAway` (必填, number): 客隊最終得分
- `autoCalculate` (選填, boolean): 是否自動判定預測，預設為 `true`

**錯誤代碼**:
- `MISSING_FIELDS`: 缺少必填欄位
- `INVALID_SCORE`: 分數格式錯誤（必須為非負整數）
- `GAME_NOT_FOUND`: 賽事不存在

### 4. 刪除賽事

**端點**: `DELETE /api/admin/games/:id`

**回應**:
```json
{
  "success": true,
  "message": "賽事已刪除"
}
```

**注意**: 如果賽事已有預測，將無法刪除

---

## 預測結果判定 API

### 1. 批量計算預測結果

**端點**: `POST /api/admin/predictions/calculate-results`

**說明**:
- 批量判定預測結果並發放獎勵
- 可指定特定賽事或處理所有已完成賽事
- 支援強制重新計算

**請求體**:
```json
{
  "gameIds": ["20251115MLB001", "20251115MLB002"],
  "force": false
}
```

**參數說明**:
- `gameIds` (選填, array): 指定要處理的賽事ID列表，不提供則處理所有已完成賽事
- `force` (選填, boolean): 是否強制重新計算（包括已判定的預測），預設為 `false`

**回應**:
```json
{
  "success": true,
  "message": "預測結果計算完成",
  "data": {
    "summary": {
      "processed": 15,
      "wins": 8,
      "loses": 6,
      "cancelled": 1,
      "errors": 0
    },
    "details": {
      "totalProcessed": 15,
      "wins": 8,
      "loses": 6,
      "cancelled": 1,
      "errors": 0
    }
  }
}
```

### 2. 判定邏輯說明

#### 國際盤讓分 (international_spread)
- 主隊讓分: 實際得分差 > 讓分數 → win
- 客隊受讓: 實際得分差（取負） > 讓分數 → win

#### 國際盤大小分 (international_total)
- Over: 總分 > 盤口 → win
- Under: 總分 < 盤口 → win
- **和局**: 總分 = 盤口 → cancelled（退款）

#### 台灣盤獨贏 (taiwan_moneyline)
- 主隊: 主隊得分 > 客隊得分 → win
- 客隊: 客隊得分 > 主隊得分 → win

#### 台灣盤讓分/大小分
- 邏輯同國際盤

### 3. 獎勵發放流程

1. **判定結果** → `win` / `lose` / `cancelled`

2. **預測正確 (win)**:
   - 計算獎勵金額
   - 更新用戶彩幣餘額
   - 記錄交易 (`earn` 類型)
   - 更新預測狀態為 `win`

3. **預測錯誤 (lose)**:
   - 不發放獎勵
   - 更新預測狀態為 `lose`

4. **預測取消 (cancelled)**:
   - 退還預測費用
   - 記錄交易 (`earn` 類型，原因為退款)
   - 更新預測狀態為 `cancelled`

### 4. 查看預測列表（管理後台）

**端點**: `GET /api/admin/predictions`

**查詢參數**:
- `userId` (選填): 篩選特定用戶
- `gameId` (選填): 篩選特定賽事
- `status` (選填): 篩選特定狀態 (pending/win/lose/cancelled)
- `page` (選填): 頁碼，預設 1
- `size` (選填): 每頁筆數，預設 20

**回應**:
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "userId": 27,
      "userName": "測試用戶",
      "gameId": "20251115MLB001",
      "predictionType": "international_spread",
      "selection": "home",
      "odds": "1.90",
      "price": 100,
      "status": "win",
      "purchaseCount": 3,
      "createdAt": "2025-10-23T10:00:00.000Z"
    }
  ],
  "pagination": {
    "page": 1,
    "size": 20,
    "total": 150
  }
}
```

---

## 系統統計 API

### 1. 取得系統統計

**端點**: `GET /api/admin/stats`

**回應**:
```json
{
  "success": true,
  "stats": {
    "users": {
      "total": 1250
    },
    "games": {
      "total": 850,
      "scheduled": 120,
      "live": 5,
      "finished": 725
    },
    "predictions": {
      "total": 5420,
      "pending": 380,
      "win": 2150,
      "lose": 2890
    },
    "purchases": {
      "total": 1850
    },
    "coins": {
      "totalBalance": 125000,
      "totalEarned": 95000,
      "totalSpent": 170000,
      "transactions": 8520
    }
  }
}
```

### 2. 取得聯盟列表

**端點**: `GET /api/admin/alliances`

**回應**:
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "code": "MLB",
      "nameZh": "美國職棒大聯盟",
      "nameEn": "Major League Baseball",
      "sportType": "baseball"
    }
  ]
}
```

---

## 獎勵計算規則

### 當前配置

```javascript
{
  baseMultiplier: 1.5,  // 基礎倍數
  useOdds: false,       // 是否使用賠率計算
  minReward: 50,        // 最小獎勵
  maxReward: 10000      // 最大獎勵
}
```

### 計算公式

#### 固定倍數模式 (useOdds = false)
```
獎勵 = floor(預測價格 × 基礎倍數)
獎勵 = max(最小獎勵, min(獎勵, 最大獎勵))
```

**範例**:
- 預測價格 100 → 獎勵 150 彩幣
- 預測價格 50 → 獎勵 75，但不低於 50，所以獎勵 50 彩幣

#### 賠率計算模式 (useOdds = true)
```
獎勵 = floor(預測價格 × 賠率)
獎勵 = max(最小獎勵, min(獎勵, 最大獎勵))
```

**範例**:
- 預測價格 100，賠率 1.90 → 獎勵 190 彩幣

---

## 錯誤處理

### 錯誤代碼列表

| 錯誤代碼 | HTTP Status | 說明 |
|---------|-------------|------|
| `MISSING_FIELDS` | 400 | 缺少必填欄位 |
| `INVALID_SCORE` | 400 | 分數格式錯誤 |
| `GAME_NOT_FOUND` | 404 | 賽事不存在 |
| `UNAUTHORIZED` | 401 | 未登入 |
| `FORBIDDEN` | 403 | 無管理員權限 |
| `INTERNAL_ERROR` | 500 | 伺服器內部錯誤 |

### 錯誤回應格式

```json
{
  "success": false,
  "message": "錯誤訊息",
  "code": "ERROR_CODE"
}
```

---

## 使用範例

### 完整工作流程

#### 1. 管理員登入

```bash
curl -k -X POST "https://10.2.0.2:8080/api/auth/login" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "admin@sgame.com",
    "password": "Admin1234!@#"
  }'
```

#### 2. 建立賽事

```bash
curl -k -X POST "https://10.2.0.2:8080/api/admin/games" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <token>" \
  -d '{
    "id": "20251115MLB001",
    "allianceId": 1,
    "gameDate": "2025-11-15",
    "gameTime": "19:00",
    "homeTeamName": "洛杉磯道奇",
    "awayTeamName": "舊金山巨人",
    "status": "scheduled",
    "gameMode": "international",
    "internationalOdds": {
      "spread": {
        "home": {"line": "-1.5", "odds": "1.90"},
        "away": {"line": "+1.5", "odds": "1.90"}
      }
    }
  }'
```

#### 3. 用戶建立預測

(由普通用戶執行，此處略過)

#### 4. 更新賽事結果並自動判定

```bash
curl -k -X PATCH "https://10.2.0.2:8080/api/admin/games/20251115MLB001/result" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <token>" \
  -d '{
    "finalScoreHome": 5,
    "finalScoreAway": 3,
    "autoCalculate": true
  }'
```

#### 5. 查看統計

```bash
curl -k -X GET "https://10.2.0.2:8080/api/admin/stats" \
  -H "Authorization: Bearer <token>"
```

#### 6. 批量重新計算（如需要）

```bash
curl -k -X POST "https://10.2.0.2:8080/api/admin/predictions/calculate-results" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <token>" \
  -d '{
    "gameIds": ["20251115MLB001"],
    "force": true
  }'
```

### JavaScript/TypeScript 範例

```typescript
// 管理員 API 客戶端類別
class AdminAPIClient {
  private baseUrl: string;
  private token: string | null = null;

  constructor(baseUrl: string) {
    this.baseUrl = baseUrl;
  }

  // 登入
  async login(email: string, password: string) {
    const response = await fetch(`${this.baseUrl}/api/auth/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password })
    });
    
    const data = await response.json();
    if (data.success) {
      this.token = data.token;
    }
    return data;
  }

  // 更新賽事結果
  async updateGameResult(
    gameId: string,
    finalScoreHome: number,
    finalScoreAway: number,
    autoCalculate: boolean = true
  ) {
    const response = await fetch(
      `${this.baseUrl}/api/admin/games/${gameId}/result`,
      {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${this.token}`
        },
        body: JSON.stringify({
          finalScoreHome,
          finalScoreAway,
          autoCalculate
        })
      }
    );
    
    return await response.json();
  }

  // 批量計算預測結果
  async calculatePredictionResults(
    gameIds?: string[],
    force: boolean = false
  ) {
    const response = await fetch(
      `${this.baseUrl}/api/admin/predictions/calculate-results`,
      {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${this.token}`
        },
        body: JSON.stringify({ gameIds, force })
      }
    );
    
    return await response.json();
  }

  // 取得系統統計
  async getStats() {
    const response = await fetch(
      `${this.baseUrl}/api/admin/stats`,
      {
        headers: {
          'Authorization': `Bearer ${this.token}`
        }
      }
    );
    
    return await response.json();
  }
}

// 使用範例
const admin = new AdminAPIClient('https://10.2.0.2:8080');

// 登入
await admin.login('admin@sgame.com', 'Admin1234!@#');

// 更新賽事結果並自動判定
const result = await admin.updateGameResult(
  '20251115MLB001',
  5,
  3,
  true
);

console.log(result);
```

---

## 測試指南

### 測試流程

1. **準備環境**
   - 確保數據庫中有測試賽事
   - 確保有用戶建立的預測

2. **測試賽事結果更新**
   - 使用管理員帳號登入
   - 更新賽事結果（主隊得分、客隊得分）
   - 檢查回應是否包含 `autoCalculate` 成功訊息

3. **驗證預測判定**
   - 查詢預測狀態是否更新為 win/lose/cancelled
   - 查詢用戶彩幣餘額是否正確增加
   - 查詢彩幣交易記錄是否有對應紀錄

4. **測試批量計算**
   - 使用 `force: true` 重新計算
   - 驗證統計數據是否正確

### 測試資料

可使用提供的測試腳本:
- `/home/gogofire1774/test-result-calculation-simple.sh`

---

## 注意事項

1. **自動判定時機**
   - 更新賽事結果時，預設會自動觸發判定
   - 只處理 `status = 'pending'` 的預測
   - 已判定的預測需使用 `force: true` 才會重新計算

2. **事務處理**
   - 預測狀態更新和獎勵發放在同一事務中
   - 確保數據一致性

3. **錯誤處理**
   - 單個預測判定失敗不會影響其他預測
   - 錯誤會記錄在日誌中

4. **效能考量**
   - 批量計算時建議指定 `gameIds`
   - 避免頻繁使用 `force: true`

---

## 更新日誌

- **2025-10-23**: 初始版本，實作預測結果自動判定與獎勵發放功能

