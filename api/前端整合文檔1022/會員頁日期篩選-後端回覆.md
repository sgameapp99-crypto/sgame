# 會員頁日期篩選功能 - 後端實作完成回覆

**日期**: 2025年10月22日  
**狀態**: ✅ **已完成並測試**

---

## 📋 實作概要

後端已按照前端需求文件實作 `startDate` 和 `endDate` 參數支援，允許會員頁面進行靈活的日期範圍篩選。

---

## ✅ 已實作功能

### 新增參數

| 參數名 | 類型 | 必填 | 說明 | 範例值 |
|--------|------|------|------|--------|
| `startDate` | string | 否 | 開始日期（YYYY-MM-DD 格式） | `"2025-10-22"` |
| `endDate` | string | 否 | 結束日期（YYYY-MM-DD 格式） | `"2025-10-29"` |

### 日期篩選邏輯

```typescript
// 1. 兩者都提供：返回 startDate <= gameDate <= endDate 的預測
GET /api/predictions?memberId=123&startDate=2025-10-22&endDate=2025-10-29

// 2. 只提供 startDate：返回 gameDate >= startDate 的所有預測（全部未來）
GET /api/predictions?memberId=123&startDate=2025-10-22

// 3. 只提供 endDate：返回 gameDate <= endDate 的所有預測
GET /api/predictions?memberId=123&endDate=2025-10-29
```

### 向後兼容性

✅ 保留了原有的 `dateRange` 參數（`today`, `week`, `month`, `all`）
✅ 新舊參數可以共存，優先使用 `startDate`/`endDate`

---

## ⚠️ 重要：參數名稱說明

### 使用 `memberId` 而非 `userId`

為了與現有 API 保持一致性，**預測列表 API 使用 `memberId` 作為用戶篩選參數**。

**原因**：
1. 現有系統中，`userId` 通常表示當前登入用戶（從 session/token 取得）
2. `memberId` 表示要查詢的目標會員 ID（可能是自己或其他會員）
3. 這樣的命名避免了邏輯上的混淆

**前端需要調整**：

```diff
# 前端需求文件中的範例
- GET /api/predictions?userId=user123&startDate=2025-10-22
+ GET /api/predictions?memberId=123&startDate=2025-10-22
```

**實際使用場景**：

```javascript
// 查詢當前用戶自己的預測
const myPredictions = await api.get('/api/predictions', {
  params: {
    memberId: currentUser.id,  // 使用 memberId，不是 userId
    startDate: '2025-10-22',
    endDate: '2025-10-29'
  }
});

// 查詢其他會員的預測（如果有權限）
const otherPredictions = await api.get('/api/predictions', {
  params: {
    memberId: 456,  // 查詢其他會員
    startDate: '2025-10-22'
  }
});
```

---

## 📊 三種使用場景

### 場景 1：一週內

**前端傳入**：
```http
GET /api/predictions?memberId=123&startDate=2025-10-22&endDate=2025-10-29
```

**後端行為**：
- 篩選 `gameDate >= '2025-10-22' AND gameDate <= '2025-10-29'` 的預測
- 返回符合條件的預測列表

**回應範例**：
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "userId": 123,
      "userName": "張三",
      "gameId": "20251024TEST007",
      "gameInfo": {
        "allianceId": 2,
        "allianceName": "NBA",
        "gameDate": "2025-10-24",
        "gameTime": "19:30",
        "homeTeam": "洛杉磯湖人",
        "awayTeam": "金州勇士"
      },
      "predictionType": "international_spread",
      "predictionTypeLabel": "國際盤讓分",
      "odds": "1.90",
      "price": 100,
      "status": "pending"
    }
  ],
  "pagination": {
    "page": 1,
    "size": 20,
    "total": 5
  }
}
```

### 場景 2：一個月內

**前端傳入**：
```http
GET /api/predictions?memberId=123&startDate=2025-10-22&endDate=2025-11-21
```

**後端行為**：
- 篩選 `gameDate >= '2025-10-22' AND gameDate <= '2025-11-21'` 的預測

### 場景 3：全部（最重要）⭐

**前端傳入**：
```http
GET /api/predictions?memberId=123&startDate=2025-10-22
```

**關鍵**：不傳 `endDate` 參數

**後端行為**：
- 篩選 `gameDate >= '2025-10-22'` 的所有預測
- **不限制結束日期**，返回所有未來預測

**這正是前端「全部」選項需要的行為** ✅

---

## 🔍 錯誤處理

### 1. 日期格式錯誤（HTTP 400）

**請求**：
```http
GET /api/predictions?memberId=123&startDate=2025/10/22
```

**回應**：
```json
{
  "success": false,
  "message": "開始日期格式錯誤，請使用 YYYY-MM-DD 格式",
  "code": "INVALID_DATE_FORMAT"
}
```

### 2. 日期範圍錯誤（HTTP 400）

**請求**：
```http
GET /api/predictions?memberId=123&startDate=2025-10-29&endDate=2025-10-22
```

**回應**：
```json
{
  "success": false,
  "message": "開始日期不能大於結束日期",
  "code": "INVALID_DATE_RANGE"
}
```

### 3. 無數據（HTTP 200）

**請求**：
```http
GET /api/predictions?memberId=123&startDate=2025-12-01&endDate=2025-12-31
```

**回應**：
```json
{
  "success": true,
  "data": [],
  "pagination": {
    "page": 1,
    "size": 20,
    "total": 0
  }
}
```

---

## 🧪 測試範例

### 使用 curl 測試

```bash
# 1. 登入獲取 cookie
curl -k -c cookies.txt -X POST https://10.2.0.2:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"testpred@example.com","password":"Pred1234!@#"}'

# 2. 測試一週內
curl -k -b cookies.txt "https://10.2.0.2:8080/api/predictions?memberId=5&startDate=2025-10-22&endDate=2025-10-29"

# 3. 測試全部（不傳 endDate）
curl -k -b cookies.txt "https://10.2.0.2:8080/api/predictions?memberId=5&startDate=2025-10-22"

# 4. 測試日期格式錯誤
curl -k -b cookies.txt "https://10.2.0.2:8080/api/predictions?memberId=5&startDate=2025/10/22"

# 5. 測試日期範圍錯誤
curl -k -b cookies.txt "https://10.2.0.2:8080/api/predictions?memberId=5&startDate=2025-10-29&endDate=2025-10-22"
```

### 使用 JavaScript/TypeScript

```typescript
// API 服務層
export const predictionsAPI = {
  async getPredictions(params: {
    memberId: number;      // 使用 memberId，不是 userId
    startDate?: string;
    endDate?: string;
    allianceId?: number;
    page?: number;
    size?: number;
  }) {
    const response = await axios.get('/api/predictions', { params });
    return response.data;
  }
};

// 使用範例
// 一週內
const weekData = await predictionsAPI.getPredictions({
  memberId: currentUser.id,
  startDate: '2025-10-22',
  endDate: '2025-10-29'
});

// 全部
const allData = await predictionsAPI.getPredictions({
  memberId: currentUser.id,
  startDate: '2025-10-22'
  // 不傳 endDate
});
```

---

## 📋 完整參數列表

| 參數名 | 類型 | 必填 | 說明 | 預設值 |
|--------|------|------|------|--------|
| `memberId` | number | 否* | 要查詢的會員 ID | 無 |
| `startDate` | string | 否 | 開始日期 (YYYY-MM-DD) | 無 |
| `endDate` | string | 否 | 結束日期 (YYYY-MM-DD) | 無 |
| `allianceId` | number | 否 | 聯盟 ID | 無 |
| `status` | string | 否 | 狀態 (pending, win, lose, cancelled) | 無 |
| `gameMode` | string | 否 | 盤口類型 (international, taiwan) | 無 |
| `page` | number | 否 | 頁碼 | 1 |
| `size` | number | 否 | 每頁筆數 | 20 |

*註：`memberId` 在會員頁面通常是必填的，但 API 層面不強制

---

## 🔄 結合其他篩選條件

所有參數可以自由組合：

```http
# 查詢特定聯盟 + 日期範圍
GET /api/predictions?memberId=123&allianceId=1&startDate=2025-10-22&endDate=2025-10-29

# 查詢特定狀態 + 日期範圍
GET /api/predictions?memberId=123&status=pending&startDate=2025-10-22

# 查詢特定盤口類型 + 日期範圍
GET /api/predictions?memberId=123&gameMode=international&startDate=2025-10-22&endDate=2025-10-29
```

---

## ✅ 驗收確認

- [x] 1. API 端點已部署到測試環境（https://10.2.0.2:8080）
- [x] 2. 測試環境可正常訪問
- [x] 3. 測試用 memberId: 5 (testpred@example.com)
- [x] 4. 三種場景（一週內、一個月內、全部）都能正確返回資料
- [x] 5. 分頁功能正常
- [x] 6. 錯誤處理（參數驗證、錯誤碼）符合文件規範

---

## 📝 前端調整建議

### 必須調整

1. **參數名稱**：將 `userId` 改為 `memberId`
   ```typescript
   // Before
   const params = { userId: currentUser.id, ... };
   
   // After
   const params = { memberId: currentUser.id, ... };
   ```

### 建議調整

2. **錯誤處理**：根據返回的 `code` 欄位顯示友善提示
   ```typescript
   if (!response.success) {
     switch (response.code) {
       case 'INVALID_DATE_FORMAT':
         showError('日期格式錯誤');
         break;
       case 'INVALID_DATE_RANGE':
         showError('開始日期不能大於結束日期');
         break;
     }
   }
   ```

---

## 💡 補充說明

### 時區處理

- 日期格式為 `YYYY-MM-DD`（不含時間和時區）
- 後端按照賽事當地日期進行比較
- 前端傳入的日期應該是用戶當地時區的日期

### 排序

- 預測列表預設按 `createdAt` 降序排列（最新的在前）
- 可以考慮未來新增 `sortBy` 和 `sortOrder` 參數

### 效能

- 已在 `gameDate` 欄位上建立索引
- 日期範圍查詢效能良好
- 建議前端實作虛擬滾動處理大量數據

---

## 📞 聯絡資訊

如有任何疑問或需要進一步說明：

- **後端負責人**: 後端團隊
- **測試環境**: https://10.2.0.2:8080
- **文檔位置**: `/api文檔/前端整合文檔1022/`

---

## 📚 相關文檔

- [預測系統使用說明](./預測系統使用說明.md)
- [測試資料使用說明](./測試資料使用說明.md)
- [後端確認回覆](./後端確認回覆.md)
- [錯誤代碼修復報告](./錯誤代碼修復報告.md)

---

**實作完成日期**: 2025年10月22日  
**文檔版本**: v1.0  
**狀態**: ✅ 已完成並可供前端整合

