# é ­åƒåŠŸèƒ½æ•´åˆèªªæ˜

**æ›´æ–°æ—¥æœŸ**: 2025-10-21  
**åŠŸèƒ½**: ç”¨æˆ¶é ­åƒä¸Šå‚³èˆ‡é¡¯ç¤º

---

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

ç”¨æˆ¶å¯ä»¥ä¸Šå‚³è‡ªå·±çš„é ­åƒåœ–ç‰‡ï¼Œå…¶ä»–ç”¨æˆ¶å¯ä»¥åœ¨æœƒå“¡è³‡æ–™ä¸­çœ‹åˆ°è©²é ­åƒã€‚

### æ”¯æ´çš„æ ¼å¼
- JPG / JPEG
- PNG
- WEBP

### æª”æ¡ˆé™åˆ¶
- æœ€å¤§æª”æ¡ˆå¤§å°ï¼š5MB
- å„²å­˜ä½ç½®ï¼šDocker volume (`uploads_data`)

---

## ğŸš€ API ä½¿ç”¨

### 1. ä¸Šå‚³é ­åƒ

**ç«¯é»**: `POST /api/me/avatar`  
**éœ€è¦èªè­‰**: æ˜¯ï¼ˆéœ€è¦ç™»å…¥ï¼‰  
**Content-Type**: `multipart/form-data`

#### è«‹æ±‚ç¯„ä¾‹

```javascript
// ä½¿ç”¨ FormData ä¸Šå‚³
const formData = new FormData();
formData.append('avatar', fileInput.files[0]); // 'avatar' æ˜¯æ¬„ä½åç¨±

const response = await fetch('https://10.2.0.2:8080/api/me/avatar', {
  method: 'POST',
  credentials: 'include', // é‡è¦ï¼åŒ…å« cookie
  body: formData,
  // æ³¨æ„ï¼šä¸è¦è¨­ç½® Content-Typeï¼Œè®“ç€è¦½å™¨è‡ªå‹•è¨­ç½®
});

const data = await response.json();
```

#### æˆåŠŸéŸ¿æ‡‰ (200)

```json
{
  "success": true,
  "url": "/uploads/avatars/2-1761063369513.jpg",
  "updatedAt": "2025-10-21T16:16:09.516Z"
}
```

#### éŒ¯èª¤éŸ¿æ‡‰

**æœªç™»å…¥ (401)**:
```json
{
  "success": false,
  "message": "ç¼ºå°‘èªè­‰è³‡è¨Š"
}
```

**æœªä¸Šå‚³æª”æ¡ˆ (400)**:
```json
{
  "success": false,
  "message": "æœªä¸Šå‚³æª”æ¡ˆ"
}
```

**æª”æ¡ˆéå¤§ (413)**:
```json
{
  "success": false,
  "message": "æª”æ¡ˆéå¤§ï¼Œæœ€å¤§å…è¨± 5MB",
  "code": "FILE_TOO_LARGE"
}
```

**ä¸æ”¯æ´çš„æª”æ¡ˆé¡å‹ (415)**:
```json
{
  "success": false,
  "message": "ä¸æ”¯æ´çš„æª”æ¡ˆé¡å‹ï¼Œåªå…è¨± JPG, PNG, WEBP åœ–ç‰‡",
  "code": "INVALID_FILE_TYPE"
}
```

---

## ğŸ–¼ï¸ é¡¯ç¤ºé ­åƒ

### 2. ç²å–æœƒå“¡è³‡æ–™ï¼ˆåŒ…å«é ­åƒï¼‰

**ç«¯é»**: `GET /api/members/{id}/profile`  
**éœ€è¦èªè­‰**: å¦ï¼ˆå…¬é–‹ç«¯é»ï¼‰

#### è«‹æ±‚ç¯„ä¾‹

```javascript
const response = await fetch('https://10.2.0.2:8080/api/members/2/profile', {
  credentials: 'include',
});

const data = await response.json();
console.log(data.profile.avatarUrl);
// è¼¸å‡º: "/uploads/avatars/2-1761063369513.jpg"
```

#### éŸ¿æ‡‰æ ¼å¼

```json
{
  "success": true,
  "profile": {
    "id": 2,
    "email": "user@example.com",
    "name": "Test User",
    "avatarUrl": "/uploads/avatars/2-1761063369513.jpg",
    "emailVerified": true,
    "createdAt": "2025-10-21T10:00:00.000Z",
    "updatedAt": "2025-10-21T16:16:09.516Z",
    "level": "bronze",
    "score": 0,
    // ... å…¶ä»–æ¬„ä½
  },
  "relationships": {
    // ...
  }
}
```

### avatarUrl èªªæ˜

- **æ ¼å¼**: ç›¸å°è·¯å¾‘ï¼Œä¾‹å¦‚ `/uploads/avatars/2-1761063369513.jpg`
- **å¦‚æœç”¨æˆ¶æ²’æœ‰ä¸Šå‚³é ­åƒ**: `null`
- **å‰ç«¯éœ€è¦çµ„åˆå®Œæ•´ URL**: `API_BASE_URL + avatarUrl`

---

## ğŸ’» å‰ç«¯æ•´åˆç¯„ä¾‹

### React ç¯„ä¾‹

#### 1. é ­åƒä¸Šå‚³çµ„ä»¶

```jsx
import { useState } from 'react';

function AvatarUpload() {
  const [uploading, setUploading] = useState(false);
  const [avatarUrl, setAvatarUrl] = useState(null);
  const API_BASE = 'https://10.2.0.2:8080';

  const handleUpload = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    // é©—è­‰æª”æ¡ˆå¤§å°
    if (file.size > 5 * 1024 * 1024) {
      alert('æª”æ¡ˆéå¤§ï¼Œæœ€å¤§ 5MB');
      return;
    }

    // é©—è­‰æª”æ¡ˆé¡å‹
    if (!['image/jpeg', 'image/png', 'image/webp'].includes(file.type)) {
      alert('åªæ”¯æ´ JPGã€PNGã€WEBP æ ¼å¼');
      return;
    }

    setUploading(true);

    try {
      const formData = new FormData();
      formData.append('avatar', file);

      const response = await fetch(`${API_BASE}/api/me/avatar`, {
        method: 'POST',
        credentials: 'include',
        body: formData,
      });

      const data = await response.json();

      if (data.success) {
        setAvatarUrl(data.url);
        alert('é ­åƒä¸Šå‚³æˆåŠŸï¼');
      } else {
        alert(`ä¸Šå‚³å¤±æ•—ï¼š${data.message}`);
      }
    } catch (error) {
      console.error('ä¸Šå‚³éŒ¯èª¤:', error);
      alert('ä¸Šå‚³å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    } finally {
      setUploading(false);
    }
  };

  return (
    <div>
      <input
        type="file"
        accept="image/jpeg,image/png,image/webp"
        onChange={handleUpload}
        disabled={uploading}
      />
      {uploading && <p>ä¸Šå‚³ä¸­...</p>}
      {avatarUrl && (
        <img
          src={`${API_BASE}${avatarUrl}`}
          alt="Avatar"
          style={{ width: 100, height: 100, borderRadius: '50%' }}
        />
      )}
    </div>
  );
}
```

#### 2. é¡¯ç¤ºæœƒå“¡é ­åƒçµ„ä»¶

```jsx
function MemberAvatar({ userId }) {
  const [profile, setProfile] = useState(null);
  const API_BASE = 'https://10.2.0.2:8080';
  const DEFAULT_AVATAR = '/default-avatar.png'; // é è¨­é ­åƒ

  useEffect(() => {
    fetch(`${API_BASE}/api/members/${userId}/profile`, {
      credentials: 'include',
    })
      .then(res => res.json())
      .then(data => setProfile(data.profile))
      .catch(err => console.error(err));
  }, [userId]);

  if (!profile) return <div>è¼‰å…¥ä¸­...</div>;

  const avatarSrc = profile.avatarUrl
    ? `${API_BASE}${profile.avatarUrl}`
    : DEFAULT_AVATAR;

  return (
    <div>
      <img
        src={avatarSrc}
        alt={profile.name}
        style={{ width: 50, height: 50, borderRadius: '50%' }}
        onError={(e) => {
          e.target.src = DEFAULT_AVATAR; // è¼‰å…¥å¤±æ•—æ™‚ä½¿ç”¨é è¨­é ­åƒ
        }}
      />
      <span>{profile.name}</span>
    </div>
  );
}
```

### Vue ç¯„ä¾‹

#### 1. é ­åƒä¸Šå‚³çµ„ä»¶

```vue
<template>
  <div>
    <input
      type="file"
      accept="image/jpeg,image/png,image/webp"
      @change="handleUpload"
      :disabled="uploading"
    />
    <p v-if="uploading">ä¸Šå‚³ä¸­...</p>
    <img
      v-if="avatarUrl"
      :src="`${apiBase}${avatarUrl}`"
      alt="Avatar"
      style="width: 100px; height: 100px; border-radius: 50%;"
    />
  </div>
</template>

<script>
export default {
  data() {
    return {
      apiBase: 'https://10.2.0.2:8080',
      uploading: false,
      avatarUrl: null,
    };
  },
  methods: {
    async handleUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      if (file.size > 5 * 1024 * 1024) {
        alert('æª”æ¡ˆéå¤§ï¼Œæœ€å¤§ 5MB');
        return;
      }

      this.uploading = true;

      try {
        const formData = new FormData();
        formData.append('avatar', file);

        const response = await fetch(`${this.apiBase}/api/me/avatar`, {
          method: 'POST',
          credentials: 'include',
          body: formData,
        });

        const data = await response.json();

        if (data.success) {
          this.avatarUrl = data.url;
          alert('é ­åƒä¸Šå‚³æˆåŠŸï¼');
        } else {
          alert(`ä¸Šå‚³å¤±æ•—ï¼š${data.message}`);
        }
      } catch (error) {
        console.error('ä¸Šå‚³éŒ¯èª¤:', error);
        alert('ä¸Šå‚³å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      } finally {
        this.uploading = false;
      }
    },
  },
};
</script>
```

---

## ğŸ”§ æŠ€è¡“ç´°ç¯€

### æª”æ¡ˆå‘½åè¦å‰‡

ä¸Šå‚³çš„æª”æ¡ˆæœƒè‡ªå‹•é‡å‘½åç‚ºï¼š
```
{userId}-{timestamp}{extension}
```

ç¯„ä¾‹ï¼š
- ç”¨æˆ¶ ID: 2
- æ™‚é–“æˆ³: 1761063369513
- å‰¯æª”å: .jpg
- çµæœ: `2-1761063369513.jpg`

### å„²å­˜ä½ç½®

- **Docker å…§éƒ¨**: `/app/uploads/avatars/`
- **Docker Volume**: `uploads_data`
- **å­˜å– URL**: `https://10.2.0.2:8080/uploads/avatars/{filename}`

### CORS è¨­å®š

å¾Œç«¯å·²é…ç½® CORSï¼Œå…è¨±ï¼š
- å‰ç«¯åŸŸåï¼š`http://localhost:3000`ï¼ˆé–‹ç™¼ç’°å¢ƒï¼‰
- Credentials: å…è¨±ï¼ˆå¯ä»¥ç™¼é€ cookieï¼‰

---

## âš ï¸ æ³¨æ„äº‹é …

### 1. èªè­‰è¦æ±‚

ä¸Šå‚³é ­åƒ**å¿…é ˆç™»å…¥**ï¼Œè«‹ç¢ºä¿ï¼š
```javascript
fetch(url, {
  credentials: 'include', // å¿…é ˆåŒ…å«ï¼
  // ...
});
```

### 2. Content-Type

ä¸Šå‚³æ™‚**ä¸è¦æ‰‹å‹•è¨­ç½®** `Content-Type`ï¼Œè®“ç€è¦½å™¨è‡ªå‹•è¨­ç½®ï¼š

```javascript
// âœ… æ­£ç¢º
fetch(url, {
  body: formData,
  // ä¸è¨­ç½® headers
});

// âŒ éŒ¯èª¤
fetch(url, {
  headers: {
    'Content-Type': 'multipart/form-data', // ä¸è¦é€™æ¨£åšï¼
  },
  body: formData,
});
```

### 3. æª”æ¡ˆå¤§å°é™åˆ¶

- å‰ç«¯æ‡‰è©²å…ˆé©—è­‰æª”æ¡ˆå¤§å°ï¼ˆ5MBï¼‰
- å¾Œç«¯æœƒå†æ¬¡é©—è­‰ä¸¦è¿”å› 413 éŒ¯èª¤

### 4. é è¨­é ­åƒ

ç”¨æˆ¶å¯èƒ½æ²’æœ‰ä¸Šå‚³é ­åƒï¼ˆ`avatarUrl` ç‚º `null`ï¼‰ï¼Œå‰ç«¯æ‡‰è©²ï¼š
- é¡¯ç¤ºé è¨­é ­åƒ
- æˆ–é¡¯ç¤ºç”¨æˆ¶åç¨±çš„é¦–å­—æ¯

### 5. éŒ¯èª¤è™•ç†

åœ–ç‰‡è¼‰å…¥å¯èƒ½å¤±æ•—ï¼Œå»ºè­°æ·»åŠ  `onError` è™•ç†ï¼š

```jsx
<img
  src={avatarUrl}
  onError={(e) => {
    e.target.src = '/default-avatar.png';
  }}
/>
```

### 6. èˆŠé ­åƒæ¸…ç†

- ä¸Šå‚³æ–°é ­åƒæ™‚ï¼ŒèˆŠé ­åƒ**ä¸æœƒè‡ªå‹•åˆªé™¤**
- è³‡æ–™åº«æœƒæ›´æ–°ç‚ºæ–°çš„ `avatarUrl`
- Docker volume ä¸­æœƒä¿ç•™æ‰€æœ‰ä¸Šå‚³çš„æª”æ¡ˆ

---

## ğŸ§ª æ¸¬è©¦

### æ¸¬è©¦ä¸Šå‚³åŠŸèƒ½

```bash
# ä½¿ç”¨æ¸¬è©¦è…³æœ¬
cd /home/gogofire1774
./script/test-avatar-upload.sh
```

### æ‰‹å‹•æ¸¬è©¦

```bash
# 1. ç™»å…¥ç²å– cookie
curl -k -X POST https://10.2.0.2:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"Test1234!"}' \
  -c cookies.txt

# 2. ä¸Šå‚³é ­åƒ
curl -k -X POST https://10.2.0.2:8080/api/me/avatar \
  -b cookies.txt \
  -F "avatar=@/path/to/image.jpg"

# 3. ç²å–æœƒå“¡è³‡æ–™ç¢ºèª
curl -k https://10.2.0.2:8080/api/members/1/profile | jq '.profile.avatarUrl'

# 4. è¨ªå•åœ–ç‰‡
curl -k https://10.2.0.2:8080/uploads/avatars/1-1234567890.jpg -o test.jpg
```

---

## ğŸ“š ç›¸é—œæ–‡æª”

- **API æ¸¬è©¦æ¸…å–®**: `/apiæ–‡æª”/API-Check.md`
- **é ­åƒä¸Šå‚³å¯¦ä½œå ±å‘Š**: `/apiæ–‡æª”/é ­åƒä¸Šå‚³åŠŸèƒ½å¯¦ä½œå ±å‘Š.md`
- **å®Œæ•´ API æ–‡æª”**: `/apiæ–‡æª”/å‰ç«¯æ•´åˆæ–‡æª”/å®Œæ•´äº¤ä»˜æ¸…å–®.md`

---

## ğŸ¯ å¿«é€Ÿåƒè€ƒ

### API ç«¯é»
```
POST   /api/me/avatar              ä¸Šå‚³é ­åƒï¼ˆéœ€ç™»å…¥ï¼‰
GET    /api/members/{id}/profile   ç²å–æœƒå“¡è³‡æ–™ï¼ˆå«é ­åƒï¼‰
GET    /uploads/avatars/{filename} è¨ªå•é ­åƒåœ–ç‰‡
```

### å‰ç«¯ URL çµ„åˆ
```javascript
const API_BASE = 'https://10.2.0.2:8080';
const avatarUrl = data.profile.avatarUrl; // "/uploads/avatars/2-xxx.jpg"
const fullUrl = avatarUrl ? `${API_BASE}${avatarUrl}` : null;
```

### æª”æ¡ˆé™åˆ¶
- æ ¼å¼ï¼šJPG, PNG, WEBP
- å¤§å°ï¼šæœ€å¤§ 5MB
- æ¬„ä½åç¨±ï¼š`avatar`

---

**æº–å‚™å¥½æ•´åˆé ­åƒåŠŸèƒ½äº†å—ï¼Ÿ** ğŸš€

