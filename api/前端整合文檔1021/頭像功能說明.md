# 頭像功能整合說明

**更新日期**: 2025-10-21  
**功能**: 用戶頭像上傳與顯示

---

## 📋 功能概述

用戶可以上傳自己的頭像圖片，其他用戶可以在會員資料中看到該頭像。

### 支援的格式
- JPG / JPEG
- PNG
- WEBP

### 檔案限制
- 最大檔案大小：5MB
- 儲存位置：Docker volume (`uploads_data`)

---

## 🚀 API 使用

### 1. 上傳頭像

**端點**: `POST /api/me/avatar`  
**需要認證**: 是（需要登入）  
**Content-Type**: `multipart/form-data`

#### 請求範例

```javascript
// 使用 FormData 上傳
const formData = new FormData();
formData.append('avatar', fileInput.files[0]); // 'avatar' 是欄位名稱

const response = await fetch('https://10.2.0.2:8080/api/me/avatar', {
  method: 'POST',
  credentials: 'include', // 重要！包含 cookie
  body: formData,
  // 注意：不要設置 Content-Type，讓瀏覽器自動設置
});

const data = await response.json();
```

#### 成功響應 (200)

```json
{
  "success": true,
  "url": "/uploads/avatars/2-1761063369513.jpg",
  "updatedAt": "2025-10-21T16:16:09.516Z"
}
```

#### 錯誤響應

**未登入 (401)**:
```json
{
  "success": false,
  "message": "缺少認證資訊"
}
```

**未上傳檔案 (400)**:
```json
{
  "success": false,
  "message": "未上傳檔案"
}
```

**檔案過大 (413)**:
```json
{
  "success": false,
  "message": "檔案過大，最大允許 5MB",
  "code": "FILE_TOO_LARGE"
}
```

**不支援的檔案類型 (415)**:
```json
{
  "success": false,
  "message": "不支援的檔案類型，只允許 JPG, PNG, WEBP 圖片",
  "code": "INVALID_FILE_TYPE"
}
```

---

## 🖼️ 顯示頭像

### 2. 獲取會員資料（包含頭像）

**端點**: `GET /api/members/{id}/profile`  
**需要認證**: 否（公開端點）

#### 請求範例

```javascript
const response = await fetch('https://10.2.0.2:8080/api/members/2/profile', {
  credentials: 'include',
});

const data = await response.json();
console.log(data.profile.avatarUrl);
// 輸出: "/uploads/avatars/2-1761063369513.jpg"
```

#### 響應格式

```json
{
  "success": true,
  "profile": {
    "id": 2,
    "email": "user@example.com",
    "name": "Test User",
    "avatarUrl": "/uploads/avatars/2-1761063369513.jpg",
    "emailVerified": true,
    "createdAt": "2025-10-21T10:00:00.000Z",
    "updatedAt": "2025-10-21T16:16:09.516Z",
    "level": "bronze",
    "score": 0,
    // ... 其他欄位
  },
  "relationships": {
    // ...
  }
}
```

### avatarUrl 說明

- **格式**: 相對路徑，例如 `/uploads/avatars/2-1761063369513.jpg`
- **如果用戶沒有上傳頭像**: `null`
- **前端需要組合完整 URL**: `API_BASE_URL + avatarUrl`

---

## 💻 前端整合範例

### React 範例

#### 1. 頭像上傳組件

```jsx
import { useState } from 'react';

function AvatarUpload() {
  const [uploading, setUploading] = useState(false);
  const [avatarUrl, setAvatarUrl] = useState(null);
  const API_BASE = 'https://10.2.0.2:8080';

  const handleUpload = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    // 驗證檔案大小
    if (file.size > 5 * 1024 * 1024) {
      alert('檔案過大，最大 5MB');
      return;
    }

    // 驗證檔案類型
    if (!['image/jpeg', 'image/png', 'image/webp'].includes(file.type)) {
      alert('只支援 JPG、PNG、WEBP 格式');
      return;
    }

    setUploading(true);

    try {
      const formData = new FormData();
      formData.append('avatar', file);

      const response = await fetch(`${API_BASE}/api/me/avatar`, {
        method: 'POST',
        credentials: 'include',
        body: formData,
      });

      const data = await response.json();

      if (data.success) {
        setAvatarUrl(data.url);
        alert('頭像上傳成功！');
      } else {
        alert(`上傳失敗：${data.message}`);
      }
    } catch (error) {
      console.error('上傳錯誤:', error);
      alert('上傳失敗，請稍後再試');
    } finally {
      setUploading(false);
    }
  };

  return (
    <div>
      <input
        type="file"
        accept="image/jpeg,image/png,image/webp"
        onChange={handleUpload}
        disabled={uploading}
      />
      {uploading && <p>上傳中...</p>}
      {avatarUrl && (
        <img
          src={`${API_BASE}${avatarUrl}`}
          alt="Avatar"
          style={{ width: 100, height: 100, borderRadius: '50%' }}
        />
      )}
    </div>
  );
}
```

#### 2. 顯示會員頭像組件

```jsx
function MemberAvatar({ userId }) {
  const [profile, setProfile] = useState(null);
  const API_BASE = 'https://10.2.0.2:8080';
  const DEFAULT_AVATAR = '/default-avatar.png'; // 預設頭像

  useEffect(() => {
    fetch(`${API_BASE}/api/members/${userId}/profile`, {
      credentials: 'include',
    })
      .then(res => res.json())
      .then(data => setProfile(data.profile))
      .catch(err => console.error(err));
  }, [userId]);

  if (!profile) return <div>載入中...</div>;

  const avatarSrc = profile.avatarUrl
    ? `${API_BASE}${profile.avatarUrl}`
    : DEFAULT_AVATAR;

  return (
    <div>
      <img
        src={avatarSrc}
        alt={profile.name}
        style={{ width: 50, height: 50, borderRadius: '50%' }}
        onError={(e) => {
          e.target.src = DEFAULT_AVATAR; // 載入失敗時使用預設頭像
        }}
      />
      <span>{profile.name}</span>
    </div>
  );
}
```

### Vue 範例

#### 1. 頭像上傳組件

```vue
<template>
  <div>
    <input
      type="file"
      accept="image/jpeg,image/png,image/webp"
      @change="handleUpload"
      :disabled="uploading"
    />
    <p v-if="uploading">上傳中...</p>
    <img
      v-if="avatarUrl"
      :src="`${apiBase}${avatarUrl}`"
      alt="Avatar"
      style="width: 100px; height: 100px; border-radius: 50%;"
    />
  </div>
</template>

<script>
export default {
  data() {
    return {
      apiBase: 'https://10.2.0.2:8080',
      uploading: false,
      avatarUrl: null,
    };
  },
  methods: {
    async handleUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      if (file.size > 5 * 1024 * 1024) {
        alert('檔案過大，最大 5MB');
        return;
      }

      this.uploading = true;

      try {
        const formData = new FormData();
        formData.append('avatar', file);

        const response = await fetch(`${this.apiBase}/api/me/avatar`, {
          method: 'POST',
          credentials: 'include',
          body: formData,
        });

        const data = await response.json();

        if (data.success) {
          this.avatarUrl = data.url;
          alert('頭像上傳成功！');
        } else {
          alert(`上傳失敗：${data.message}`);
        }
      } catch (error) {
        console.error('上傳錯誤:', error);
        alert('上傳失敗，請稍後再試');
      } finally {
        this.uploading = false;
      }
    },
  },
};
</script>
```

---

## 🔧 技術細節

### 檔案命名規則

上傳的檔案會自動重命名為：
```
{userId}-{timestamp}{extension}
```

範例：
- 用戶 ID: 2
- 時間戳: 1761063369513
- 副檔名: .jpg
- 結果: `2-1761063369513.jpg`

### 儲存位置

- **Docker 內部**: `/app/uploads/avatars/`
- **Docker Volume**: `uploads_data`
- **存取 URL**: `https://10.2.0.2:8080/uploads/avatars/{filename}`

### CORS 設定

後端已配置 CORS，允許：
- 前端域名：`http://localhost:3000`（開發環境）
- Credentials: 允許（可以發送 cookie）

---

## ⚠️ 注意事項

### 1. 認證要求

上傳頭像**必須登入**，請確保：
```javascript
fetch(url, {
  credentials: 'include', // 必須包含！
  // ...
});
```

### 2. Content-Type

上傳時**不要手動設置** `Content-Type`，讓瀏覽器自動設置：

```javascript
// ✅ 正確
fetch(url, {
  body: formData,
  // 不設置 headers
});

// ❌ 錯誤
fetch(url, {
  headers: {
    'Content-Type': 'multipart/form-data', // 不要這樣做！
  },
  body: formData,
});
```

### 3. 檔案大小限制

- 前端應該先驗證檔案大小（5MB）
- 後端會再次驗證並返回 413 錯誤

### 4. 預設頭像

用戶可能沒有上傳頭像（`avatarUrl` 為 `null`），前端應該：
- 顯示預設頭像
- 或顯示用戶名稱的首字母

### 5. 錯誤處理

圖片載入可能失敗，建議添加 `onError` 處理：

```jsx
<img
  src={avatarUrl}
  onError={(e) => {
    e.target.src = '/default-avatar.png';
  }}
/>
```

### 6. 舊頭像清理

- 上傳新頭像時，舊頭像**不會自動刪除**
- 資料庫會更新為新的 `avatarUrl`
- Docker volume 中會保留所有上傳的檔案

---

## 🧪 測試

### 測試上傳功能

```bash
# 使用測試腳本
cd /home/gogofire1774
./script/test-avatar-upload.sh
```

### 手動測試

```bash
# 1. 登入獲取 cookie
curl -k -X POST https://10.2.0.2:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"Test1234!"}' \
  -c cookies.txt

# 2. 上傳頭像
curl -k -X POST https://10.2.0.2:8080/api/me/avatar \
  -b cookies.txt \
  -F "avatar=@/path/to/image.jpg"

# 3. 獲取會員資料確認
curl -k https://10.2.0.2:8080/api/members/1/profile | jq '.profile.avatarUrl'

# 4. 訪問圖片
curl -k https://10.2.0.2:8080/uploads/avatars/1-1234567890.jpg -o test.jpg
```

---

## 📚 相關文檔

- **API 測試清單**: `/api文檔/API-Check.md`
- **頭像上傳實作報告**: `/api文檔/頭像上傳功能實作報告.md`
- **完整 API 文檔**: `/api文檔/前端整合文檔/完整交付清單.md`

---

## 🎯 快速參考

### API 端點
```
POST   /api/me/avatar              上傳頭像（需登入）
GET    /api/members/{id}/profile   獲取會員資料（含頭像）
GET    /uploads/avatars/{filename} 訪問頭像圖片
```

### 前端 URL 組合
```javascript
const API_BASE = 'https://10.2.0.2:8080';
const avatarUrl = data.profile.avatarUrl; // "/uploads/avatars/2-xxx.jpg"
const fullUrl = avatarUrl ? `${API_BASE}${avatarUrl}` : null;
```

### 檔案限制
- 格式：JPG, PNG, WEBP
- 大小：最大 5MB
- 欄位名稱：`avatar`

---

**準備好整合頭像功能了嗎？** 🚀

