# 用戶名稱功能整合說明

**更新日期**: 2025-10-21  
**功能**: 用戶修改自己的顯示名稱

---

## 📋 功能概述

用戶可以隨時修改自己的顯示名稱，系統會自動驗證名稱格式並更新到個人資料中。

### 名稱規則
- **長度限制**: 2-10 字元
- **內容限制**: 僅允許中文和英文字母（大小寫）
- **修改頻率**: 無限制

### 不允許的內容
- ❌ 數字（0-9）
- ❌ 特殊符號（@、#、$、&、!等）
- ❌ 空格
- ❌ 表情符號

---

## 🚀 API 使用

### 更新用戶名稱

**端點**: `PATCH /api/me/name`  
**需要認證**: 是（需要登入）  
**Content-Type**: `application/json`

#### 請求範例

```javascript
const response = await fetch('https://10.2.0.2:8080/api/me/name', {
  method: 'PATCH',
  credentials: 'include', // 重要！包含 cookie
  headers: {
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    name: '新名稱'
  }),
});

const data = await response.json();
```

#### 成功響應 (200)

```json
{
  "success": true,
  "name": "新名稱",
  "updatedAt": "2025-10-21T16:30:00.000Z"
}
```

#### 錯誤響應

**未登入 (401)**:
```json
{
  "success": false,
  "message": "未登入"
}
```

**名稱格式不正確 (422)**:
```json
{
  "success": false,
  "message": "名稱格式不正確",
  "code": "NAME_INVALID",
  "details": {
    "length": true,
    "onlyChineseEnglish": false
  },
  "errors": [
    "名稱僅允許中文和英文字母"
  ]
}
```

##### 常見驗證錯誤

**名稱過短**:
```json
{
  "errors": ["名稱長度至少需要 2 個字元"]
}
```

**名稱過長**:
```json
{
  "errors": ["名稱長度不可超過 10 個字元"]
}
```

**包含數字或特殊符號**:
```json
{
  "errors": ["名稱僅允許中文和英文字母"]
}
```

**多個錯誤同時發生**:
```json
{
  "errors": [
    "名稱長度至少需要 2 個字元",
    "名稱僅允許中文和英文字母"
  ]
}
```

---

## 💻 前端整合範例

### React 範例

#### 1. 名稱修改組件

```jsx
import { useState } from 'react';

function UpdateNameForm() {
  const [name, setName] = useState('');
  const [loading, setLoading] = useState(false);
  const [errors, setErrors] = useState([]);
  const [success, setSuccess] = useState(false);
  const API_BASE = 'https://10.2.0.2:8080';

  const validateName = (value) => {
    const errors = [];
    
    if (value.length < 2) {
      errors.push('名稱長度至少需要 2 個字元');
    }
    if (value.length > 10) {
      errors.push('名稱長度不可超過 10 個字元');
    }
    // 只允許中英文
    if (!/^[\u4e00-\u9fa5a-zA-Z]+$/.test(value)) {
      errors.push('名稱僅允許中文和英文字母');
    }
    
    return errors;
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    
    // 前端驗證
    const validationErrors = validateName(name);
    if (validationErrors.length > 0) {
      setErrors(validationErrors);
      return;
    }

    setLoading(true);
    setErrors([]);
    setSuccess(false);

    try {
      const response = await fetch(`${API_BASE}/api/me/name`, {
        method: 'PATCH',
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ name }),
      });

      const data = await response.json();

      if (data.success) {
        setSuccess(true);
        setName('');
        alert(`名稱已更新為: ${data.name}`);
        // 可以在這裡更新全域狀態或重新載入用戶資料
      } else {
        setErrors(data.errors || [data.message]);
      }
    } catch (error) {
      console.error('更新名稱錯誤:', error);
      setErrors(['網路錯誤，請稍後再試']);
    } finally {
      setLoading(false);
    }
  };

  const handleChange = (e) => {
    const value = e.target.value;
    setName(value);
    
    // 即時驗證
    if (value) {
      const validationErrors = validateName(value);
      setErrors(validationErrors);
    } else {
      setErrors([]);
    }
  };

  return (
    <form onSubmit={handleSubmit}>
      <div>
        <label htmlFor="name">新名稱</label>
        <input
          id="name"
          type="text"
          value={name}
          onChange={handleChange}
          placeholder="請輸入 2-10 個中英文字元"
          maxLength="10"
          disabled={loading}
        />
        <small>僅允許中文和英文字母，2-10 字元</small>
      </div>

      {errors.length > 0 && (
        <div className="error-messages">
          {errors.map((error, index) => (
            <p key={index} className="error">{error}</p>
          ))}
        </div>
      )}

      {success && (
        <p className="success">名稱更新成功！</p>
      )}

      <button type="submit" disabled={loading || errors.length > 0}>
        {loading ? '更新中...' : '更新名稱'}
      </button>
    </form>
  );
}

export default UpdateNameForm;
```

#### 2. 內聯名稱編輯組件

```jsx
import { useState } from 'react';

function InlineNameEditor({ currentName, onUpdate }) {
  const [isEditing, setIsEditing] = useState(false);
  const [name, setName] = useState(currentName);
  const [loading, setLoading] = useState(false);
  const API_BASE = 'https://10.2.0.2:8080';

  const handleSave = async () => {
    if (name === currentName) {
      setIsEditing(false);
      return;
    }

    // 簡單驗證
    if (name.length < 2 || name.length > 10) {
      alert('名稱長度必須為 2-10 字元');
      return;
    }

    setLoading(true);

    try {
      const response = await fetch(`${API_BASE}/api/me/name`, {
        method: 'PATCH',
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ name }),
      });

      const data = await response.json();

      if (data.success) {
        setIsEditing(false);
        if (onUpdate) {
          onUpdate(data.name);
        }
      } else {
        alert(data.errors ? data.errors.join('\n') : data.message);
        setName(currentName); // 恢復原名稱
      }
    } catch (error) {
      console.error('更新名稱錯誤:', error);
      alert('網路錯誤，請稍後再試');
      setName(currentName);
    } finally {
      setLoading(false);
    }
  };

  const handleCancel = () => {
    setName(currentName);
    setIsEditing(false);
  };

  if (isEditing) {
    return (
      <div className="inline-editor">
        <input
          type="text"
          value={name}
          onChange={(e) => setName(e.target.value)}
          disabled={loading}
          maxLength="10"
          autoFocus
        />
        <button onClick={handleSave} disabled={loading}>
          {loading ? '儲存中...' : '✓'}
        </button>
        <button onClick={handleCancel} disabled={loading}>
          ✗
        </button>
      </div>
    );
  }

  return (
    <div className="name-display">
      <span>{currentName}</span>
      <button onClick={() => setIsEditing(true)}>✎ 編輯</button>
    </div>
  );
}

export default InlineNameEditor;
```

### Vue 範例

#### 名稱修改組件

```vue
<template>
  <form @submit.prevent="handleSubmit">
    <div>
      <label for="name">新名稱</label>
      <input
        id="name"
        v-model="name"
        type="text"
        placeholder="請輸入 2-10 個中英文字元"
        maxlength="10"
        :disabled="loading"
        @input="validateInput"
      />
      <small>僅允許中文和英文字母，2-10 字元</small>
    </div>

    <div v-if="errors.length > 0" class="error-messages">
      <p v-for="(error, index) in errors" :key="index" class="error">
        {{ error }}
      </p>
    </div>

    <p v-if="success" class="success">名稱更新成功！</p>

    <button type="submit" :disabled="loading || errors.length > 0">
      {{ loading ? '更新中...' : '更新名稱' }}
    </button>
  </form>
</template>

<script>
export default {
  data() {
    return {
      apiBase: 'https://10.2.0.2:8080',
      name: '',
      loading: false,
      errors: [],
      success: false,
    };
  },
  methods: {
    validateName(value) {
      const errors = [];
      
      if (value.length < 2) {
        errors.push('名稱長度至少需要 2 個字元');
      }
      if (value.length > 10) {
        errors.push('名稱長度不可超過 10 個字元');
      }
      // 只允許中英文
      if (!/^[\u4e00-\u9fa5a-zA-Z]+$/.test(value)) {
        errors.push('名稱僅允許中文和英文字母');
      }
      
      return errors;
    },
    validateInput() {
      if (this.name) {
        this.errors = this.validateName(this.name);
      } else {
        this.errors = [];
      }
    },
    async handleSubmit() {
      // 前端驗證
      const validationErrors = this.validateName(this.name);
      if (validationErrors.length > 0) {
        this.errors = validationErrors;
        return;
      }

      this.loading = true;
      this.errors = [];
      this.success = false;

      try {
        const response = await fetch(`${this.apiBase}/api/me/name`, {
          method: 'PATCH',
          credentials: 'include',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ name: this.name }),
        });

        const data = await response.json();

        if (data.success) {
          this.success = true;
          this.name = '';
          alert(`名稱已更新為: ${data.name}`);
          // 可以在這裡更新全域狀態或重新載入用戶資料
          this.$emit('name-updated', data.name);
        } else {
          this.errors = data.errors || [data.message];
        }
      } catch (error) {
        console.error('更新名稱錯誤:', error);
        this.errors = ['網路錯誤，請稍後再試'];
      } finally {
        this.loading = false;
      }
    },
  },
};
</script>

<style scoped>
.error {
  color: red;
  font-size: 0.9em;
}
.success {
  color: green;
  font-size: 0.9em;
}
</style>
```

---

## 🔧 前端驗證工具

### JavaScript 驗證函數

```javascript
/**
 * 驗證用戶名稱
 * @param {string} name - 要驗證的名稱
 * @returns {Object} 驗證結果 { valid: boolean, errors: string[] }
 */
function validateName(name) {
  const errors = [];
  
  // 檢查是否為空
  if (!name || typeof name !== 'string') {
    errors.push('名稱不可為空');
    return { valid: false, errors };
  }

  // 去除首尾空白
  const trimmedName = name.trim();

  // 檢查長度（2-10 字元）
  if (trimmedName.length < 2) {
    errors.push('名稱長度至少需要 2 個字元');
  } else if (trimmedName.length > 10) {
    errors.push('名稱長度不可超過 10 個字元');
  }

  // 檢查是否僅包含中英文
  // 中文範圍: \u4e00-\u9fa5 (CJK Unified Ideographs)
  // 英文範圍: a-zA-Z
  const onlyChineseEnglishRegex = /^[\u4e00-\u9fa5a-zA-Z]+$/;
  
  if (!onlyChineseEnglishRegex.test(trimmedName)) {
    errors.push('名稱僅允許中文和英文字母');
  }

  return {
    valid: errors.length === 0,
    errors,
  };
}

// 使用範例
const result = validateName('張Peter');
if (result.valid) {
  console.log('名稱有效');
} else {
  console.log('驗證錯誤:', result.errors);
}
```

### TypeScript 驗證函數

```typescript
interface NameValidationResult {
  valid: boolean;
  errors: string[];
}

/**
 * 驗證用戶名稱
 * @param name 要驗證的名稱
 * @returns 驗證結果
 */
function validateName(name: string): NameValidationResult {
  const errors: string[] = [];
  
  // 檢查是否為空
  if (!name || typeof name !== 'string') {
    errors.push('名稱不可為空');
    return { valid: false, errors };
  }

  // 去除首尾空白
  const trimmedName = name.trim();

  // 檢查長度（2-10 字元）
  if (trimmedName.length < 2) {
    errors.push('名稱長度至少需要 2 個字元');
  } else if (trimmedName.length > 10) {
    errors.push('名稱長度不可超過 10 個字元');
  }

  // 檢查是否僅包含中英文
  const onlyChineseEnglishRegex = /^[\u4e00-\u9fa5a-zA-Z]+$/;
  
  if (!onlyChineseEnglishRegex.test(trimmedName)) {
    errors.push('名稱僅允許中文和英文字母');
  }

  return {
    valid: errors.length === 0,
    errors,
  };
}
```

---

## 📊 名稱更新流程

```
用戶輸入新名稱
    ↓
前端即時驗證（可選）
    ↓
用戶提交表單
    ↓
前端發送 PATCH /api/me/name
    ↓
後端驗證名稱格式
    ↓
    ├─ 格式正確 → 更新資料庫 → 返回 200 + 新名稱
    └─ 格式錯誤 → 返回 422 + 錯誤詳情
    ↓
前端處理響應
    ├─ 成功 → 更新 UI + 顯示成功訊息
    └─ 失敗 → 顯示錯誤訊息
```

---

## ⚠️ 注意事項

### 1. 認證要求

更新名稱**必須登入**，請確保：
```javascript
fetch(url, {
  credentials: 'include', // 必須包含！
  // ...
});
```

### 2. 名稱規則

- **長度**: 2-10 字元（UTF-8 字元，中文算 1 個字元）
- **內容**: 僅允許中文（U+4E00 至 U+9FA5）和英文字母（a-z, A-Z）
- **不允許**: 數字、空格、特殊符號、表情符號

### 3. 修改頻率

- 無限制，可隨時修改
- 無冷卻時間
- 無歷史記錄（直接覆蓋）

### 4. 前端驗證

建議在前端實作即時驗證：
- 提升用戶體驗
- 減少不必要的 API 請求
- 提供即時反饋

### 5. 錯誤處理

處理所有可能的錯誤情況：
```javascript
try {
  const response = await fetch(url, options);
  const data = await response.json();
  
  if (response.ok && data.success) {
    // 成功處理
  } else {
    // 顯示錯誤訊息
    console.error(data.errors || data.message);
  }
} catch (error) {
  // 網路錯誤處理
  console.error('網路錯誤:', error);
}
```

### 6. UI/UX 建議

- 提供即時驗證反饋（輸入時顯示錯誤）
- 顯示字元計數（x/10）
- 禁用按鈕直到驗證通過
- 成功後顯示確認訊息
- 考慮使用內聯編輯模式

### 7. 名稱顯示

更新後，名稱會立即在以下地方生效：
- `GET /api/auth/session` - 返回當前用戶資訊
- `GET /api/members/{id}/profile` - 返回完整會員資料
- 所有需要顯示用戶名的地方

---

## 🧪 測試

### 測試腳本

完整的測試腳本位於：`/home/gogofire1774/script/test-update-name.sh`

```bash
# 執行測試
cd /home/gogofire1774
./script/test-update-name.sh
```

### 手動測試

```bash
# 1. 登入獲取 cookie
curl -k -X POST https://10.2.0.2:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"Test1234!"}' \
  -c cookies.txt

# 2. 更新名稱（成功案例）
curl -k -X PATCH https://10.2.0.2:8080/api/me/name \
  -H "Content-Type: application/json" \
  -d '{"name":"新名稱"}' \
  -b cookies.txt

# 3. 更新名稱（錯誤案例 - 包含數字）
curl -k -X PATCH https://10.2.0.2:8080/api/me/name \
  -H "Content-Type: application/json" \
  -d '{"name":"測試123"}' \
  -b cookies.txt

# 4. 驗證名稱已更新
curl -k https://10.2.0.2:8080/api/auth/session -b cookies.txt | jq '.user.name'
```

---

## 📚 相關文檔

- **API 測試清單**: `/api文檔/API-Check.md`
- **OpenAPI 規格**: `/api文檔/openapi.yaml`
- **完整 API 文檔**: `/api文檔/前端整合文檔/完整交付清單.md`

---

## 🎯 快速參考

### API 端點
```
PATCH  /api/me/name    更新用戶名稱（需登入）
```

### 請求格式
```json
{
  "name": "新名稱"
}
```

### 成功響應
```json
{
  "success": true,
  "name": "新名稱",
  "updatedAt": "2025-10-21T16:30:00.000Z"
}
```

### 驗證規則
- 長度：2-10 字元
- 內容：僅中文和英文字母
- 頻率：無限制

---

**準備好整合名稱修改功能了嗎？** 🚀

