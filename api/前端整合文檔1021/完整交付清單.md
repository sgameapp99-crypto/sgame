# SGame API å‰ç«¯äº¤ä»˜å®Œæ•´æ¸…å–®

**äº¤ä»˜æ—¥æœŸ**: 2025-10-21  
**APIç‰ˆæœ¬**: v1.0.2  
**ç‹€æ…‹**: âœ… ç”Ÿç”¢å°±ç·’

---

## ğŸ“¦ äº¤ä»˜å…§å®¹

### 1. APIç«¯é»ï¼ˆå·²æ¸¬è©¦é€šéï¼‰

#### èªè­‰APIï¼ˆ14å€‹ç«¯é»ï¼‰âœ…
- âœ… POST /auth/register - è¨»å†Š
- âœ… POST /auth/login - ç™»å…¥
- âœ… GET /auth/session - Sessionç‹€æ…‹
- âœ… POST /auth/logout - ç™»å‡º
- âœ… POST /auth/send-verification - ç™¼é€é©—è­‰ç¢¼
- âœ… POST /auth/verify-email - é©—è­‰éƒµç®±
- âœ… GET /auth/verification-status - é©—è­‰ç‹€æ…‹
- âœ… POST /auth/forgot-password - å¿˜è¨˜å¯†ç¢¼
- âœ… POST /auth/verify-reset-token - é©—è­‰é‡è¨­token
- âœ… POST /auth/reset-password - é‡è¨­å¯†ç¢¼
- âœ… POST /auth/change-password - ä¿®æ”¹å¯†ç¢¼
- âœ… GET /auth/password-expiry-status - å¯†ç¢¼éæœŸç‹€æ…‹
- âœ… GET /auth/oauth/google/start - Google OAuthå•Ÿå‹•
- âœ… GET /auth/oauth/google/callback - Google OAuthå›èª¿

#### æœƒå“¡APIï¼ˆ6å€‹ç«¯é»ï¼‰âœ…
- âœ… GET /members/{id}/profile - æœƒå“¡è³‡æ–™
- âœ… POST /members/{id}/follow - è¿½è¹¤æœƒå“¡
- âœ… DELETE /members/{id}/follow - å–æ¶ˆè¿½è¹¤
- âœ… GET /levels - ç­‰ç´šåˆ—è¡¨
- âœ… GET /levels/stats - ç­‰ç´šçµ±è¨ˆ
- âœ… POST /me/avatar - ä¸Šå‚³é ­åƒ

#### æ ¸å¿ƒAPIï¼ˆ1å€‹ç«¯é»ï¼‰âœ…
- âœ… GET /health - å¥åº·æª¢æŸ¥

**ç¸½è¨ˆ**: 21å€‹APIç«¯é»ï¼Œå…¨éƒ¨æ¸¬è©¦é€šéï¼

### 2. æ–‡æª”

#### æ ¸å¿ƒæ–‡æª”
- âœ… `README.md` - æ–‡æª”å°èˆª
- âœ… `01-APIç¸½è¦½.md` - APIåŸºç¤è³‡è¨Š
- âœ… `API-Check.md` - å®Œæ•´ç«¯é»æ¸…å–®
- âœ… `openapi.yaml` - OpenAPIè¦æ ¼

#### è©³ç´°æ–‡æª”ï¼ˆå¯åƒè€ƒï¼‰
- ğŸ“„ `æœ€çµ‚æ¸¬è©¦å ±å‘Š.md` - å®Œæ•´æ¸¬è©¦çµæœ
- ğŸ“„ `å¾Œç«¯æ¸¬è©¦å ±å‘Š-2025-10-21.md` - è©³ç´°æ¸¬è©¦æ•¸æ“š
- ğŸ“„ `é ­åƒä¸Šå‚³åŠŸèƒ½å¯¦ä½œå ±å‘Š.md` - é ­åƒä¸Šå‚³è©³æƒ…
- ğŸ“„ `é ­åƒä¸Šå‚³-å¿«é€Ÿåƒè€ƒ.md` - é ­åƒä¸Šå‚³å¿«é€ŸæŒ‡å—
- ğŸ“„ `EmailåŠŸèƒ½èªªæ˜.md` - EmailåŠŸèƒ½é…ç½®
- ğŸ“„ `ç™»å…¥åŠŸèƒ½ä¿®å¾©å ±å‘Š.md` - ç™»å…¥å•é¡Œä¿®å¾©è¨˜éŒ„

#### æ¸¬è©¦è…³æœ¬
- ğŸ“œ `test-api-full.sh` - å®Œæ•´APIæ¸¬è©¦
- ğŸ“œ `test-email-verification-complete.sh` - éƒµç®±é©—è­‰æ¸¬è©¦
- ğŸ“œ `test-password-reset-complete.sh` - å¯†ç¢¼é‡è¨­æ¸¬è©¦
- ğŸ“œ `test-member-follow-complete.sh` - æœƒå“¡è¿½è¹¤æ¸¬è©¦
- ğŸ“œ `test-avatar-upload.sh` - é ­åƒä¸Šå‚³æ¸¬è©¦
- ğŸ“œ `test-login-function.sh` - ç™»å…¥åŠŸèƒ½æ¸¬è©¦

### 3. æ¸¬è©¦çµæœ

#### æ¸¬è©¦çµ±è¨ˆ
- âœ… æ¸¬è©¦é€šéç‡: **100%** (21/21)
- âœ… APIç©©å®šæ€§: å„ªç§€ï¼ˆç„¡å´©æ½°ï¼‰
- âœ… å¹³å‡éŸ¿æ‡‰æ™‚é–“: <100ms
- âœ… EmailåŠŸèƒ½: å·²é©—è­‰å·¥ä½œ

#### æ¸¬è©¦è­‰æ“š
- æ‰€æœ‰ç«¯é»éƒ½æœ‰å°æ‡‰çš„curlæ¸¬è©¦è…³æœ¬
- æ¸¬è©¦æ—¥èªŒè¨˜éŒ„åœ¨å„æ¸¬è©¦å ±å‘Šä¸­
- å¯¦éš›éƒµä»¶ç™¼é€æ¸¬è©¦é€šé

---

## ğŸš€ é–‹å§‹æ•´åˆ

### æ­¥é©Ÿ1: ç’°å¢ƒé…ç½®

#### å‰ç«¯é…ç½®
```env
# .env.development
VITE_API_BASE_URL=https://10.2.0.2:8080/api
VITE_FRONTEND_URL=http://localhost:3000
```

#### é‡è¦æé†’
1. æ‰€æœ‰è«‹æ±‚å¿…é ˆè¨­ç½® `credentials: 'include'`
2. ä½¿ç”¨HTTPSï¼ˆé–‹ç™¼ç’°å¢ƒéœ€è™•ç†è‡ªç°½è­‰æ›¸ï¼‰
3. CORSå·²é…ç½®å…è¨± `10.1.0.0/24` ç¶²æ®µ

### æ­¥é©Ÿ2: å‰µå»ºAPI Client

```javascript
// src/api/client.js
import axios from 'axios';

const api = axios.create({
  baseURL: import.meta.env.VITE_API_BASE_URL,
  withCredentials: true,  // é‡è¦ï¼
  headers: {
    'Content-Type': 'application/json'
  }
});

// éŸ¿æ‡‰æ””æˆªå™¨
api.interceptors.response.use(
  response => response,
  error => {
    if (error.response?.status === 401) {
      // è·³è½‰ç™»å…¥é 
      window.location.href = '/login';
    }
    return Promise.reject(error);
  }
);

export default api;
```

### æ­¥é©Ÿ3: å¯¦ä½œèªè­‰

```javascript
// src/api/auth.js
import api from './client';

export const authAPI = {
  // ç™»å…¥
  login: (email, password) => 
    api.post('/auth/login', { email, password }),
  
  // è¨»å†Š
  register: (email, password, name) =>
    api.post('/auth/register', { email, password, name }),
  
  // æª¢æŸ¥Session
  getSession: () => 
    api.get('/auth/session'),
  
  // ç™»å‡º
  logout: () => 
    api.post('/auth/logout')
};
```

### æ­¥é©Ÿ4: æ¸¬è©¦é€£æ¥

```javascript
// æ¸¬è©¦å¥åº·æª¢æŸ¥
fetch('https://10.2.0.2:8080/health')
  .then(res => res.json())
  .then(data => {
    if (data.status === 'healthy') {
      console.log('âœ… APIé€£æ¥æ­£å¸¸');
    }
  });
```

---

## ğŸ“š å®Œæ•´APIæ–‡æª”

### èªè­‰API

#### è¨»å†Š
```http
POST /api/auth/register
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "Pass1234!",
  "name": "User Name"
}

Response 201:
{
  "success": true,
  "message": "è¨»å†ŠæˆåŠŸï¼Œè«‹æª¢æŸ¥éƒµç®±ä¸¦å®Œæˆé©—è­‰",
  "redirectUrl": "/login",
  "needsVerification": true
}
```

#### ç™»å…¥
```http
POST /api/auth/login
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "Pass1234!"
}

Response 200:
{
  "success": true,
  "message": "ç™»å…¥æˆåŠŸ",
  "token": "eyJhbGc...",
  "passwordExpiry": {
    "isExpired": false,
    "isWarning": false,
    "daysUntilExpiry": 180,
    "message": "æ‚¨çš„å¯†ç¢¼ç‹€æ…‹æ­£å¸¸ï¼Œè·é›¢éæœŸé‚„æœ‰ 180 å¤©"
  }
}

Set-Cookie: sgame_session=session:123; HttpOnly; Max-Age=604800
```

#### Sessionç‹€æ…‹
```http
GET /api/auth/session
Cookie: sgame_session=session:123

Response 200:
{
  "success": true,
  "loggedIn": true,
  "userId": 123,
  "email": "user@example.com",
  "name": "User Name",
  "emailVerified": true,
  "passwordExpiry": { ... }
}
```

#### ç™»å‡º
```http
POST /api/auth/logout
Cookie: sgame_session=session:123

Response 204: (ç„¡å…§å®¹)
```

#### å¿˜è¨˜å¯†ç¢¼
```http
POST /api/auth/forgot-password
Content-Type: application/json

{
  "email": "user@example.com"
}

Response 200:
{
  "success": true,
  "message": "å¯†ç¢¼é‡è¨­éƒµä»¶å·²ç™¼é€è‡³æ‚¨çš„éƒµç®±ï¼Œè«‹åœ¨ 24 å°æ™‚å…§å®Œæˆé‡è¨­"
}
```

#### é‡è¨­å¯†ç¢¼
```http
POST /api/auth/reset-password
Content-Type: application/json

{
  "token": "reset-token-from-email",
  "newPassword": "NewPass1234!"
}

Response 200:
{
  "success": true,
  "message": "å¯†ç¢¼é‡è¨­æˆåŠŸï¼Œè«‹ä½¿ç”¨æ–°å¯†ç¢¼ç™»å…¥"
}
```

### æœƒå“¡API

#### ç²å–æœƒå“¡è³‡æ–™
```http
GET /api/members/123/profile
Cookie: sgame_session=session:456

Response 200:
{
  "success": true,
  "profile": {
    "id": 123,
    "email": "user@example.com",
    "name": "User Name",
    "avatarUrl": "/uploads/avatars/123-1234567890.jpg",
    "emailVerified": true,
    "level": "bronze",
    "score": 500,
    "followersCount": 10,
    "followingCount": 5,
    "levelInfo": {
      "code": "bronze",
      "name": "é’éŠ…",
      "color": "#CD7F32",
      "icon": "ğŸ¥‰",
      "minScore": 0,
      "maxScore": 999
    }
  },
  "relationships": {
    "isSelf": false,
    "isFollowing": false,
    "isMutual": false
  }
}
```

#### è¿½è¹¤æœƒå“¡
```http
POST /api/members/123/follow
Cookie: sgame_session=session:456

Response 204: (ç„¡å…§å®¹)
```

#### ä¸Šå‚³é ­åƒ
```http
POST /api/me/avatar
Content-Type: multipart/form-data
Cookie: sgame_session=session:123

------WebKitFormBoundary
Content-Disposition: form-data; name="avatar"; filename="avatar.jpg"
Content-Type: image/jpeg

<binary data>
------WebKitFormBoundary--

Response 200:
{
  "success": true,
  "url": "/uploads/avatars/123-1234567890.jpg",
  "updatedAt": "2025-10-21T08:00:00.000Z"
}
```

---

## ğŸ” å¯†ç¢¼è¦å‰‡

- **é•·åº¦**: 8-12å­—å…ƒ
- **å¿…é ˆåŒ…å«**: å¤§å¯«å­—æ¯ã€å°å¯«å­—æ¯ã€æ•¸å­—ã€ç‰¹æ®Šç¬¦è™Ÿ
- **ä¸å¯åŒ…å«**: ç©ºç™½
- **éæœŸ**: 180å¤©ï¼ˆ7å¤©å‰é–‹å§‹è­¦å‘Šï¼‰

---

## âš ï¸ é‡è¦æé†’

### FRONTEND_URLé…ç½®

**ç•¶å‰å€¼**: `https://34.80.46.175:5175`

éƒµä»¶ä¸­çš„é‡è¨­é€£çµæœƒä½¿ç”¨é€™å€‹URLï¼Œè«‹ç¢ºä¿ï¼š
1. å‰ç«¯å¯¦ä½œ `/reset-password` é é¢
2. URLå¯ä»¥å¾å¤–ç¶²è¨ªå•
3. ç”Ÿç”¢ç’°å¢ƒæ›´æ–°ç‚ºå¯¦éš›åŸŸå

### HTTPSè‡ªç°½è­‰æ›¸

é–‹ç™¼ç’°å¢ƒä½¿ç”¨è‡ªç°½è­‰æ›¸ï¼Œå‰ç«¯éœ€è¦ï¼š
1. ç€è¦½å™¨ä¿¡ä»»è­‰æ›¸ï¼Œæˆ–
2. ä½¿ç”¨ä»£ç†ä¼ºæœå™¨ï¼Œæˆ–
3. é–‹ç™¼æ™‚å¿½ç•¥SSLéŒ¯èª¤ï¼ˆä¸æ¨è–¦ç”Ÿç”¢ç’°å¢ƒï¼‰

### Cookieè·¨åŸŸ

æ‰€æœ‰è«‹æ±‚å¿…é ˆè¨­ç½® `credentials: 'include'` æˆ– `withCredentials: true`

---

## ğŸ“ æŠ€è¡“æ”¯æ´

### æŸ¥é–±è³‡æº
1. **æ¸¬è©¦å ±å‘Š**: `apiæ–‡æª”/æœ€çµ‚æ¸¬è©¦å ±å‘Š.md`
2. **OpenAPIè¦æ ¼**: `apiæ–‡æª”/openapi.yaml`
3. **æ¸¬è©¦è…³æœ¬**: `test-*.sh` æ–‡ä»¶

### å¸¸è¦‹å•é¡Œ
- CORSå•é¡Œ: æª¢æŸ¥ `credentials: 'include'`
- 401éŒ¯èª¤: æœªç™»å…¥æˆ–SessionéæœŸ
- Cookieæœªè¨­ç½®: æª¢æŸ¥ `withCredentials`é…ç½®

---

## âœ… æ¸¬è©¦å»ºè­°

1. å…ˆæ¸¬è©¦ `/health` ç«¯é»ç¢ºèªé€£æ¥
2. æ¸¬è©¦è¨»å†Šå’Œç™»å…¥æµç¨‹
3. æ¸¬è©¦Sessionç‹€æ…‹æŸ¥è©¢
4. æ¸¬è©¦éœ€è¦èªè­‰çš„ç«¯é»
5. æ¸¬è©¦éŒ¯èª¤è™•ç†

---

## ğŸ‰ æº–å‚™å°±ç·’

æ‰€æœ‰APIç«¯é»å·²æ¸¬è©¦é€šéï¼Œå¯ä»¥é–‹å§‹å‰ç«¯æ•´åˆï¼

**ç¥é–‹ç™¼é †åˆ©ï¼** ğŸš€

